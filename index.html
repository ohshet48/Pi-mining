<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00d4ff">
    <title>Arc Astra</title>
    
    <!-- Google AdMob SDK -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4534323466794129"
     crossorigin="anonymous"></script>
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        input, button {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
            min-height: 100vh;
            color: white;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
            touch-action: pan-y;
        }
        
        html {
            font-size: 16px;
        }
        
        /* Simplified Tech Background - Single Layer */
        .tech-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at 50% 30%, rgba(0, 200, 220, 0.12) 0%, transparent 60%);
        }
        
        .grid-lines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.4;
        }
        
        .particle {
            display: none; /* All particles disabled */
        }
        
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 20px 20px 60px 20px; 
            position: relative; 
            z-index: 10;
            min-height: 100vh;
        }
        
        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a1929;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s ease;
            overflow: hidden;
        }
        
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            position: relative;
            z-index: 1;
        }
        
        /* Animasyonlu ışık çizgileri */
        .light-beam {
            position: absolute;
            bottom: 0;
            width: 2px;
            height: 0;
            animation: beamRise 2s ease-out infinite;
            z-index: 2;
        }
        
        @keyframes beamRise {
            0% {
                height: 0;
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            100% {
                height: 70%;
                opacity: 0;
            }
        }
        
        .light-beam:nth-child(1) { 
            left: 15%; 
            animation-delay: 0s; 
            background: linear-gradient(to top, rgba(0, 255, 255, 0.8), rgba(0, 255, 255, 0)); /* Neon Mavi */
        }
        .light-beam:nth-child(2) { 
            left: 25%; 
            animation-delay: 0.3s; 
            background: linear-gradient(to top, rgba(138, 43, 226, 0.8), rgba(138, 43, 226, 0)); /* Mor */
        }
        .light-beam:nth-child(3) { 
            left: 35%; 
            animation-delay: 0.6s; 
            background: linear-gradient(to top, rgba(0, 150, 255, 0.8), rgba(0, 150, 255, 0)); /* Mavi */
        }
        .light-beam:nth-child(4) { 
            left: 45%; 
            animation-delay: 0.9s; 
            background: linear-gradient(to top, rgba(191, 0, 255, 0.8), rgba(191, 0, 255, 0)); /* Neon Mor */
        }
        .light-beam:nth-child(5) { 
            left: 55%; 
            animation-delay: 1.2s; 
            background: linear-gradient(to top, rgba(0, 255, 255, 0.8), rgba(0, 255, 255, 0)); /* Neon Mavi */
        }
        .light-beam:nth-child(6) { 
            left: 65%; 
            animation-delay: 0.4s; 
            background: linear-gradient(to top, rgba(138, 43, 226, 0.8), rgba(138, 43, 226, 0)); /* Mor */
        }
        .light-beam:nth-child(7) { 
            left: 75%; 
            animation-delay: 0.7s; 
            background: linear-gradient(to top, rgba(0, 150, 255, 0.8), rgba(0, 150, 255, 0)); /* Mavi */
        }
        .light-beam:nth-child(8) { 
            left: 85%; 
            animation-delay: 1s; 
            background: linear-gradient(to top, rgba(191, 0, 255, 0.8), rgba(191, 0, 255, 0)); /* Neon Mor */
        }
        
        /* Auth Screen */
        .auth-screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-screen.show {
            display: flex;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-title {
            font-size: 48px;
            font-weight: 900;
            text-align: center;
            color: transparent;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            padding: 12px 24px;
            border: 2px solid rgba(14, 165, 233, 0.3);
            border-radius: 12px;
            display: inline-block;
            position: relative;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.15);
        }
        
        .auth-title-wrapper {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .auth-subtitle {
            text-align: center;
            color: #c4b5fd;
            font-size: 15px;
            margin-bottom: 40px;
        }
        
        .auth-card {
            background: rgba(10, 20, 40, 0.85);
            border-radius: 24px;
            padding: 30px;
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) border-box;
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.2),
                0 10px 40px rgba(0, 0, 0, 0.4);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: #c4b5fd;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(0, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            outline: none;
        }
        
        /* Date Input Styling */
        input[type="date"].form-input {
            color-scheme: dark;
            position: relative;
        }
        
        input[type="date"].form-input::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2300ffff" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>') center/contain no-repeat;
            cursor: pointer;
            opacity: 0.8;
            width: 20px;
            height: 20px;
        }
        
        input[type="date"].form-input::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        input[type="date"].form-input::-webkit-datetime-edit {
            color: white;
        }
        
        input[type="date"].form-input::-webkit-datetime-edit-fields-wrapper {
            color: white;
        }
        
        input[type="date"].form-input::-webkit-datetime-edit-text {
            color: #00ffff;
            padding: 0 2px;
        }
        
        input[type="date"].form-input::-webkit-datetime-edit-month-field,
        input[type="date"].form-input::-webkit-datetime-edit-day-field,
        input[type="date"].form-input::-webkit-datetime-edit-year-field {
            color: white;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
        }
        
        input[type="date"].form-input::-webkit-datetime-edit-month-field:focus,
        input[type="date"].form-input::-webkit-datetime-edit-day-field:focus,
        input[type="date"].form-input::-webkit-datetime-edit-year-field:focus {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
        }
        
        .form-input:-webkit-autofill,
        .form-input:-webkit-autofill:hover,
        .form-input:-webkit-autofill:focus,
        .form-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px rgba(0, 0, 0, 0.4) inset !important;
            -webkit-text-fill-color: white !important;
            background-color: rgba(0, 0, 0, 0.4) !important;
        }
        
        .form-input:disabled {
            background: rgba(0, 0, 0, 0.2) !important;
            border-color: rgba(0, 255, 255, 0.1) !important;
            color: #999 !important;
            cursor: not-allowed;
            -webkit-text-fill-color: #999 !important;
            opacity: 1 !important;
        }
        
        .form-input:disabled:-webkit-autofill,
        .form-input:disabled:-webkit-autofill:hover,
        .form-input:disabled:-webkit-autofill:focus,
        .form-input:disabled:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px rgba(0, 0, 0, 0.2) inset !important;
            -webkit-text-fill-color: #999 !important;
            background-color: rgba(0, 0, 0, 0.2) !important;
        }
        
        .form-input:disabled:hover,
        .form-input:disabled:focus {
            background: rgba(0, 0, 0, 0.2) !important;
            border-color: rgba(0, 255, 255, 0.1) !important;
            color: #999 !important;
            box-shadow: none !important;
            -webkit-text-fill-color: #999 !important;
        }
        
        .form-input:disabled::-webkit-datetime-edit,
        .form-input:disabled::-webkit-datetime-edit-fields-wrapper,
        .form-input:disabled::-webkit-datetime-edit-text,
        .form-input:disabled::-webkit-datetime-edit-month-field,
        .form-input:disabled::-webkit-datetime-edit-day-field,
        .form-input:disabled::-webkit-datetime-edit-year-field {
            color: #999 !important;
            -webkit-text-fill-color: #999 !important;
        }
        
        .form-input:focus {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        .country-dropdown {
            position: relative;
        }
        
        .country-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: rgba(10, 20, 40, 0.98);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            margin-top: 8px;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .country-dropdown-list.show {
            display: block;
        }
        
        .country-option {
            padding: 12px 16px;
            color: white;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }
        
        .country-option:hover {
            background: rgba(0, 255, 255, 0.1);
            padding-left: 20px;
        }
        
        .country-option:last-child {
            border-bottom: none;
        }
        
        .country-dropdown-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .country-dropdown-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .country-dropdown-list::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .country-dropdown-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.5);
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ffff, #0096ff);
            color: #000;
            margin-bottom: 12px;
        }
        
        .btn-google {
            background: white;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .divider {
            text-align: center;
            color: #c4b5fd;
            font-size: 14px;
            margin: 20px 0;
            position: relative;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: rgba(0, 255, 255, 0.2);
        }
        
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        
        .switch-auth {
            text-align: center;
            color: #c4b5fd;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .switch-auth span {
            color: #00ffff;
            cursor: pointer;
            font-weight: 700;
        }
        
        .error-msg {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            color: #fca5a5;
            font-size: 14px;
            text-align: center;
        }
        
        .success-msg {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            color: #86efac;
            font-size: 14px;
            text-align: center;
        }
        
        .info-msg {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            color: #60a5fa;
            font-size: 14px;
            text-align: center;
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(10, 20, 40, 0.95);
            border: 1px solid rgba(6, 182, 212, 0.6);
            border-radius: 8px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast-notification.error {
            background: rgba(10, 20, 40, 0.95);
            border-color: rgba(239, 68, 68, 0.6);
        }
        
        .toast-notification.exit {
            bottom: 20px;
            top: auto;
            transform: translateX(-50%) translateY(100px);
            background: rgba(10, 20, 40, 0.95);
            border-color: rgba(251, 191, 36, 0.6);
        }
        
        .toast-notification.exit.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Header - Minimal */
        .header { text-align: center; padding: 15px 0 10px 0; position: relative; }
        .welcome-card {
            background: rgba(10, 20, 40, 0.85);
            border-radius: 16px;
            padding: 12px 20px;
            display: inline-block;
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) border-box;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
        }
        .menu-btn {
            position: absolute;
            top: 15px;
            right: 0;
            width: 44px;
            height: 44px;
            background: rgba(10, 20, 40, 0.85);
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) border-box;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
        }
        .menu-btn:hover {
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }
        .menu-btn:active {
            transform: scale(0.95);
        }
        .menu-btn span {
            width: 22px;
            height: 2.5px;
            background: linear-gradient(135deg, #00ffff, #0096ff);
            border-radius: 2px;
        }
        
        .menu-btn-highlight {
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, #10b981, #059669) border-box !important;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.5) !important;
        }
        
        .menu-btn-highlight span {
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }
        
        /* Menu Sidebar */
        .menu-sidebar {
            position: fixed;
            top: 0;
            right: -50%;
            width: 50%;
            max-width: 320px;
            height: 100vh;
            background: rgba(10, 20, 40, 0.98);
            border-left: 2px solid transparent;
            border-image: linear-gradient(180deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) 1;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .menu-sidebar.open {
            right: 0;
        }
        
        @media (min-width: 640px) {
            .menu-sidebar {
                right: -320px;
                width: 320px;
            }
        }
        
        .menu-header {
            padding: 12px 20px;
            margin: 15px 15px 10px 15px;
            background: rgba(10, 20, 40, 0.9);
            border-radius: 12px;
            border: 1.5px solid rgba(0, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: inline-block;
            width: auto;
        }
        
        .menu-title {
            font-size: 16px;
            font-weight: 900;
            color: #00ffff;
            text-align: center;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }
        
        .menu-items {
            padding: 15px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .menu-item {
            padding: 12px 16px;
            color: #c4b5fd;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .menu-item-disabled {
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.5;
        }
        
        .menu-item-disabled:hover {
            background: rgba(0, 0, 0, 0.3) !important;
            border-color: rgba(0, 255, 255, 0.15) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
            transform: none !important;
        }
        
        .menu-item:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.4);
            color: #00ffff;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.15);
        }
        
        .menu-item:active {
            transform: scale(0.98);
        }
        
        .menu-item-highlight {
            background: rgba(16, 185, 129, 0.2) !important;
            border-color: #10b981 !important;
            color: #10b981 !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3) !important;
        }
        
        .menu-item-highlight:hover {
            background: rgba(16, 185, 129, 0.3) !important;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
        }
        
        .menu-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .profile-modal.show {
            display: flex;
        }
        
        .profile-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }
        
        .profile-content {
            position: relative;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            background: rgba(10, 20, 40, 0.95);
            border-radius: 24px;
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.95), rgba(10, 20, 40, 0.95)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) border-box;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
        }
        
        .profile-header {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }
        
        .profile-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-close:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(0, 255, 255, 0.4);
        }
        
        .profile-close svg {
            width: 20px;
            height: 20px;
            stroke: #00ffff;
            stroke-width: 2.5;
        }
        
        .profile-avatar-large {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #fbbf24, #f97316);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 900;
            color: white;
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.4);
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 900;
            color: white;
            margin-bottom: 5px;
        }
        
        .profile-username {
            font-size: 16px;
            color: #8b5cf6;
            font-weight: 600;
        }
        
        .profile-body {
            padding: 20px 30px 30px;
        }
        
        .profile-section {
            margin-bottom: 25px;
        }
        
        .profile-section-title {
            font-size: 14px;
            color: #8b5cf6;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .profile-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .profile-info-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 14px;
            padding: 14px;
        }
        
        .profile-info-label {
            font-size: 12px;
            color: #c4b5fd;
            margin-bottom: 6px;
        }
        
        .profile-info-value {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }
        
        .profile-stats-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .profile-stat-card {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }
        
        .profile-stat-value {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #00ffff, #0096ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }
        
        .profile-stat-label {
            font-size: 11px;
            color: #c4b5fd;
            font-weight: 600;
        }
        
        .profile-action-btn {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.25);
            border-radius: 12px;
            color: #00ffff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .profile-action-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(0, 255, 255, 0.4);
        }
        
        .profile-action-btn:active {
            transform: scale(0.98);
        }
        
        .profile-logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .profile-delete-btn {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        /* Avatar Upload */
        .profile-avatar-large {
            position: relative;
            background: linear-gradient(135deg, #0096ff, #00ffff) !important;
        }
        
        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #00ffff, #0096ff);
            border-color: rgba(0, 255, 255, 0.5);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .avatar-change-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #00ffff, #0096ff);
            border: 3px solid rgba(10, 20, 40, 0.95);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
        }
        
        .avatar-change-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.6);
        }
        
        .avatar-change-btn:active {
            transform: scale(0.95);
        }
        
        .avatar-change-btn svg {
            width: 18px;
            height: 18px;
            fill: #000;
        }
        
        /* Avatar change button for full page */
        .full-page-content .avatar-change-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #00ffff, #0096ff);
            border: 3px solid rgba(10, 20, 40, 0.95);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
        }
        
        .full-page-content .avatar-change-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.6);
        }
        
        .full-page-content .avatar-change-btn:active {
            transform: scale(0.95);
        }
        
        /* Referral Earnings Card */
        .referral-earnings-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 14px;
            padding: 16px;
        }
        
        .referral-earnings-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .referral-earnings-icon {
            font-size: 32px;
        }
        
        .referral-earnings-value {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #fbbf24, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .referral-earnings-label {
            font-size: 12px;
            color: #c4b5fd;
            margin-top: 2px;
        }
        
        .referral-earnings-detail {
            font-size: 13px;
            color: #8b5cf6;
            font-weight: 600;
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 255, 255, 0.1);
        }
        
        /* Ranking Card */
        .ranking-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 14px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .ranking-badge {
            text-align: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(249, 115, 22, 0.2));
            border: 2px solid rgba(251, 191, 36, 0.4);
            border-radius: 12px;
        }
        
        .ranking-position {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #fbbf24, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .ranking-label {
            font-size: 11px;
            color: #fbbf24;
            font-weight: 700;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .ranking-info-item:last-child {
            margin-bottom: 0;
        }
        
        .ranking-info-label {
            color: #c4b5fd;
            font-weight: 600;
        }
        
        .ranking-info-value {
            color: white;
            font-weight: 800;
        }
        
        /* Share Buttons */
        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .share-btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .share-btn:active {
            transform: scale(0.95);
        }
        
        .share-twitter {
            background: #1DA1F2;
        }
        
        .share-whatsapp {
            background: #25D366;
        }
        
        .share-telegram {
            background: #0088cc;
        }
        
        .share-copy {
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid rgba(0, 255, 255, 0.4);
        }
        
        /* Change Email/Password Modal */
        .change-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .change-modal.show {
            display: flex;
        }
        
        .change-modal-content {
            position: relative;
            max-width: 400px;
            width: 100%;
            background: rgba(10, 20, 40, 0.98);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.98), rgba(10, 20, 40, 0.98)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) border-box;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
        }
        
        .change-modal-title {
            font-size: 20px;
            font-weight: 900;
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .change-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .change-modal-close:hover {
            background: rgba(0, 0, 0, 0.6);
        }
        
        .change-modal-close svg {
            width: 16px;
            height: 16px;
            stroke: #00ffff;
            stroke-width: 2.5;
        }
        
        /* Full Page Container */
        .full-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }
        
        .full-page.active {
            display: block;
        }
        
        .full-page-header {
            position: sticky;
            top: 0;
            background: rgba(10, 20, 40, 0.95);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .back-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(0, 255, 255, 0.4);
        }
        
        .back-btn:active {
            transform: scale(0.95);
        }
        
        .back-btn svg {
            width: 22px;
            height: 22px;
            stroke: #00ffff;
            stroke-width: 2.5;
        }
        
        .full-page-title {
            font-size: 22px;
            font-weight: 900;
            color: white;
            flex: 1;
        }
        
        .full-page-content {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        .welcome-text { 
            color: #c4b5fd; 
            font-size: 16px; 
            font-weight: 600;
        }
        .username-text {
            color: #00ffff;
            font-weight: 700;
        }
        
        /* Card - No Blur */
        .card { 
            background: rgba(10, 20, 40, 0.85);
            border-radius: 28px;
            padding: 28px;
            margin-bottom: 18px;
            position: relative;
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.4), rgba(123, 67, 255, 0.4)) border-box;
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.2),
                0 10px 40px rgba(0, 0, 0, 0.4);
        }
        
        /* Balance - Compact 50% smaller */
        .balance-card {
            padding: 14px 20px !important;
            position: relative;
        }
        .balance-label { 
            color: #c4b5fd; 
            font-size: 12px; 
            text-align: center; 
            margin-bottom: 6px; 
        }
        .balance-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }
        .balance-value { 
            font-size: 28px; 
            font-weight: 900; 
            line-height: 1;
        }
        
        .balance-unit { 
            font-size: 16px; 
            color: #fbbf24; 
            font-weight: 600; 
        }
        .balance-toggle {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.2);
            color: #00bcd4;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: 0;
        }
        .balance-toggle:active {
            transform: scale(0.95);
            background: rgba(0, 0, 0, 0.4);
        }
        .balance-toggle svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
        }
        
        /* Button */
        .btn-mine { 
            width: 100%;
            padding: 26px;
            border: none;
            border-radius: 20px;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .btn-mine:active { transform: scale(0.97); }
        .btn-mine svg { width: 36px; height: 36px; }
        
        /* Static Green Border for Mining (No Animation) */
        .mining-glow {
            border: 2px solid #10b981 !important;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, #10b981, #10b981) border-box !important;
            box-shadow: 
                0 0 30px rgba(16, 185, 129, 0.4),
                0 10px 40px rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Timer */
        .timer-wrap { text-align: center; }
        .timer-circle {
            width: 140px;
            height: 140px;
            margin: 0 auto 20px;
            position: relative;
        }
        .timer-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-bg { stroke: rgba(255,255,255,0.12); fill: none; stroke-width: 10; }
        .timer-progress { 
            stroke: #10b981; 
            fill: none; 
            stroke-width: 10;
            stroke-linecap: round;
        }
        .timer-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .timer-icon svg { width: 52px; height: 52px; stroke: #10b981; }
        .mining-active { color: #10b981; font-weight: 700; font-size: 20px; margin-bottom: 10px; }
        .timer-time { font-size: 40px; font-weight: 900; margin-bottom: 8px; }
        .timer-label { color: #c4b5fd; font-size: 15px; }
        .earning-box {
            background: rgba(16,185,129,0.25);
            border: 1.5px solid rgba(16,185,129,0.4);
            border-radius: 14px;
            padding: 14px;
            margin-top: 18px;
        }
        .earning-text { color: #6ee7b7; font-size: 15px; text-align: center; }
        .earning-amount { font-weight: 800; font-size: 20px; }
        
        /* Stats Grid */
        .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 16px; 
            margin-bottom: 18px; 
        }
        .stat {
            background: rgba(10, 20, 40, 0.85);
            border-radius: 20px;
            padding: 14px;
            border: 2px solid transparent;
            background: 
                linear-gradient(rgba(10, 20, 40, 0.85), rgba(10, 20, 40, 0.85)) padding-box,
                linear-gradient(145deg, rgba(0, 255, 255, 0.3), rgba(123, 67, 255, 0.3)) border-box;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
            min-height: 140px;
            max-height: 140px;
            display: flex;
            flex-direction: column;
        }
        .stat-top { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stat-icon svg { width: 20px; height: 20px; }
        .stat-label { color: #c4b5fd; font-size: 13px; flex: 1; }
        .stat-value { font-size: 24px; font-weight: 900; line-height: 1; }
        .stat-unit { font-size: 13px; color: #c4b5fd; margin-top: 4px; }
        
        /* Level Card - Enhanced */
        .level-progress-bar {
            position: relative;
            overflow: visible;
            width: 100%;
            height: 18px;
            background: rgba(10, 20, 40, 0.85);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-top: 4px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .level-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            pointer-events: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 9px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .level-claim-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3)) !important;
            border: 2px solid #10b981 !important;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5) !important;
        }
        
        .congrats-text {
            font-size: 24px;
            font-weight: 900;
            color: #10b981;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .level-reached-text {
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .reward-text {
            font-size: 15px;
            color: #6ee7b7;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .claim-btn {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .claim-btn:active {
            transform: scale(0.98);
        }
                /* Daily Reward Card */
        .reward-card {
            text-align: center;
            padding: 18px;
        }
        
        .reward-available {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3)) !important;
            border: 2px solid #10b981 !important;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5) !important;
        }
        
        .reward-available .stat-icon {
            background: rgba(6, 182, 212, 0.35) !important;
        }
        
        .reward-available .stat-icon svg {
            stroke: #06b6d4 !important;
        }
        
        .reward-chest {
            width: 70px;
            height: 70px;
            margin: 0 auto 12px;
        }
        
        .reward-chest.locked {
            opacity: 0.4;
        }
        
        .reward-chest.available {
            opacity: 1;
        }
        
        .reward-chest svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 12px rgba(0, 150, 255, 0.4));
        }
        
        .reward-chest.locked svg {
            filter: drop-shadow(0 2px 6px rgba(100, 100, 100, 0.2));
        }
        
        .reward-claim-btn {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .reward-claim-btn:active {
            transform: scale(0.98);
        }
        .icon-blue svg { stroke: #93c5fd; fill: none; stroke-width: 2; }
        .icon-purple { background: rgba(168,85,247,0.35); }
        .icon-purple svg { stroke: #d8b4fe; fill: none; stroke-width: 2; }
        .icon-green { background: rgba(16,185,129,0.35); }
        .icon-green svg { stroke: #6ee7b7; fill: none; stroke-width: 2; }
        .icon-orange { background: rgba(249,115,22,0.35); }
        .icon-orange svg { stroke: #fdba74; fill: none; stroke-width: 2; }
        .icon-pink { background: rgba(236, 72, 153, 0.35); }
        .icon-red { background: rgba(239, 68, 68, 0.35); }
        .icon-cyan { background: rgba(6, 182, 212, 0.35); }
        
        /* Section Title */
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .section-title svg { width: 20px; height: 20px; stroke: #93c5fd; }
        
        /* Referral - Compact */
        .ref-compact {
            background: rgba(0,0,0,0.35);
            border: 1.5px solid rgba(59,130,246,0.35);
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .ref-code-text {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: #93c5fd;
            letter-spacing: 1px;
            flex: 1;
        }
        
        .copy-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4);
            color: #00ffff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .copy-btn:active {
            transform: scale(0.95);
            background: rgba(0, 255, 255, 0.3);
        }
        
        .copy-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }
        
        /* Bonus */
        .bonus-card {
            background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(249,115,22,0.25));
            border: 1.5px solid rgba(251,191,36,0.4);
        }
        .bonus-text { color: #e9d5ff; font-size: 15px; margin-bottom: 14px; line-height: 1.5; }
        .bonus-highlight { color: #fbbf24; font-weight: 800; }
        .btn-bonus {
            background: linear-gradient(135deg, #fbbf24, #f97316);
            color: white;
            padding: 14px;
            font-size: 17px;
            width: 100%;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-disabled {
            background: rgba(100,100,100,0.5);
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
        }
        
        /* Logout Button */
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
        }
        
        /* Footer */
        .footer { text-align: center; padding: 24px 0; }
        .footer-text { color: #c4b5fd; font-size: 13px; }

        .password-wrapper {
            position: relative;
            width: 100%;
        }
        
        .password-wrapper input {
            padding-right: 45px !important;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            transition: color 0.2s;
            z-index: 10;
        }
        
        .password-toggle:hover {
            color: #00ffff;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(10, 20, 40, 0.95), rgba(15, 30, 60, 0.95));
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

    
        .days-badge {
            min-width: 9ch;
            max-width: 9ch;
            text-align: center;
            white-space: nowrap;
            font-size: 10px;
            font-weight: 700;
            line-height: 1;
        }
        
/* === PRO LOADING SCREEN === */
#loadingScreen {
    display: flex;
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}

.loading-card {
    background: rgba(10,20,40,0.85);
    border-radius: 24px;
    padding: 40px 32px;
    border: 2px solid transparent;
    background:
      linear-gradient(rgba(10,20,40,0.85), rgba(10,20,40,0.85)) padding-box,
      linear-gradient(145deg, rgba(0,255,255,0.4), rgba(123,67,255,0.4)) border-box;
    box-shadow: 0 0 40px rgba(0,255,255,0.25);
    text-align: center;
}

.loading-spinner {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 4px solid rgba(0,255,255,0.15);
    border-top-color: #00ffff;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

.loading-text {
    color: #c4b5fd;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
}


@keyframes notificationPulse {
    0%, 100% { border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
    50% { border-color: #059669; box-shadow: 0 0 25px rgba(16, 185, 129, 0.8); }
}

/* === AUTH LOGO & SPLASH FIX (MOBILE SAFE) === */
.auth-logo {
  width: 140px;
  height: 140px;
  margin: 0 auto 24px auto;
  background-image: url('assets/auth-logo.webp');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.auth-splash {
  width: 100%;
  height: 220px;
  background-image: url('assets/splash-image.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 20px;
}


/* === BALANCE ICON FINAL FIX === */
.balance-icon {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  border: 0.3px solid #00d9ff;
  border-radius: 4px;
  padding: 2px;
  margin: 4px 0;
  display: inline-block;
}

</style>
        
	<!-- 
Bu kodu index.html dosyanızın <head> bölümüne ekleyin 

<script>
function showLoginLoading() {
    const el = document.getElementById('loadingScreen');
    if (el) el.style.display = 'flex';
}
function {
    const el = document.getElementById('loadingScreen');
    if (el) el.style.display = 'none';
}
</script>

</head> taginden ÖNCE
-->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<script>
// ============================================
// Firebase Configuration
// ============================================
// TODO: Buraya kendi Firebase config'inizi yapıştırın
const firebaseConfig = {
  apiKey: "AIzaSyDe_cjESa1hQoGiabRoLO2Tmj6JrZVB9NY",
  authDomain: "arcastra-eba62.firebaseapp.com",
  projectId: "arcastra-eba62",
  storageBucket: "arcastra-eba62.firebasestorage.app",
  messagingSenderId: "547925747222",
  appId: "1:547925747222:web:01a6b875fe14624d777737"
};

console.log('Initializing Firebase...');

firebase.initializeApp(firebaseConfig);
console.log('Firebase initialized:', firebase.apps.length);
const db = firebase.firestore();
// const messaging = firebase.messaging(); // DISABLED - Not using push notifications
// Auto-login when DOM is ready  
document.addEventListener('DOMContentLoaded', async function() {
    // Auto-reload when internet connection restored
    window.addEventListener('online', () => {
        console.log('Internet connection restored - reloading...');
        location.reload();
    });
    
    console.log('=== AUTO-LOGIN BAŞLADI ===');
    
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const userId = localStorage.getItem('userId');
    const storedUser = localStorage.getItem('currentUser');
    
    console.log('isLoggedIn:', isLoggedIn);
    console.log('userId:', userId);
    console.log('storedUser:', storedUser ? 'VAR' : 'YOK');
    
    if (isLoggedIn === 'true' && userId) {
        // Try to load from localStorage first
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            if (!currentUser.username && currentUser.email) {
                currentUser.username = currentUser.email.split('@')[0];
            }
            
            console.log('currentUser loaded from localStorage:', currentUser);
        } else {
            // If not in localStorage, fetch from backend
            console.log('storedUser not found, fetching from backend...');
            try {
                const response = await fetch(API_ENDPOINTS.getAllUserData, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ userId: userId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.user) {
                        currentUser = data.user;
                        currentUser.userId = userId;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        console.log('✅ User data fetched from backend:', currentUser);
                    } else {
                        console.error('❌ No user data in response');
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('userId');
                        return;
                    }
                } else {
                    console.error('❌ Failed to fetch user data:', response.status);
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userId');
                    return;
                }
            } catch (error) {
                console.error('❌ Error fetching user data:', error);
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userId');
                return;
            }
        }
        
        setTimeout(() => {
            console.log('Showing app...');
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        // keep loading until app fully ready
            console.log('Calling initApp...');
            initApp();
            console.log('initApp completed');
        }, 1000);
    } else {
        console.log('Auto-login FAILED - missing data');
    }
});
// ============================================
// Firebase Cloud Functions URL'leri
// ============================================
// TODO: firebase functions:list komutundan aldığınız URL'leri buraya yapıştırın
const FUNCTIONS_BASE_URL = 'https://europe-west1-arcastra-eba62.cloudfunctions.net';

const API_ENDPOINTS = {
  registerUser: `${FUNCTIONS_BASE_URL}/registerUser`,
  loginUser: `${FUNCTIONS_BASE_URL}/loginUser`,
  updateFcmToken: `${FUNCTIONS_BASE_URL}/updateFcmToken`,
  startMining: `${FUNCTIONS_BASE_URL}/startMining`,
  applyAdBoost: `${FUNCTIONS_BASE_URL}/applyAdBoost`,
  claimReward: `${FUNCTIONS_BASE_URL}/claimReward`,
  getUserData: `${FUNCTIONS_BASE_URL}/getUserData`,
  getAllUserData: `${FUNCTIONS_BASE_URL}/getAllUserData`,  // NEW: Optimized single request
  getMiningSessions: `${FUNCTIONS_BASE_URL}/getMiningSessions`,
  sendMiningNotification: `${FUNCTIONS_BASE_URL}/sendMiningNotification`,
  updateLevel: `${FUNCTIONS_BASE_URL}/updateLevel`,
  claimLevelReward: `${FUNCTIONS_BASE_URL}/claimLevelReward`,
  claimDailyReward: `${FUNCTIONS_BASE_URL}/claimDailyReward`,
  claimReferralEarnings: `${FUNCTIONS_BASE_URL}/claimReferralEarnings`,
  claimAirdrops: `${FUNCTIONS_BASE_URL}/claimAirdrops`,
  getReferrals: `${FUNCTIONS_BASE_URL}/getReferrals`,
  getActiveReferrals: `${FUNCTIONS_BASE_URL}/getActiveReferrals`,
  getTransactions: `${FUNCTIONS_BASE_URL}/getTransactions`,
  getLeaderboard: `${FUNCTIONS_BASE_URL}/getLeaderboard`,
  updateProfile: `${FUNCTIONS_BASE_URL}/updateProfile`,
  updateEmail: `${FUNCTIONS_BASE_URL}/updateEmail`,
  updatePassword: `${FUNCTIONS_BASE_URL}/updatePassword`,
  deleteAccount: `${FUNCTIONS_BASE_URL}/deleteAccount`,
  sendPasswordReset: `${FUNCTIONS_BASE_URL}/sendPasswordReset`,
  resetPasswordWithCode: `${FUNCTIONS_BASE_URL}/resetPasswordWithCode`,
  sendEmailVerification: `${FUNCTIONS_BASE_URL}/sendEmailVerification`,
  addPendingReward: `${FUNCTIONS_BASE_URL}/addPendingReward`,
  getPendingRewards: `${FUNCTIONS_BASE_URL}/getPendingRewards`,
  claimPendingReward: `${FUNCTIONS_BASE_URL}/claimPendingReward`,
  purchaseSpeedBoost: `${FUNCTIONS_BASE_URL}/purchaseSpeedBoost`,
};

// API Key for mobile app security
const API_KEY = 'arc_astra_mobile_2024_x7K9mP3qR8wL5nF2';

// Helper function to add API key to headers
function getApiHeaders(additionalHeaders = {}) {
  return {
    'Content-Type': 'application/json',
    'x-api-key': API_KEY,
    ...additionalHeaders
  };
}
  

// ============================================
// PENDING REWARDS MANAGEMENT
// ============================================

// Add pending reward to Firebase
async function addPendingReward(rewardType, amount, metadata = {}) {
    try {
        const response = await fetch(API_ENDPOINTS.addPendingReward, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({
                userId: currentUser.userId,
                rewardType, // 'daily', 'levelUp', 'referral'
                amount,
                metadata
            })
        });

        const data = await response.json();
        if (response.ok) {
            console.log(`✅ Pending ${rewardType} reward saved:`, amount);
            return data.rewardId;
        } else {
            console.error('❌ Failed to save pending reward:', data.error);
            return null;
        }
    } catch (error) {
        console.error('❌ Error saving pending reward:', error);
        return null;
    }
}

// Get all pending rewards for current user
async function getPendingRewards() {
    try {
        const response = await fetch(API_ENDPOINTS.getPendingRewards, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({
                userId: currentUser.userId
            })
        });

        const data = await response.json();
        if (response.ok) {
            console.log('📋 Pending rewards loaded:', data.pendingRewards.length);
            return data.pendingRewards || [];
        } else {
            console.error('❌ Failed to load pending rewards:', data.error);
            return [];
        }
    } catch (error) {
        console.error('❌ Error loading pending rewards:', error);
        return [];
    }
}

// Claim a pending reward
async function claimPendingRewardById(rewardId) {
    try {
        const response = await fetch(API_ENDPOINTS.claimPendingReward, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({
                userId: currentUser.userId,
                rewardId
            })
        });

        const data = await response.json();
        if (response.ok) {
            console.log('✅ Pending reward claimed:', data.amount);
            
            // Update local balance
            currentUser.balance = (currentUser.balance || 0) + data.amount;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Reload app to refresh pending rewards and hide claimed buttons
            await initApp();
            
            return true;
        } else {
            console.error('❌ Failed to claim pending reward:', data.error);
            return false;
        }
    } catch (error) {
        console.error('❌ Error claiming pending reward:', error);
        return false;
    }
}

// Check and restore pending rewards on app init
async function checkAndShowPendingRewards() {
    if (!currentUser || !currentUser.userId) return;
    
    console.log('🔍 Checking for pending rewards...');
    const pendingRewards = await getPendingRewards();
    
    if (pendingRewards.length === 0) {
        console.log('✓ No pending rewards');
        return;
    }
    
    console.log(`📦 Found ${pendingRewards.length} pending reward(s)`);
    
    // Process each pending reward and set appropriate flags
    for (const reward of pendingRewards) {
        console.log(`📦 Restoring pending ${reward.rewardType} reward:`, reward.amount);
        
        if (reward.rewardType === 'daily') {
            // Set daily reward flag
            dailyRewardAvailable = true;
            console.log('✅ Daily reward flag restored');
        } else if (reward.rewardType === 'levelUp') {
            // Set level up flag
            const metadata = reward.metadata || {};
            const level = metadata.level || (currentUser.level + 1);
            d.pendingLevelUp = level;
            console.log(`✅ Level up flag restored: Level ${level}`);
        } else if (reward.rewardType === 'referral') {
            // Referral earnings already in currentUser.pendingReferralEarnings
            console.log('✅ Referral earnings already loaded from backend');
        }
    }
    
    // Re-render to show claim buttons
    render();
}

// Show pending daily reward modal
function showPendingDailyReward(reward) {
    console.log('🎁 Showing pending daily reward modal');
    const modal = document.getElementById('dailyRewardModal');
    if (!modal) return;
    
    // Store reward ID for claiming
    modal.dataset.rewardId = reward.id;
    
    // Show modal
    modal.style.display = 'flex';
    dailyRewardAvailable = true;
    
    // Make sure claim button is visible and functional
    render();
}

// Show pending level up reward modal
function showPendingLevelUpReward(reward) {
    console.log('🎁 Showing pending level up reward modal');
    const modal = document.getElementById('levelUpModal');
    if (!modal) return;
    
    // Store reward ID for claiming
    modal.dataset.rewardId = reward.id;
    
    const metadata = reward.metadata || {};
    const level = metadata.level || currentUser.level;
    const amount = reward.amount;
    
    // Update modal content
    modal.querySelector('.level-badge').textContent = level;
    modal.querySelector('.reward-amount').textContent = amount;
    
    // Show modal
    modal.style.display = 'flex';
}

// Show pending referral reward modal
function showPendingReferralReward(reward) {
    console.log('🎁 Showing pending referral reward modal');
    const modal = document.getElementById('referralRewardModal');
    if (!modal) return;
    
    // Store reward ID for claiming
    modal.dataset.rewardId = reward.id;
    
    // Show modal
    modal.style.display = 'flex';
    
    // Update UI to show pending earnings
    render();
}

// ============================================
// FCM (Firebase Cloud Messaging) Functions
// ============================================
let fcmToken = null;

// Request notification permission and get FCM token - CRITICAL for mobile notifications!
async function requestNotificationPermission() {
  console.log('🔔 [FCM] Notifications disabled - skipping permission request');
  return null;
  
  /* DISABLED - NOT USING NOTIFICATIONS
  console.log('🔔 [FCM] Starting notification permission request...');
  
  try {
    // Check if browser supports notifications
    if (!('Notification' in window)) {
      console.warn('⚠️ [FCM] Browser does not support notifications');
      return null;
    }

    // Check service worker support
    if (!('serviceWorker' in navigator)) {
      console.warn('⚠️ [FCM] Service workers not supported');
      return null;
    }

    console.log('✅ [FCM] Browser supports notifications and service workers');

    // Check if service worker file exists before registering
    let swExists = false;
    try {
      const swCheck = await fetch('/firebase-messaging-sw.js', { method: 'HEAD', cache: 'no-cache' });
      swExists = swCheck.ok && swCheck.status === 200;
    } catch (e) {
      // Service worker file doesn't exist - silently continue without notifications
      console.log('ℹ️ [FCM] Service Worker not available - push notifications disabled');
      return null;
    }

    if (!swExists) {
      console.warn('⚠️ [FCM] Service Worker file not available - notifications disabled');
      return null;
    }

    // Register service worker FIRST
    let registration;
    try {
      registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
        scope: '/'
      });
      console.log('✅ [FCM] Service Worker registered successfully:', registration);
      
      // Wait for service worker to be active
      await navigator.serviceWorker.ready;
      console.log('✅ [FCM] Service Worker is ready');
    } catch (swError) {
      console.warn('⚠️ [FCM] Service Worker registration failed (this is OK - notifications disabled):', swError.message);
      // Return null to disable FCM without breaking the app
      return null;
    }

    // Request permission - AGGRESSIVE MODE
    console.log('🔔 [FCM] Current permission status:', Notification.permission);
    
    let permission = Notification.permission;
    
    if (permission === 'default') {
      console.log('📱 [FCM] Requesting notification permission...');
      permission = await Notification.requestPermission();
      console.log('📱 [FCM] Permission result:', permission);
    }
    
    if (permission !== 'granted') {
      console.warn('⚠️ [FCM] Notification permission denied or blocked');
      return null;
    }

    console.log('✅ [FCM] Notification permission GRANTED');
    
    // Get FCM token
    try {
      console.log('🔑 [FCM] Getting FCM token...');
      const token = await messaging.getToken({
        vapidKey: 'BDvw3djSgLBuH4zlK80RoTCQLdek4Lv0PGjicCLwiU_gZZxq5fJcBrFgAOJPovzkL_g-dR8J_mL2IaZyKX5csy4',
        serviceWorkerRegistration: registration
      });
      
      if (!token) {
        console.error('❌ [FCM] No token received');
        return null;
      }
      
      console.log('✅ [FCM] Token received successfully!');
      console.log('🔑 [FCM] Token:', token);
      
      // Save token globally
      window.fcmToken = token;
      
      // Send token to backend
      await updateFcmToken(token);
      
      return token;
    } catch (tokenError) {
      console.error('❌ [FCM] Error getting token:', tokenError);
      return null;
    }
  } catch (error) {
    console.error('❌ [FCM] Error in requestNotificationPermission:', error);
    return null;
  }
  */
}

// Save FCM token to backend - CRITICAL for receiving notifications!
    async function updateFcmToken(token) {
  console.log('💾 [FCM] Saving token to backend...');
  
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) {
      console.warn('⚠️ [FCM] No userId found - cannot save token');
      return false;
    }

    console.log('📤 [FCM] Sending token to backend for user:', userId);
    
    const response = await fetch(API_ENDPOINTS.updateFcmToken, {
      method: 'POST',
      headers: getApiHeaders(),
      body: JSON.stringify({
        userId: userId, 
        fcmToken: token
      })
    });

    if (!response.ok) {
      throw new Error(`Backend responded with status: ${response.status}`);
    }

    const data = await response.json();
    console.log('✅ [FCM] Token saved successfully to backend:', data);
    
    // Store in localStorage for debugging
    localStorage.setItem('fcmToken', token);
    localStorage.setItem('fcmTokenSavedAt', new Date().toISOString());
    
    return true;
  } catch (error) {
    console.error('❌ [FCM] Error saving FCM token:', error);
    
    // Retry once after 2 seconds
    console.log('🔄 [FCM] Retrying token save in 2 seconds...');
    setTimeout(async () => {
      try {
        const userId = localStorage.getItem('userId');
        if (userId) {
          const retryResponse = await fetch(API_ENDPOINTS.updateFcmToken, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({ userId, fcmToken: token })
          });
          
          if (retryResponse.ok) {
            console.log('✅ [FCM] Token saved on retry');
            localStorage.setItem('fcmToken', token);
            localStorage.setItem('fcmTokenSavedAt', new Date().toISOString());
          }
        }
      } catch (retryError) {
        console.error('❌ [FCM] Retry failed:', retryError);
      }
    }, 2000);
    
    return false;
  }
}

/*
// DISABLED - Push notifications not used
// Handle foreground messages
messaging.onMessage((payload) => {
  console.log('Foreground message:', payload);
  
  // Set localStorage flags for notification types
  if (payload.data && currentUser) {
    if (payload.data.type === 'announcement') {
      localStorage.setItem('hasNewAnnouncements_' + currentUser.userId, 'true');
      console.log('✅ Announcement flag set');
    }
    if (payload.data.type === 'airdrop') {
      localStorage.setItem('hasNewAirdrops_' + currentUser.userId, 'true');
      console.log('✅ Airdrop flag set');
    }
    // Refresh notification indicators
    if (typeof checkNotifications === 'function') {
      checkNotifications();
    }
  }
  
  showCustomNotification(
    payload.notification.title,
    payload.notification.body,
    payload.data
  );
});
*/

// Show custom notification
function showCustomNotification(title, body, data) {
  const notificationHtml = `
    <div class="custom-notification" style="
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    ">
      <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <div style="font-size: 24px; margin-right: 10px;">⛏️</div>
        <div style="font-weight: bold; font-size: 16px;">${title}</div>
      </div>
      <div style="margin-bottom: 15px; font-size: 14px;">${body}</div>
      <button onclick="this.parentElement.remove()" style="
        background: #00d4ff;
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
      ">OK</button>
    </div>
  `;
  
  const div = document.createElement('div');
  div.innerHTML = notificationHtml;
  document.body.appendChild(div);
  
  setTimeout(() => div.remove(), 10000);
}

// Initialize FCM on page load
window.addEventListener('load', () => {
  setTimeout(() => requestNotificationPermission(), 2000);
});

</script>

<style>
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

        .days-badge {
            min-width: 9ch;
            max-width: 9ch;
            text-align: center;
            white-space: nowrap;
            font-size: 10px;
            font-weight: 700;
            line-height: 1;
        }
        
/* === PRO LOADING SCREEN === */
#loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}

.loading-card {
    background: rgba(10,20,40,0.85);
    border-radius: 24px;
    padding: 40px 32px;
    border: 2px solid transparent;
    background:
      linear-gradient(rgba(10,20,40,0.85), rgba(10,20,40,0.85)) padding-box,
      linear-gradient(145deg, rgba(0,255,255,0.4), rgba(123,67,255,0.4)) border-box;
    box-shadow: 0 0 40px rgba(0,255,255,0.25);
    text-align: center;
}

.loading-spinner {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 4px solid rgba(0,255,255,0.15);
    border-top-color: #00ffff;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

.loading-text {
    color: #c4b5fd;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
}


/* === AUTH LOGO & SPLASH FIX (MOBILE SAFE) === */
.auth-logo {
  width: 140px;
  height: 140px;
  margin: 0 auto 24px auto;
  background-image: url('assets/auth-logo.webp');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.auth-splash {
  width: 100%;
  height: 220px;
  background-image: url('assets/splash-image.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 20px;
}


/* === BALANCE ICON FINAL FIX === */
.balance-icon {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  border: 0.3px solid #00d9ff;
  border-radius: 4px;
  padding: 2px;
  margin: 4px 0;
  display: inline-block;
}

</style>
        


<script>
function showLoginLoading() {
    const el = document.getElementById('loadingScreen');
    if (el) el.style.display = 'flex';
}
function hideLoginLoading() {
    const el = document.getElementById('loadingScreen');
    if (el) el.style.display = 'none';
}
</script>

</head>
<body>

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <img src="assets/splash-image.webp" alt="" class="splash-image">
    </div>
    
    <!-- Toast Notification -->
    <div id="toastNotification" class="toast-notification"></div>
    
    <!-- Tech Background -->
    <div class="tech-bg"></div>
    <div class="grid-lines"></div>
    
    
        <div style="
            color: #00ffff;
            font-size: 18px;
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
        "><br><span style="font-size: 14px; color: rgba(255,255,255,0.6);"></span></div>
    </div>
    
    <div id="particles"></div>
    
    <div id="authScreen" class="auth-screen" style="display:none;">
        <div class="auth-logo"></div>
        
        <div class="auth-card">
            <div id="errorMsg" style="display:none;"></div>
            <div id="successMsg" style="display:none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-wrapper">
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="login()">Login</button>
                <div style="text-align: center; margin-top: 12px;">
                    <a onclick="showForgotPassword()" style="color: #00ffff; font-size: 13px; cursor: pointer; text-decoration: underline;">Forgot Password?</a>
                </div>
                <div class="divider">OR</div>
<button class="btn btn-primary" onclick="showSignup()">Sign Up</button>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="signupUsername" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="signupFullName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Birth Date</label>
                    <input type="text" class="form-input" id="signupBirthDate" placeholder="DD/MM/YYYY" maxlength="10" required oninput="formatBirthDateInput(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-wrapper">
                        <input type="password" class="form-input" id="signupPassword" placeholder="Create a password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('signupPassword', this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" class="form-input" id="signupPasswordConfirm" placeholder="Confirm your password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('signupPasswordConfirm', this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <div class="country-dropdown">
                        <input type="text" class="form-input" id="signupCountry" placeholder="Select or type your country" required autocomplete="off" onfocus="showCountryDropdown('signupCountry', 'signupCountryDropdown')" oninput="filterCountries('signupCountry', 'signupCountryDropdown')" onblur="setTimeout(() => validateCountryInput('signupCountry'), 200)">
                        <div id="signupCountryDropdown" class="country-dropdown-list"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Referral Code (Optional)</label>
                    <input type="text" class="form-input" id="signupReferral" placeholder="Enter referral code" oninput="this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1).toLowerCase()">
                </div>
                <button class="btn btn-primary" onclick="signup()">Create Account</button>
                <div class="switch-auth">Already have an account? <span onclick="showLogin()">Login</span></div>
            </div>
        </div>
    </div>
    
    <div class="container" id="app" style="display:none;"></div>
    
    <!-- Menu Sidebar -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="menu-sidebar" id="menuSidebar">
        <div class="menu-header">
            <div class="menu-title" id="menuUsername">Menu</div>
        </div>
        <div class="menu-items">
            <div class="menu-item" onclick="openPage('profile')">Profile</div>
            <div class="menu-item" onclick="openPage('upgrades')">
                <span style="display: flex; align-items: center; gap: 8px;">
                    <span>Upgrades</span>
                    <svg width="18" height="18" viewBox="0 0 24 24" style="transform: rotate(45deg);" xmlns="http://www.w3.org/2000/svg">
                        <!-- Flame (filled) -->
                        <ellipse cx="12" cy="20" rx="2" ry="3" fill="#ff6b00" opacity="0.7"/>
                        <ellipse cx="10.5" cy="21" rx="1" ry="2" fill="#ffaa00" opacity="0.6"/>
                        <ellipse cx="13.5" cy="21" rx="1" ry="2" fill="#ffaa00" opacity="0.6"/>
                        
                        <!-- Rocket outline -->
                        <g stroke="#00ffff" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <!-- Body -->
                            <path d="M 10 6 L 10 18 L 14 18 L 14 6"/>
                            
                            <!-- Nose -->
                            <path d="M 10 6 L 12 2 L 14 6"/>
                            
                            <!-- Window -->
                            <circle cx="12" cy="10" r="1.5"/>
                            
                            <!-- Left fin -->
                            <path d="M 10 15 L 8 18 L 10 17"/>
                            
                            <!-- Right fin -->
                            <path d="M 14 15 L 16 18 L 14 17"/>
                        </g>
                    </svg>
                </span>
            </div>
            <div class="menu-item" onclick="openPage('tasks')">Tasks</div>
            <div class="menu-item" onclick="openPage('leaderboard')">Leaderboard</div>
            <div class="menu-item" id="announcementsMenuItem" onclick="openPage('announcements')">Announcements</div>
            <div class="menu-item" id="airdropMenuItem" onclick="openPage('airdrop')">Events</div>
            <div class="menu-item menu-item-disabled">
                <span>Verification</span>
                <span style="font-size: 11px; color: #666; margin-left: 8px;">Coming Soon</span>
            </div>
            <div class="menu-item" onclick="viewRoadmap()">View Roadmap</div>
            <div class="menu-item" onclick="viewWhitepaper()">Whitepaper</div>
            <div class="menu-item" onclick="openPage('settings')">Settings</div>
        </div>
        <div style="padding: 10px;">
            <button class="profile-action-btn profile-logout-btn" onclick="logout()" style="width: 100%;">🚪 Logout</button>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-backdrop" onclick="closeProfile()"></div>
        <div class="profile-content">
            <div class="profile-header">
                <button class="profile-close" onclick="closeProfile()">
                    <svg viewBox="0 0 24 24" fill="none">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
                <div class="profile-title" style="font-size: 24px; font-weight: 900; color: white; text-align: center; padding: 20px 0 10px;">Profile</div>
                <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 15px; margin: 0 20px 20px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 900; color: white;" id="profileUsername"></div>
                    <div style="font-size: 13px; color: #8b5cf6; margin-top: 4px;" id="profileHandle"></div>
                </div>
            </div>
            <div class="profile-body">
                
                <div class="profile-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div class="profile-section-title" style="margin: 0;">Personal Information</div>
                        <button id="editInfoBtn" onclick="toggleEditInfo()" style="background: rgba(0, 255, 255, 0.2); border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; padding: 6px 12px; color: #00ffff; font-size: 12px; font-weight: 700; cursor: pointer;">
                            ✏️ Edit
                        </button>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Full Name</div>
                        <input type="text" id="inputFullName" class="form-input" placeholder="Enter your full name" style="margin: 0;" disabled>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Email Address</div>
                        <div style="font-size: 15px; color: #666; font-weight: 700;" id="profileEmail">-</div>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Birth Date</div>
                        <input type="text" id="inputBirthDate" class="form-input" style="margin: 0;" min="1923-01-01" max="2007-12-31" disabled>
                        <div id="birthDateError" style="display: none; margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 8px; color: #fca5a5; font-size: 12px; font-weight: 600;">
                            ⚠️ Birth year must be between 1923 and 2007
                        </div>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Country</div>
                        <div class="country-dropdown">
                            <input type="text" id="inputCountry" class="form-input" placeholder="Select or type your country" style="margin: 0;" disabled autocomplete="off" onfocus="showCountryDropdown('inputCountry', 'countryDropdown')" oninput="filterCountries('inputCountry', 'countryDropdown')">
                            <div id="countryDropdown" class="country-dropdown-list"></div>
                        </div>
                    </div>
                    <button id="saveInfoBtn" class="profile-action-btn" onclick="savePersonalInfo()" style="background: linear-gradient(135deg, #00ffff, #0096ff); color: #000; font-weight: 900; display: none;">
                        ✓ Save Information
                    </button>
                </div>
                
                <div class="profile-section">
                    <div class="profile-section-title">Account Settings</div>
                    <button class="profile-action-btn" onclick="showChangeEmail()">
                        📧 Change Email
                    </button>
                    <button class="profile-action-btn" onclick="showChangePassword()">
                        🔒 Change Password
                    </button>
                </div>
                
                <div class="profile-section">
                    <div class="profile-section-title">Share</div>
                    <button class="profile-action-btn" onclick="shareProfile()">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Share
                    </button>
                </div>
                
                <div class="profile-section">
                    <button class="profile-action-btn profile-logout-btn" onclick="logout()">
                        🚪 Logout
                    </button>
                    <button class="profile-action-btn profile-delete-btn" onclick="showDeleteAccount()">
                        🗑️ Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Change Email Modal -->
    <div class="change-modal" id="changeEmailModal">
        <div class="profile-backdrop" onclick="closeChangeEmail()"></div>
        <div class="change-modal-content">
            <button class="change-modal-close" onclick="closeChangeEmail()">
                <svg viewBox="0 0 24 24" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="change-modal-title">Change Email</div>
            <div class="form-group">
                <label class="form-label">New Email</label>
                <input type="email" class="form-input" id="newEmail" placeholder="Enter new email">
            </div>
            <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" class="form-input" id="emailPassword" placeholder="Confirm with password">
            </div>
            <button class="profile-action-btn" onclick="changeEmail()">
                ✓ Update Email
            </button>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="change-modal" id="changePasswordModal">
        <div class="profile-backdrop" onclick="closeChangePassword()"></div>
        <div class="change-modal-content">
            <button class="change-modal-close" onclick="closeChangePassword()">
                <svg viewBox="0 0 24 24" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="change-modal-title">Change Password</div>
            <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-input" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm new password">
            </div>
            <button class="profile-action-btn" onclick="changePassword()">
                ✓ Update Password
            </button>
        </div>
    </div>
    
    <!-- Delete Account Modal -->
    <div class="change-modal" id="deleteAccountModal">
        <div class="profile-backdrop" onclick="closeDeleteAccount()"></div>
        <div class="change-modal-content">
            <button class="change-modal-close" onclick="closeDeleteAccount()">
                <svg viewBox="0 0 24 24" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="change-modal-title" style="color: #ef4444;">Delete Account</div>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 20px;">
                <div style="color: #fca5a5; font-size: 13px; font-weight: 600;">⚠️ Warning: This action cannot be undone!</div>
                <div style="color: #fca5a5; font-size: 12px; margin-top: 5px;">All your data, balance, and progress will be permanently deleted.</div>
            </div>
            <div id="deleteError" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 10px; padding: 10px; margin-bottom: 15px;">
                <div style="color: #fca5a5; font-size: 13px; font-weight: 700;">❌ <span id="deleteErrorText"></span></div>
            </div>
            <div class="form-group">
                <label class="form-label">Enter Your Password to Confirm</label>
                <input type="password" class="form-input" id="deletePassword" placeholder="Enter your password">
            </div>
            <button class="profile-action-btn profile-delete-btn" onclick="event.stopPropagation(); confirmDeleteAccount();" style="cursor: pointer; pointer-events: auto;">
                🗑️ Delete Account
            </button>
        </div>
    </div>
    
    <!-- Goodbye Modal -->
    <div class="change-modal" id="goodbyeModal">
        <div class="profile-backdrop"></div>
        <div class="change-modal-content" style="text-align: center;">
            <svg viewBox="0 0 100 100" width="80" height="80" style="margin: 0 auto 20px;">
                <defs>
                    <linearGradient id="sadGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <!-- Face circle -->
                <circle cx="50" cy="50" r="45" fill="url(#sadGradient)" opacity="0.2"/>
                <circle cx="50" cy="50" r="45" fill="none" stroke="url(#sadGradient)" stroke-width="3"/>
                <!-- Sad eyes -->
                <circle cx="35" cy="42" r="3" fill="#8b5cf6"/>
                <circle cx="65" cy="42" r="3" fill="#8b5cf6"/>
                <!-- Tears -->
                <path d="M 35 48 Q 33 55 32 60" stroke="#6366f1" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.6"/>
                <path d="M 65 48 Q 67 55 68 60" stroke="#6366f1" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.6"/>
                <!-- Sad mouth -->
                <path d="M 30 70 Q 50 60 70 70" stroke="#8b5cf6" stroke-width="3" fill="none" stroke-linecap="round"/>
            </svg>
            <div style="font-size: 20px; font-weight: 900; color: white; margin-bottom: 10px;">Hesabınız silindi.</div>
            <div style="font-size: 16px; color: #c4b5fd; margin-bottom: 25px;">Sizi kaybettiğimiz için üzgünüz.</div>
            <button class="profile-action-btn" onclick="window.location.reload()">
                ✓ Tamam
            </button>
        </div>
    </div>
    
    <!-- Logout Confirmation Modal -->
    <div class="change-modal" id="logoutModal">
        <div class="profile-backdrop" onclick="closeLogoutModal()"></div>
        <div class="change-modal-content" style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">🚪</div>
            <div style="font-size: 20px; font-weight: 900; color: white; margin-bottom: 10px;">Logout</div>
            <div style="font-size: 16px; color: #c4b5fd; margin-bottom: 25px;">Are you sure you want to logout?</div>
            <div style="display: flex; gap: 10px;">
                <button class="profile-action-btn" onclick="closeLogoutModal()" style="flex: 1; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.25); color: #00ffff;">
                    Cancel
                </button>
                <button class="profile-action-btn profile-logout-btn" onclick="confirmLogout()" style="flex: 1;">
                    Yes, Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Full Page Container -->
    <div class="full-page" id="fullPage">
        <div class="full-page-header">
            <button class="back-btn" onclick="closePage()">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="full-page-title" id="fullPageTitle">Page</div>
        </div>
        <div class="full-page-content" id="fullPageContent">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <script>
        // Auth Management
        let currentUser = null;
        
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            hideMessages();
        }
        
        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            hideMessages();
        }
        
        function hideMessages() {
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';
        }
        
        function showError(msg) {
            // Close any waiting toasts by ID
            const toast = document.getElementById('toastNotification');
            if (toast) {
                toast.classList.remove('show');
            }
            
            const el = document.getElementById('errorMsg');
            el.className = 'error-msg';
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function showSuccess(msg) {
            // Close any waiting toasts
            const toasts = document.querySelectorAll('.toast-notification');
            toasts.forEach(toast => toast.remove());
            
            const el = document.getElementById('successMsg');
            el.className = 'success-msg';
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        function showToast(message, isError = false, duration = 3000) {
            let toast = document.getElementById('toastNotification');
            
            // If toast element doesn't exist, create it
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastNotification';
                toast.className = 'toast-notification';
                document.body.appendChild(toast);
            }
            
            toast.textContent = message;
            toast.className = 'toast-notification' + (isError ? ' error' : '');
            
            // Trigger show
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide after specified duration
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        function showExitToast() {
            let toast = document.getElementById('toastNotification');
            
            // If toast element doesn't exist, create it
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastNotification';
                toast.className = 'toast-notification';
                document.body.appendChild(toast);
            }
            
            toast.textContent = '⬅️ Press back again to exit';
            toast.className = 'toast-notification exit';
            
            // Trigger show
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide after 2 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
    async function login() {
        // Scroll to top immediately
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Show loading message immediately
        showToast('⏳ Waiting for server response...');
        
    const emailEl = document.getElementById('loginEmail');
    const passEl = document.getElementById('loginPassword');
    const email = (emailEl && typeof emailEl.value === 'string') ? emailEl.value.trim().toLowerCase() : '';
    const password = (passEl && typeof passEl.value === 'string') ? passEl.value.trim() : '';

    if (!email || !password) {
        showError('Please enter email and password');
        return;
    }

        try {
        // Firebase Authentication ile giriş
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // LOGIN SUCCESS -> show loading overlay
        if (typeof showLoginLoading === 'function') showLoginLoading();

        // Backend'den kullanıcı bilgilerini al
        const response = await fetch(API_ENDPOINTS.getAllUserData, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({ userId: user.uid })
        });
        const data = await response.json();

        if (response.ok && data.user) {
window.__resetEmail = email;
            console.log('RESET EMAIL SET:', window.__resetEmail);

            currentUser = data.user;
            localStorage.setItem('userId', user.uid);
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify(data.user));
            
            // Get FCM token immediately after login - CRITICAL for notifications!
            console.log('🔔 [LOGIN] Requesting FCM token after successful login...');
            try {
                requestNotificationPermission();
            } catch (err) {
                console.error('❌ [LOGIN] FCM token request failed:', err);
            }
            
            showSuccess('Login successful! ');
            
            setTimeout(() => {
                // After login: show app instead of blank background
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('app').style.display = 'none';
                
                initApp();
            }, 1000);
        }
    } catch (error) {
        console.error('Login error:', error);
        showError('Invalid email or password');
        
        // CRITICAL: Hide loading on error
        if (typeof hideLoginLoading === 'function') hideLoginLoading();
    }
}
        
        function formatBirthDateInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            let formattedValue = '';
            
            // Day part (DD)
            if (value.length > 0) {
                let day = value.substring(0, 2);
                if (value.length >= 2) {
                    day = Math.min(parseInt(day), 31).toString().padStart(2, '0');
                }
                formattedValue = day;
            }
            
            // Month part (MM)
            if (value.length >= 3) {
                let month = value.substring(2, 4);
                if (value.length >= 4) {
                    month = Math.min(parseInt(month), 12).toString().padStart(2, '0');
                }
                formattedValue += '/' + month;
            }
            
            // Year part (YYYY)
            if (value.length >= 5) {
                formattedValue += '/' + value.substring(4, 8);
            }
            
            input.value = formattedValue;
        }
        
    async function signup() {
        // Scroll to top immediately
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Show loading message indefinitely (duration = 999999)
        showToast('⏳ Waiting for server response...', false, 999999);
	
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('signupPasswordConfirm').value;
// Username validation
    const username = document.getElementById('signupUsername').value || email.split('@')[0];
    const fullName = document.getElementById('signupFullName').value;
    const country = document.getElementById('signupCountry').value;
    const birthDate = document.getElementById('signupBirthDate').value;
    
    if (!username || username.length < 3 || username.length > 12) {
        showError('Username must be 3-12 characters');
        return;
    }
    
    if (!/^[a-zA-Z0-9]+$/.test(username)) {
        showError('Username: only English letters and numbers allowed');
        return;
    }
    if (!email || !password || !confirmPassword) {
        showError('Please fill in all fields');
        return;
    }

    if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
    }

    if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
    }

    try {
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        const response = await fetch(API_ENDPOINTS.registerUser, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({
                userId: user.uid,
                email: user.email,
                username: username,
                fullName: fullName,
                country: country,
                birthDate: birthDate,
				referralCode: document.getElementById('signupReferral').value || null
            })
        });

        const data = await response.json();
        if (response.ok) {
            localStorage.setItem('userId', user.uid);
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify(data.user));
            showSuccess('Account created successfully! ');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => {
    const modal = document.getElementById('signupModal');
    if (modal) modal.classList.remove('show');
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
        // keep loading until app fully ready
    initApp();
            }, 1500);
        } else {
            // Backend failed - delete Firebase Auth user to prevent orphan accounts
            console.error('Backend registration failed:', data.error);
            await user.delete();
            showError('Registration failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Signup error:', error);
        
        // Firebase Auth error messages - convert to simple English
        let errorMessage = error.message;
        
        if (error.code === 'auth/email-already-in-use' || errorMessage.includes('email-already-in-use')) {
            errorMessage = 'This email is already in use';
        } else if (error.code === 'auth/invalid-email' || errorMessage.includes('invalid-email')) {
            errorMessage = 'Invalid email address';
        } else if (error.code === 'auth/weak-password' || errorMessage.includes('weak-password')) {
            errorMessage = 'Password is too weak';
        } else if (errorMessage.includes('Username already taken')) {
            errorMessage = 'This username is already in use';
        } else if (errorMessage.includes('Email already registered')) {
            errorMessage = 'This email is already in use';
        }
        
        showError(errorMessage);
    }
}            
            
        async function googleLogin() {
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await firebase.auth().signInWithPopup(provider);
        const user = result.user;
        
        await fetch(API_ENDPOINTS.registerUser, {
            method: 'POST',
            headers: getApiHeaders(),
            body: JSON.stringify({
                userId: user.uid,
                email: user.email,
                username: user.displayName || user.email.split('@')[0]
            })
        });
        
        localStorage.setItem('userId', user.uid);
        localStorage.setItem('userEmail', user.email);
        showSuccess('Login successful!');
        window.location.href = '#mine';
    } catch (error) {
        console.error('Google login error:', error);
        showError('Login failed: ' + error.message);
    }
}
        
        // Open external links in native browser (for Android app)
        function openExternalLink(url) {
            try {
                // Try Android interface first (for WebView)
                if (typeof Android !== 'undefined' && Android.openExternal) {
                    Android.openExternal(url);
                } else {
                    // Fallback for web/other platforms
                    window.open(url, '_blank');
                }
            } catch (error) {
                console.error('Error opening external link:', error);
                // Final fallback
                window.open(url, '_blank');
            }
        }
        
        function logout() {
            // Check if menu sidebar is open
            const menuSidebar = document.getElementById('menuSidebar');
            const isMenuOpen = menuSidebar && menuSidebar.classList.contains('open');
            
            // Remember where we came from
            if (isMenuOpen) {
                profileOpenedFrom = 'menu';
            } else if (document.getElementById('fullPage').classList.contains('active')) {
                profileOpenedFrom = 'fullpage';
            } else if (document.getElementById('profileModal').classList.contains('show')) {
                profileOpenedFrom = 'modal';
            }
            
            // Show logout confirmation modal
            document.getElementById('logoutModal').classList.add('show');
        }
        
        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.remove('show');
            
            // Return to where we came from
            if (profileOpenedFrom === 'menu') {
                // If from menu, just close the modal (menu should stay visible)
                // Do nothing, modal closes
            } else if (profileOpenedFrom === 'fullpage') {
                openPage('profile');
            } else {
                document.getElementById('profileModal').classList.add('show');
            }
        }
        
        function confirmLogout() {
            // Clear referrals cache
            cachedReferralsData = null;
            cachedReferralsTimestamp = 0;
            localStorage.removeItem('referralsCache_' + currentUser.email);
            localStorage.removeItem('referralsCacheTime_' + currentUser.email);
            
            // Clear leaderboard cache
            cachedLeaderboardData = null;
            
            // Clear ALL auth data to prevent auto-login
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userId');
            
            window.location.reload();
        }
        
        function copyReferralCode() {
            const code = currentUser.username;
            
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showSuccess('Referral code copied: ' + code);
            } catch (err) {
                showError('Failed to copy code');
            }
            
            document.body.removeChild(textarea);
        }
        
        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser) {
                    // Don't show app yet, initApp will handle it (and hide splash)
                    document.getElementById('authScreen').style.display = 'none';
                    initApp(); // Load fresh data, will hide splash when done
                    return;
                }
            }
            
             // Hide splash and show login if no user
            const splashScreen = document.getElementById('splashScreen');
            if (splashScreen) {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 800);
            }
            
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }
        
        let d = {};
        let balanceVisible = true;
        let dailyRewardAvailable = false;
        let hasPendingAirdrops = false;
        let pendingRewardsData = []; // Global - pending rewards data
        let activeMiningSession = null; // Store active session for ad boost check
        let tempPendingLevelUp = null; // Temporary storage for pending level up from backend
        
        // Claiming locks to prevent double-claims
        let isClaimingLevel = false;
        let isClaimingReferral = false;
        let isClaimingDaily = false;
        let isClaimingAirdrop = false;
        let isWatchingAd = false;
        
        // AdMob variables
        let adRewardEarned = false;
        let rewardedAd = null;
        const ADMOB_AD_UNIT_ID = 'ca-app-pub-4534323466794129/8698252598'; // mining_boost_reward
        
        // Prevent duplicate initApp calls
        let isInitializing = false;
        let initAppTimeout = null;
        
        // Track if initApp is called from completeMine (don't show rewards immediately)
        let isCompletingMining = false;
        
        // Track claimed levels to prevent re-showing after claim (temporary memory)
        let recentlyClaimedLevels = new Set();
        
        // Level system data
        const levelRequirements = {
            1: 0, 2: 5, 3: 10, 4: 15, 5: 20, 6: 30, 7: 40, 8: 50, 9: 60, 10: 75,
            11: 90, 12: 120, 13: 150, 14: 180, 15: 210, 16: 240, 17: 270, 18: 300, 19: 330, 20: 365
        };
        
        const levelRewards = {
            2: {coins: 20, rate: 0.05}, 3: {coins: 30, rate: 0.05}, 4: {coins: 50, rate: 0.05},
            5: {coins: 75, rate: 0.05}, 6: {coins: 100, rate: 0.05}, 7: {coins: 150, rate: 0.05},
            8: {coins: 200, rate: 0.05}, 9: {coins: 300, rate: 0.05}, 10: {coins: 500, rate: 0.05},
            11: {coins: 750, rate: 0.05}, 12: {coins: 1100, rate: 0.05}, 13: {coins: 1500, rate: 0.05},
            14: {coins: 2000, rate: 0.05}, 15: {coins: 2750, rate: 0.05}, 16: {coins: 3500, rate: 0.05},
            17: {coins: 4500, rate: 0.05}, 18: {coins: 6000, rate: 0.05}, 19: {coins: 7500, rate: 0.05},
            20: {coins: 10000, rate: 0.05}
        };
        
        function requestNotificationPermission() {
            // Check if notifications are supported and enabled in settings
            if (!('Notification' in window)) {
                return; // Browser doesn't support notifications
            }
            
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
            if (!notificationsEnabled) {
                return; // User disabled notifications in settings
            }
            
            // Request permission if not already granted
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function sendMiningCompleteNotification() {
            console.log('🔔 Attempting to send mining complete notification...');
            
            // Check if notifications are enabled and permitted
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
            
            if (!notificationsEnabled) {
                console.log('⚠️ Notifications disabled by user');
                return;
            }
            
            if (!('Notification' in window)) {
                console.log('⚠️ Browser does not support notifications');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                console.log('⚠️ Notification permission not granted:', Notification.permission);
                return;
            }
            
            try {
                // Create notification
                const notification = new Notification('⛏️ Mining Complete!', {
                    body: 'Your mining session has ended! Please start again!',
                    icon: 'https://i.ibb.co/zVD0p73/logo.png',
                    badge: 'https://i.ibb.co/zVD0p73/logo.png',
                    tag: 'mining-complete',
                    requireInteraction: true, // Notification stays until user interacts
                    silent: false,
                    vibrate: [200, 100, 200]
                });
                
                // Open app when notification is clicked
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                console.log('✅ Mining complete notification sent successfully');
            } catch (error) {
                console.error('❌ Error sending notification:', error);
            }
        }
        
        // Send backend push notification for when app is closed
        async function sendBackendPushNotification() {
            const sessionId = localStorage.getItem('currentSessionId_' + currentUser.email);
            if (!sessionId || !currentUser.userId) {
                console.log('⚠️ No session ID or user ID for backend notification');
                return;
            }
            
            try {
                console.log('📤 Sending backend push notification...');
                const response = await fetch(API_ENDPOINTS.sendMiningNotification, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        sessionId: sessionId
                    })
                });
                
                if (response.ok) {
                    console.log('✅ Backend push notification sent successfully');
                } else {
                    const error = await response.json().catch(() => ({}));
                    console.log('⚠️ Backend notification failed:', error.error || 'Unknown error');
                }
            } catch (error) {
                console.error('❌ Error sending backend notification:', error);
            }
        }
        async function initApp() {
    // Debounce: Multiple calls within 100ms = single execution
    if (initAppTimeout) {
        console.log('⚠️ initApp debounced - ignoring rapid call');
        return;
    }
    
    // Prevent duplicate calls
    if (isInitializing) {
        console.log('⚠️ initApp already running, skipping duplicate call');
        return;
    }
    
    // Set debounce timeout
    initAppTimeout = setTimeout(() => {
        initAppTimeout = null;
    }, 100);
    
    isInitializing = true;
    
    try {
        requestAnimationFrame(() => {  });
        const appEl = document.getElementById('app');
        if (appEl) appEl.style.display = 'block';
        
        // pendingRewardsData artık global - tekrar tanımlamaya gerek yok
        
        // localStorage'dan currentUser'ı oku
        const storedUser = localStorage.getItem('currentUser');
        const userId = localStorage.getItem('userId');
        
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            // Username yoksa email'den oluştur
            if (!currentUser.username && currentUser.email) {
                currentUser.username = currentUser.email.split('@')[0];
            }
        }
    
    // Backend'den TÜM verileri çek - TEK İSTEK (OPTİMİZE EDİLDİ!)
    if (userId) {
        try {
            console.log('🔄 Backend veriler çekiliyor (optimize edilmiş tek istek)...');
            console.log('🆔 UserID:', userId);
            console.log('👤 Stored User:', JSON.parse(localStorage.getItem('currentUser') || '{}'));
            
            // OPTİMİZE: 4 istek yerine TEK istek!
            const response = await fetch(API_ENDPOINTS.getAllUserData, {
                method: 'POST',
                headers: getApiHeaders(),
                body: JSON.stringify({ userId: userId })
            });
            
            console.log('📡 Response status:', response.status);
            console.log('📡 Response ok:', response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ Response not ok:', response.status, errorText);
                
                // Eğer kullanıcı bulunamazsa localStorage'ı temizle
                if (response.status === 404) {
                    console.log('🧹 User not found, clearing localStorage...');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentUser');
                    window.location.reload();
                }
                
                throw new Error(`Failed to fetch user data: ${response.status} - ${errorText}`);
            }
            
            const allData = await response.json();
            
            // Process User Data
            currentUser = allData.user;
            activeMiningSession = allData.activeMiningSession || null;
            localStorage.setItem('currentUser', JSON.stringify(allData.user));
            
            // Aktif mining session varsa yükle
            if (allData.activeMiningSession) {
                const session = allData.activeMiningSession;
                const endTime = session.endTime._seconds ? session.endTime._seconds * 1000 : session.endTime;
                const startTime = session.startTime._seconds ? session.startTime._seconds * 1000 : session.startTime;
                localStorage.setItem('miningEndTime_' + currentUser.email, endTime);
                localStorage.setItem('miningStartTime_' + currentUser.email, startTime);
                localStorage.setItem('currentSessionId_' + currentUser.email, session.sessionId);
                
                // Debug: Log ad boost status
                console.log('✅ Active mining session loaded:', {
                    sessionId: session.sessionId,
                    adBoostActive: session.adBoostActive,
                    adBoostCount: session.adBoostCount
                });
            } else {
                console.log('✓ No active mining session');
            }
            
            console.log('✅ User data yüklendi');
            
            // Process Airdrops (cache for airdrop page)
            window.cachedAirdrops = allData.airdrops || [];
            window.cachedTotalAirdropAmount = allData.totalAirdropAmount || 0;
            console.log('✅ Airdrops loaded:', {
                count: window.cachedAirdrops.length,
                total: window.cachedTotalAirdropAmount
            });
            
            // Process Referral Counts (no detailed list - modal will fetch that)
            localStorage.setItem('activeReferralCount_' + currentUser.email, allData.activeCount || 0);
            localStorage.setItem('totalReferralsCount_' + currentUser.email, allData.totalCount || 0);
            console.log('✅ Referral counts loaded:', {
                active: allData.activeCount || 0,
                total: allData.totalCount || 0
            });
            
            // Process Pending Rewards
            pendingRewardsData = allData.pendingRewards || [];
            
            // CRITICAL: Check localStorage for recently claimed rewards to prevent re-showing
            const now = Date.now();
            const lastDailyClaimTime = parseInt(localStorage.getItem('lastDailyClaimTime_' + currentUser.userId) || '0');
            const recentlyClaimed = (now - lastDailyClaimTime) < 5000; // Within 5 seconds
            
            if (pendingRewardsData.length > 0) {
                console.log(`📦 ${pendingRewardsData.length} pending reward bulundu`);
                
                // Get claimed levels from backend
                const claimedLevels = allData.user.claimedLevels || [];
                
                // Restore flags from pending rewards
                for (const reward of pendingRewardsData) {
                    if (reward.rewardType === 'daily') {
                        // Don't show if recently claimed in this session
                        if (!recentlyClaimed) {
                            // ✅ Only set if NOT called from completeMine
                            if (!isCompletingMining) {
                                dailyRewardAvailable = true;
                                console.log('✅ Daily reward flag set');
                            } else {
                                console.log('ℹ️ Mining just completed - daily reward will show on next app open');
                            }
                        } else {
                            console.log('🚫 Daily reward recently claimed, skipping');
                        }
                    } else if (reward.rewardType === 'levelUp') {
                        const metadata = reward.metadata || {};
                        const level = metadata.level || (currentUser.level + 1);
                        
                        // CRITICAL: Don't set pending if already claimed
                        if (claimedLevels.includes(level)) {
                            console.log(`🚫 Level ${level} already claimed, ignoring pending reward`);
                            continue;
                        }
                        
                        tempPendingLevelUp = level;
                        console.log(`✅ Level up flag set: Level ${level}`);
                    }
                }
                
                // Calculate total pending referral earnings from pendingRewards
                // Filter out any that might still be in results but marked as claimed
                const referralRewards = pendingRewardsData.filter(r => 
                    r.rewardType === 'referral' && r.claimed === false
                );
                const totalReferralEarnings = referralRewards.reduce((sum, r) => sum + (r.amount || 0), 0);
                
                // CRITICAL: Check localStorage for recently claimed referrals
                const lastReferralClaimTime = parseInt(localStorage.getItem('lastReferralClaimTime_' + currentUser.userId) || '0');
                const referralRecentlyClaimed = (now - lastReferralClaimTime) < 5000; // Within 5 seconds
                
                if (totalReferralEarnings > 0 && !referralRecentlyClaimed) {
                    currentUser.pendingReferralEarnings = totalReferralEarnings;
                    console.log(`✅ Referral earnings calculated: ${totalReferralEarnings}`);
                } else {
                    currentUser.pendingReferralEarnings = 0;
                    if (referralRecentlyClaimed) {
                        console.log('🚫 Referral recently claimed, skipping');
                    }
                }
            } else {
                console.log('✓ No pending rewards');
            }
            
            console.log('✅ TÜM BACKEND VERİLER YÜKLENDİ (tek istek - optimize!)');
            
        } catch (error) {
            console.error('❌ Backend veri çekme hatası:', error);
            console.error('Error message:', error.message);
            if (error.response) {
                const errorData = await error.response.json().catch(() => ({}));
                console.error('Backend error response:', errorData);
            }
        }
    }
    
            // CRITICAL: Check if currentUser exists before creating d object
            if (!currentUser) {
                console.error('❌ currentUser is undefined! Redirecting to login...');
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                return;
            }
    
            d = {
                balance: currentUser.balance || 0,
                level: currentUser.level || 1,
                refs: parseInt(localStorage.getItem('totalReferralsCount_' + currentUser.email)) || 0,
                activeRefs: parseInt(localStorage.getItem('activeReferralCount_' + currentUser.email)) || 0,
                streak: currentUser.streak || 0,
                lastDate: currentUser.lastDate || null,
                refCode: currentUser.referralCode || currentUser.refCode,
                fullName: currentUser.fullName || '',
                country: currentUser.country || '',
                birthDate: currentUser.birthDate || '',
                mining: false,
                timeLeft: 0,
                miningDays: currentUser.miningDays || 0,
                // Only set pendingLevelUp if not recently claimed
                pendingLevelUp: (() => {
                    const pending = tempPendingLevelUp || currentUser.pendingLevelUp || null;
                    if (pending && recentlyClaimedLevels.has(pending)) {
                        console.log(`🚫 Level ${pending} recently claimed, ignoring backend pendingLevelUp`);
                        return null;
                    }
                    return pending;
                })(),
                pendingReferralEarnings: currentUser.pendingReferralEarnings || 0
            };
            
            // Calculate active mining referrals
            d.activeRefs = calculateActiveRefs();
            
            // Calculate dynamic rate: base rate + referral bonus + ad boost + speed boost
            // Base rate includes level bonuses only (permanent)
            const baseRate = currentUser.rate || 0.25;
            const refBonus = d.activeRefs * 0.05;
            
            // Check if current session has ad boost active
            let adBonus = 0;
            if (activeMiningSession && activeMiningSession.adBoostActive) {
                adBonus = activeMiningSession.adBoostTotal || 0;  // Use total cumulative boost
                console.log('🚀 Ad boost detected:', {
                    adBoostCount: activeMiningSession.adBoostCount,
                    adBoostTotal: adBonus
                });
            }
            
            // Check if current session has speed boost active (purchased)
            let speedBonus = 0;
            if (activeMiningSession && activeMiningSession.speedBoostActive) {
                speedBonus = activeMiningSession.speedBoostAmount || 5.0;
                console.log('⚡ Speed boost detected:', {
                    speedBoostActive: activeMiningSession.speedBoostActive,
                    speedBoostAmount: speedBonus,
                    speedBoostCount: activeMiningSession.speedBoostCount
                });
            } else {
                console.log('⚡ No speed boost:', {
                    hasSession: !!activeMiningSession,
                    speedBoostActive: activeMiningSession?.speedBoostActive
                });
            }
            
            d.rate = baseRate + refBonus + adBonus + speedBonus;
            
            console.log('💰 Final rate calculated:', {
                baseRate: baseRate,
                refBonus: refBonus,
                adBonus: adBonus,
                speedBonus: speedBonus,
                totalRate: d.rate
            });
            
            // Check for pending airdrops
            hasPendingAirdrops = (currentUser.pendingAirdrops && currentUser.pendingAirdrops.length > 0) || false;
            
            // Set dailyRewardAvailable - ONLY use pending rewards system
            // Backend's dailyRewardAvailable may be stale, so ignore it
            // If there's a pending daily reward → available = true
            // If no pending daily reward → available = false
            const hasPendingDaily = pendingRewardsData.some(r => r.rewardType === 'daily');
            dailyRewardAvailable = hasPendingDaily;
            
            console.log('🎁 Pending rewards check:', {
                totalPendingRewards: pendingRewardsData.length,
                hasPendingDaily: hasPendingDaily,
                dailyRewardAvailable: dailyRewardAvailable,
                allRewards: pendingRewardsData.map(r => ({ type: r.rewardType, amount: r.amount }))
            });
            
            // Load balance visibility preference
            const savedBalanceVisible = localStorage.getItem('balanceVisible_' + currentUser.email);
            if (savedBalanceVisible !== null) {
                balanceVisible = savedBalanceVisible === 'true';
            }
            
            console.log('🚀 [DEBUG] About to call requestNotificationPermission...');
            
            // Request notification permission
            requestNotificationPermission();
            
            console.log('✅ [DEBUG] requestNotificationPermission called');
            
          document.getElementById('authScreen').style.display = 'none';
           // Hide loading screen
          document.getElementById('app').style.display = 'block';
          
          // Hide splash screen after data is loaded
          const splashScreen = document.getElementById('splashScreen');
          if (splashScreen) {
              splashScreen.classList.add('fade-out');
              setTimeout(() => {
                  splashScreen.style.display = 'none';
              }, 800);
          }
          
        // keep loading until app fully ready  
            await checkMining(); // ✅ WAIT for mining check to complete
            // ✅ Only check level up if NOT called from completeMine
            if (!isCompletingMining) {
                checkLevelUp(); // Level up kontrolü ekle
            }
            checkNotifications(); // Announcement ve Airdrop notification check
            render();
            startTimer();
            
            // CRITICAL: Hide login loading and close toast after everything is ready
            if (typeof hideLoginLoading === 'function') {
                setTimeout(() => {
                    hideLoginLoading();
                    // Close any loading toasts
                    const toasts = document.querySelectorAll('.toast');
                    toasts.forEach(toast => toast.remove());
                }, 100);
            }
        } catch (error) {
            console.error('❌ initApp error:', error);
        } finally {
            // Always release lock
            isInitializing = false;
        }
        }
        

        // Check for new announcements and unclaimed airdrops
        let hamburgerPulseInterval = null;
        let hasNewAnnouncementsGlobal = false; // Global state
        let hasAirdropsGlobal = false; // Global state
        
        async function checkNotifications() {
            try {
                // Clear previous pulse interval
                if (hamburgerPulseInterval) {
                    clearInterval(hamburgerPulseInterval);
                    hamburgerPulseInterval = null;
                }
                
                const lastViewedAnnouncements = localStorage.getItem('lastViewedAnnouncements_' + currentUser.userId) || '0';
                
                // Get user's registration date for filtering
                const userCreatedAt = currentUser.createdAt;
                let userCreatedDate;
                
                if (userCreatedAt) {
                    // Handle Firestore Timestamp - convert to proper Firestore Timestamp for query
                    if (userCreatedAt._seconds) {
                        userCreatedDate = firebase.firestore.Timestamp.fromMillis(userCreatedAt._seconds * 1000);
                    } else if (typeof userCreatedAt === 'number') {
                        userCreatedDate = firebase.firestore.Timestamp.fromMillis(userCreatedAt);
                    } else if (userCreatedAt.toDate) {
                        userCreatedDate = userCreatedAt; // Already a Timestamp
                    } else {
                        userCreatedDate = firebase.firestore.Timestamp.fromDate(new Date(userCreatedAt));
                    }
                } else {
                    // If no createdAt, use current time
                    userCreatedDate = firebase.firestore.Timestamp.now();
                }
                
                // Check announcements (sent after registration OR after last viewed, whichever is later)
                const lastViewedTimestamp = firebase.firestore.Timestamp.fromMillis(parseInt(lastViewedAnnouncements));
                
                // Use the LATER of the two timestamps (most restrictive)
                const checkAfterTimestamp = userCreatedDate.toMillis() > lastViewedTimestamp.toMillis() 
                    ? userCreatedDate 
                    : lastViewedTimestamp;
                
                // ⚡ ELIGIBILITY CHECK: Only show announcements where user was registered BEFORE announcement
                const announcementsSnap = await db.collection('announcements')
                    .where('createdAt', '>', checkAfterTimestamp)
                    .where('eligibleBefore', '>', userCreatedDate)
                    .limit(1)
                    .get();
                const hasNewAnnouncements = !announcementsSnap.empty;
                
                // Check airdrops (use cache from getAllUserData)
                const hasAirdrops = (window.cachedAirdrops && window.cachedAirdrops.length > 0) || false;
                
                // Update global state
                hasNewAnnouncementsGlobal = hasNewAnnouncements;
                hasAirdropsGlobal = hasAirdrops;
                
                // Update menu items with inline styles (stronger than class)
                const announcementsMenuItem = document.getElementById('announcementsMenuItem');
                const airdropMenuItem = document.getElementById('airdropMenuItem');
                const menuButton = document.getElementById('menuButton');
                
                if (announcementsMenuItem) {
                    if (hasNewAnnouncements) {
                        announcementsMenuItem.style.border = '2px solid #10b981';
                        announcementsMenuItem.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)';
                        announcementsMenuItem.style.background = 'rgba(16, 185, 129, 0.2)';
                    } else {
                        announcementsMenuItem.style.border = '';
                        announcementsMenuItem.style.boxShadow = '';
                        announcementsMenuItem.style.background = '';
                    }
                }
                
                if (airdropMenuItem) {
                    if (hasAirdrops) {
                        airdropMenuItem.style.border = '2px solid #10b981';
                        airdropMenuItem.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)';
                        airdropMenuItem.style.background = 'rgba(16, 185, 129, 0.2)';
                    } else {
                        airdropMenuItem.style.border = '';
                        airdropMenuItem.style.boxShadow = '';
                        airdropMenuItem.style.background = '';
                    }
                }
                
                // CRITICAL: Always update hamburger button, even if menu items not in DOM
                if (menuButton) {
                    if (hasNewAnnouncements || hasAirdrops) {
                        menuButton.style.cssText = 'border: 2px solid #10b981 !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5) !important;';
                        console.log('✅ Hamburger button notification set');
                    } else {
                        menuButton.style.border = '';
                        menuButton.style.boxShadow = '';
                    }
                } else {
                    console.warn('⚠️ Menu button not found in DOM yet');
                }
            } catch (error) {
                console.error('Error checking notifications:', error);
            }
        }

        
        function calculateActiveRefs() {
            // Backend'den gelen active referrals count'u kullan
            return parseInt(localStorage.getItem('activeReferralCount_' + currentUser.email)) || 0;
        }
        
        // ============================================
        // UPDATE REFERRAL COUNTS (DISABLED - Not needed anymore)
        // Backend's activeReferralCount field is auto-updated on mining start/end
        // ============================================
        /*
        async function updateReferralCounts() {
            if (!currentUser || !currentUser.userId) return;
            
            try {
                const response = await fetch(API_ENDPOINTS.getActiveReferrals + '?userId=' + currentUser.userId, {
                    headers: getApiHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('activeReferralCount_' + currentUser.email, data.activeCount || 0);
                    localStorage.setItem('totalReferralsCount_' + currentUser.email, data.totalCount || 0);
                    
                    // UI'yi güncelle
                    d.activeRefs = data.activeCount || 0;
                    d.refs = data.totalCount || 0;
                    
                    console.log('✅ Referral counts updated:', {
                        active: data.activeCount,
                        total: data.totalCount
                    });
                }
            } catch (err) {
                console.error('Failed to update referral counts:', err);
            }
        }
        
        // ❌ REMOVED: No longer polling every 30 seconds
        // setInterval(updateReferralCounts, 30000);
        */

        function save() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const userEmail = localStorage.getItem('currentUser');
            
            if (users[userEmail]) {
                users[userEmail].balance = d.balance;
                users[userEmail].rate = (currentUser.rate || 0.25); // Save base rate only (no referral/ad session bonuses)
                users[userEmail].level = d.level;
                users[userEmail].refs = d.refs;
                users[userEmail].streak = d.streak;
                users[userEmail].lastDate = d.lastDate;
                users[userEmail].miningDays = d.miningDays;
                users[userEmail].pendingLevelUp = d.pendingLevelUp;
                users[userEmail].dailyRewardAvailable = dailyRewardAvailable;
                
                localStorage.setItem('users', JSON.stringify(users));
                currentUser = users[userEmail];
                
                // CRITICAL: Also update currentUser in localStorage to prevent balance reset
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }
        
        function getLevelProgress() {
            const currentReq = levelRequirements[d.level];
            const nextReq = levelRequirements[d.level + 1];
            
            if (!nextReq) return { progress: 100, current: d.miningDays, required: d.miningDays };
            
            const progress = ((d.miningDays - currentReq) / (nextReq - currentReq)) * 100;
            return {
                progress: Math.min(progress, 100),
                current: d.miningDays,
                required: nextReq
            };
        }
        
        async function checkLevelUp() {
            if (d.level >= 20) return;
            
            const nextReq = levelRequirements[d.level + 1];
            if (d.miningDays >= nextReq && !d.pendingLevelUp) {
                d.pendingLevelUp = d.level + 1;
                save();
                
                // Save pending level up reward
                const levelReward = levelRewards[d.level + 1];
                if (levelReward && currentUser && currentUser.userId) {
                    await addPendingReward('levelUp', levelReward.coins, {
                        level: d.level + 1,
                        miningDays: d.miningDays
                    });
                }
                
                render();
            }
        }
        
        async function claimLevelReward() {
            if (isClaimingLevel) return;
            if (!d.pendingLevelUp) return;
            
            isClaimingLevel = true;
            const claimedLevel = d.pendingLevelUp;
            
            try {
                showToast('Claiming level reward...');
                
                const response = await fetch(API_ENDPOINTS.claimLevelReward, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        level: claimedLevel
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to claim level reward');
                }
                
                const data = await response.json();
                
                // Update local data
                d.balance = data.balance;
                d.level = claimedLevel;
                d.pendingLevelUp = null;
                currentUser.balance = data.balance;
                currentUser.rate = data.rate;
                currentUser.level = claimedLevel;
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                render();
                showToast(`✓ Claimed Level ${claimedLevel} reward!`);
                
                // Reload to refresh
                await initApp();
                if (d.level < 20) checkLevelUp();
                render();
                
            } catch (error) {
                console.error('Level reward error:', error);
                showToast('Failed to claim level reward', true);
            } finally {
                isClaimingLevel = false;
            }
        }


        function fmt(s) {
            const h = Math.floor(s / 3600).toString().padStart(2, '0');
            const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return h + ':' + m + ':' + sec;
        }

        function updateWatchAdButton() {
            const container = document.getElementById('adBoostContainer');
            if (!container) return;
            
            // Don't update if locked (countdown in progress)
            const existingBtn = document.getElementById('watchAdButton');
            if (existingBtn && existingBtn.getAttribute('data-locked') === 'true') {
                return; // Skip update
            }
            
            // Wait for activeMiningSession to load
            if (!activeMiningSession) {
                return; // Skip update until session is loaded
            }
            
            // Only show if mining
            if (!d || !d.mining) {
                container.innerHTML = '';
                return;
            }
            
            // Check if AdMob is ready
            let isAdReady = false;
            if (typeof Android !== 'undefined' && typeof Android.isAdReady === 'function') {
                isAdReady = Android.isAdReady();
            }
            
            const currentRate = d.rate;
            const adCooldownKey = 'adCooldown_' + currentUser.email;
            const adCooldownEnd = parseInt(localStorage.getItem(adCooldownKey) || '0');
            const now = Date.now();
            const cooldownRemaining = Math.max(0, Math.ceil((adCooldownEnd - now) / 1000));
            const isOnCooldown = cooldownRemaining > 0;
            const adBoostCount = activeMiningSession?.adBoostCount || 0;
            const isMaxAds = adBoostCount >= 5;
            const isDisabled = isOnCooldown || isMaxAds || !isAdReady;
            
            // Calculate next reward
            let nextReward = 0;
            const nextCount = adBoostCount + 1;
            if (nextCount <= 2) {
                nextReward = 0.25;
            } else if (nextCount === 3) {
                nextReward = 0.50;
            } else if (nextCount === 4) {
                nextReward = 0.75;
            } else if (nextCount === 5) {
                nextReward = 1.00;
            }
            
            container.innerHTML = `
                <button 
                    id="watchAdButton"
                    data-locked="false"
                    onclick="${isDisabled ? '' : 'watchAdBoost()'}" 
                    style="
                        width: 100%; 
                        height: 45px; 
                        background: ${isMaxAds ? 'rgba(100, 100, 100, 0.3)' : (!isAdReady ? 'rgba(100, 100, 100, 0.2)' : (isOnCooldown ? 'rgba(0, 255, 255, 0.1)' : 'rgba(0, 255, 255, 0.15)'))}; 
                        border: 1px solid ${isMaxAds ? 'rgba(150, 150, 150, 0.3)' : (!isAdReady ? 'rgba(150, 150, 150, 0.3)' : (isOnCooldown ? 'rgba(0, 255, 255, 0.3)' : 'rgba(0, 255, 255, 0.4)'))}; 
                        border-radius: 12px; 
                        color: ${isDisabled ? 'rgba(255, 255, 255, 0.4)' : '#00ffff'}; 
                        font-size: 13px; 
                        font-weight: 700; 
                        cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        gap: 8px;
                        opacity: ${isDisabled ? '0.6' : '1'};
                    "
                    ${isDisabled ? 'disabled' : ''}
                >
                    ${isMaxAds ? 
                        `🔒 Max Ads (${adBoostCount}/5)` : 
                        (isOnCooldown ? 
                            `⏳ Wait for reward ${cooldownRemaining}s` : 
                            `📺 Watch Ad +${nextReward.toFixed(2)}/h (${adBoostCount}/5)`
                        )
                    }
                </button>
            `;
        }

        function render() {
            // Update menu username
            const menuUsername = document.getElementById('menuUsername');
            if (menuUsername) {
			 if (!currentUser) return;
                 menuUsername.textContent = currentUser.username;
            }
            
            // ✅ Ana sayfa HER ZAMAN backend'den gelen sayıyı kullanmalı (cache kullanma!)
            // d.activeRefs ve d.refs zaten initApp'te backend'den dolduruluyor
            
            // Update Watch Ad button separately (don't recreate it)
            updateWatchAdButton();
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="welcome-card">
                        <span class="welcome-text">Welcome, </span><span class="username-text">${getCountryFlag(currentUser.country || 'Turkey')} ${currentUser.username}!</span>
                    </div>
                    <button class="menu-btn" id="menuButton" onclick="toggleMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>

                <div class="card balance-card">
                    <p class="balance-label">Total</p>
                    <div class="balance-container">
                        <div class="balance-value">
                            ${balanceVisible ? d.balance.toFixed(2) : '••••••'}
                        </div>
                        <div class="balance-unit">ARCASTRA</div>
                        <button class="balance-toggle" onclick="toggleBalance()">
                            ${balanceVisible ? `
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            ` : `
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            `}
                        </button>
                    </div>
                </div>

                <div class="card ${d.mining ? 'mining-glow' : ''}" id="miningCard">
                    ${!d.mining ? `
                        <button class="btn-mine" onclick="startMine()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            Start Session
                        </button>
                    ` : `
                        <div class="timer-wrap">
                            <div class="timer-circle">
                                <svg viewBox="0 0 150 150">
                                    <circle class="timer-bg" cx="75" cy="75" r="70"/>
                                    <circle id="timerProgressCircle" class="timer-progress" cx="75" cy="75" r="70" stroke-dasharray="440" 
                                        stroke-dashoffset="${440 - ((60 - d.timeLeft) / 60) * 440}"/>
                                </svg>
                                <div class="timer-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5">
                                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                    </svg>
                                </div>
                            </div>
                            <p class="mining-active">Active</p>
                            <p id="timerTimeText" class="timer-time">${fmt(d.timeLeft)}</p>
                            <p class="timer-label">Time Remaining</p>
                            <div class="earning-box">
                                <p class="earning-text">Target: <span class="earning-amount">${(() => {
                                    const miningDuration = localStorage.getItem('miningDuration_' + currentUser.email) || 60000; // Default 1 dakika
                                    const hours = parseInt(miningDuration) / (1000 * 60 * 60);
                                    return (d.rate * hours).toFixed(2);
                                })()} <span style="font-size: 14px;">ARCASTRA</span></span></p>
                            </div>
                        </div>
                    `}
                </div>

                <!-- Ad Boost Button Container (updated separately) -->
                <div id="adBoostContainer" style="margin: 12px 0;"></div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-top">
                            <div class="stat-icon icon-blue">
                                <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                            </div>
                            <span class="stat-label">Rate</span>
                        </div>
                        <div class="stat-value">${d.rate.toFixed(2)}</div>
                        <div class="stat-unit">ARCASTRA/hour</div>
                    </div>

                    <div class="stat ${d.pendingLevelUp ? 'reward-available' : ''}">
                        ${d.pendingLevelUp ? `
                            <div style="display: flex; flex-direction: column; text-align: center; padding: 0 8px; min-height: 140px; justify-content: space-between;">
                                <div style="margin-top: 12px;">
                                    <p style="font-size: 12px; font-weight: 700; line-height: 1.3; color: white; margin-bottom: 0;">🎉 Congratulations!<br>You reached Level <span style="color: white;">${d.pendingLevelUp}!</span></p>
                                    <p style="font-size: 11px; font-weight: 600; line-height: 1.3; color: rgba(255, 255, 255, 0.6); margin-top: 6px; margin-bottom: 0;"><span style="color: #fbbf24;">+${levelRewards[d.pendingLevelUp].coins}</span> Coins earned</p>
                                    <p style="font-size: 11px; font-weight: 600; line-height: 1.3; color: rgba(255, 255, 255, 0.6); margin-top: 4px; margin-bottom: 0;"><span style="color: #00ffff;">+${levelRewards[d.pendingLevelUp].rate.toFixed(2)}</span> Mining Rate</p>
                                </div>
                                <button class="reward-claim-btn" onclick="claimLevelReward()" style="margin-top: 8px;">
                                    <span>CLAIM REWARD</span>
                                </button>
                            </div>
                        ` : `
                            <div class="stat-top">
                                <div class="stat-icon icon-purple">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
                                </div>
                                <span class="stat-label">Level</span>
                            </div>
                            <div class="stat-value">${d.level}</div>
                            <div class="stat-unit">Level</div>
                            ${d.level < 20 ? `
                                <div class="level-progress-bar">
                                    <div class="level-progress-fill" style="width: ${getLevelProgress().progress}%"></div>
                                    <div class="level-progress-text">${getLevelProgress().current}/${getLevelProgress().required} Days</div>
                                </div>
                            ` : '<div class="stat-unit" style="margin-top: 8px; color: #fbbf24;">MAX LEVEL</div>'}
                        `}
                    </div>

                    ${(d.pendingReferralEarnings && d.pendingReferralEarnings > 0) ? `
                        <div class="stat reward-available">
                            <div style="text-align: center; padding: 16px 8px 12px; position: relative; min-height: 140px;">
                                <div style="color: white; font-size: 12px; font-weight: 700; margin-bottom: 6px; line-height: 1.3;">🎉 Congratulations!<br>Referral reward earned!</div>
                                <div style="color: #fbbf24; font-size: 14px; font-weight: 700; margin-bottom: 8px; white-space: nowrap; overflow: visible;">+${d.pendingReferralEarnings} <span style="font-size: 11px; color: rgba(255, 255, 255, 0.6); font-weight: 600;">Coins</span></div>
                                <button onclick="claimReferralEarnings()" style="position: absolute; bottom: 5px; left: 8px; right: 8px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; padding: 8px; color: white; font-size: 13px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
                                    CLAIM REWARD
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="stat" onclick="event.stopPropagation(); openReferralsDirectly();" style="cursor: pointer;">
                            <div class="stat-top">
                                <div class="stat-icon icon-green">
                                    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                </div>
                                <span class="stat-label">Referrals</span>
                            </div>
                            <div class="stat-value">${d.activeRefs}/${d.refs}</div>
                            <div class="stat-unit">Active</div>
                        </div>
                    `}

                    <div class="stat ${dailyRewardAvailable ? 'reward-available' : ''}">
                        <div class="stat-top">
                            <div class="stat-icon icon-orange">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <span class="stat-label">Daily Bonus</span>
                        </div>
                        <div class="reward-card" style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 90px; padding: 15px 10px 10px 10px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 7px; margin-top: -21px; margin-bottom: 10px;">
                                <div class="reward-chest ${dailyRewardAvailable ? 'available' : 'locked'}" style="width: 50px; height: 50px;">
                                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Gift Box Base -->
                                        <rect x="20" y="45" width="60" height="40" rx="3" stroke="#00bcd4" stroke-width="3" fill="none"/>
                                        
                                        <!-- Gift Box Lid -->
                                        <path d="M 18 40 L 82 40 L 82 48 L 18 48 Z" stroke="#00bcd4" stroke-width="3" fill="none"/>
                                        
                                        <!-- Vertical Ribbon -->
                                        <line x1="50" y1="40" x2="50" y2="85" stroke="#00ffff" stroke-width="4"/>
                                        
                                        <!-- Horizontal Ribbon -->
                                        <line x1="20" y1="65" x2="80" y2="65" stroke="#00ffff" stroke-width="4"/>
                                        
                                        <!-- Bow Left -->
                                        <path d="M 35 30 Q 30 35 35 40" stroke="#00ffff" stroke-width="3" fill="none"/>
                                        <path d="M 35 30 Q 40 25 45 30" stroke="#00ffff" stroke-width="3" fill="none"/>
                                        
                                        <!-- Bow Right -->
                                        <path d="M 65 30 Q 70 35 65 40" stroke="#00ffff" stroke-width="3" fill="none"/>
                                        <path d="M 65 30 Q 60 25 55 30" stroke="#00ffff" stroke-width="3" fill="none"/>
                                        
                                        <!-- Bow Center -->
                                        <circle cx="50" cy="35" r="5" stroke="#00d4d4" stroke-width="3" fill="none"/>
                                    </svg>
                                </div>
                                ${dailyRewardAvailable ? '<div style="color: #fbbf24; font-size: 16px; font-weight: 700;">+5 <span style="font-size: 12px; color: rgba(255, 255, 255, 0.6); font-weight: 600;">Coins</span></div>' : ''}
                            </div>
                            ${dailyRewardAvailable ? `
                                <button class="reward-claim-btn" onclick="claimDailyReward()">
                                    <span>CLAIM REWARD</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    </div>

                <div class="card">
                    <div class="section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Your Referral Code
                    </div>
                    <div class="ref-compact">
                        <div class="ref-code-text">${currentUser.username}</div>
                        <button class="copy-btn" onclick="copyReferralCode()">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Social Media Links -->
                <div class="card" style="margin-top: 20px; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;">Follow Us</div>
                    </div>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <!-- Website -->
                        <!-- Website -->
                        <a href="https://arcastranetwork.io" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        </a>
                        
                        <!-- Instagram -->
                        <!-- Instagram -->
                        <a href="#" onclick="openExternalLink('https://instagram.com/arcastranetwork'); return false;" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E1306C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                            </svg>
                        </a>
                        
                        <!-- X (Twitter) -->
                        <!-- X (Twitter) -->
                        <a href="#" onclick="openExternalLink('https://x.com/arcastranetwork'); return false;" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        
                        <!-- Facebook -->
                        <!-- Facebook -->
                        <a href="#" onclick="openExternalLink('https://facebook.com/arcastranetwork'); return false;" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="#1877F2">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                        
                        <!-- YouTube -->
                        <!-- YouTube -->
                        <a href="#" onclick="openExternalLink('https://youtube.com/@arcastranetwork'); return false;" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="#FF0000">
                                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                            </svg>
                        </a>
                        
                        <!-- Telegram -->
                        <!-- Telegram -->
                        <a href="#" onclick="openExternalLink('https://t.me/arcastranetwork'); return false;" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="#0088cc">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </a>
                    </div>
                </div>

                <button class="logout-btn" onclick="logout()" style="display:none;">Logout</button>

                <div class="footer" style="display:none;">
                    <p class="footer-text">⚠️ This is a demo application. Not real cryptocurrency.</p>
                </div>
            `;
            
            // MANUAL event listener for referrals card (fix for back button issue)
            setTimeout(() => {
                const referralsCards = document.querySelectorAll('.stat');
                referralsCards.forEach(card => {
                    if (card.textContent.includes('Referrals') && card.textContent.includes('Active Mining')) {
                        if (!card.classList.contains('reward-available')) {
                            card.style.cursor = 'pointer';
                            card.onclick = function() {
                                openPage('referrals');
                            };
                        }
                    }
                });
            }, 50);
            
            // Update Watch Ad button
            updateWatchAdButton();
        }
	
        async function startMine() {
            const now = Date.now();
            const miningDuration = 1 * 60 * 1000; // 1 dakika
            const end = now + miningDuration;
            
            // OPTIMISTIC UI: Update UI IMMEDIATELY (0ms delay)
            d.mining = true;
            d.timeLeft = 60; // 1 dakika = 60 saniye
            
            const today = new Date().toDateString();
            if (d.lastDate) {
                const last = new Date(d.lastDate);
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (last.toDateString() === yesterday.toDateString()) {
                    d.streak++;
                } else if (last.toDateString() !== today) {
                    d.streak = 1;
                }
            } else {
                d.streak = 1;
            }
            d.lastDate = today;
            
            localStorage.setItem('miningEndTime_' + currentUser.email, end);
            localStorage.setItem('miningDuration_' + currentUser.email, miningDuration);
            localStorage.setItem('miningStartTime_' + currentUser.email, now);
            
            // Reset ad boost for new session
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[currentUser.email]) {
                const baseRate = 0.25;
                const levelBonus = (users[currentUser.email].level - 1) * 0.05;
                users[currentUser.email].rate = baseRate + levelBonus;
                users[currentUser.email].adBoostAmount = 0;
                localStorage.setItem('users', JSON.stringify(users));
                currentUser = users[currentUser.email];
            }
            
            // Clear ad cooldown
            localStorage.removeItem('adCooldown_' + currentUser.email);
            
            // Create temporary sessionId (will be replaced by backend's real sessionId)
            const tempSessionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('currentSessionId_' + currentUser.email, tempSessionId);
            
            // Clear referrals cache
            cachedReferralsData = null;
            cachedReferralsTimestamp = 0;
            localStorage.removeItem('referralsCache_' + currentUser.email);
            localStorage.removeItem('referralsCacheTime_' + currentUser.email);
            console.log('🔄 Referrals cache cleared - mining started');
            
            save();
            render(); // ⚡ INSTANT UPDATE!
            
            // Update Watch Ad button immediately (don't wait for backend)
            updateWatchAdButton();
            
            // Backend call in background (user won't wait for this)
            startMiningOnBackend().catch(err => {
                console.error('❌ Backend mining start failed:', err);
                // Rollback if backend fails
                d.mining = false;
                d.timeLeft = 0;
                localStorage.removeItem('miningEndTime_' + currentUser.email);
                localStorage.removeItem('miningStartTime_' + currentUser.email);
                render();
                showToast('❌ Failed to start mining. Please try again.', true);
            });
        }
async function startMiningOnBackend() {
            try {
                const response = await fetch(API_ENDPOINTS.startMining, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        level: d.level
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('currentSessionId_' + currentUser.email, data.session.sessionId);
                    
                    // Update activeMiningSession
                    activeMiningSession = {
                        sessionId: data.session.sessionId,
                        adBoostCount: 0,
                        adBoostActive: false,
                        adBoostTotal: 0
                    };
                    
                    // Update Watch Ad button
                    updateWatchAdButton();
                    
                    console.log('✓ Mining started on backend');
                } else if (response.status === 400) {
                    // Check if it's "Mining already in progress" error
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error === 'Mining already in progress' && errorData.session) {
                        // Silently use existing session - user won't notice anything
                        console.log('ℹ️ Using existing active mining session');
                        localStorage.setItem('currentSessionId_' + currentUser.email, errorData.session.sessionId);
                        
                        // Sync endTime with backend
                        const endTimeData = errorData.session.endTime;
                        const endTimeMs = endTimeData._seconds ? endTimeData._seconds * 1000 : endTimeData;
                        localStorage.setItem('miningEndTime_' + currentUser.email, endTimeMs);
                        
                        // Update activeMiningSession with existing session data
                        activeMiningSession = {
                            sessionId: errorData.session.sessionId,
                            adBoostCount: errorData.session.adBoostCount || 0,
                            adBoostActive: errorData.session.adBoostActive || false,
                            adBoostTotal: errorData.session.adBoostTotal || 0
                        };
                        
                        // Update Watch Ad button
                        updateWatchAdButton();
                    }
                }
            } catch (error) {
                console.error('Backend error:', error);
            }
        }
        async function completeMine() {
            console.log('⛏️ Mining completed - rewards already added by backend!');
            
            d.mining = false;
            d.timeLeft = 0;
            
            // ✅ Set flag to prevent initApp from showing rewards immediately
            isCompletingMining = true;
            
            // ✅ Pending daily reward oluştur (yoksa)
            const sessionId = localStorage.getItem('currentSessionId_' + currentUser.email);
            
            // Kontrol: Zaten pending daily reward var mı?
            const hasPendingDaily = pendingRewardsData.some(r => r.rewardType === 'daily' && !r.claimed);
            
            if (!hasPendingDaily) {
                try {
                    await fetch(API_ENDPOINTS.addPendingReward, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({
                            userId: currentUser.userId,
                            rewardType: 'daily',
                            amount: 5,
                            metadata: {
                                source: 'session_completion',
                                sessionId: sessionId || 'unknown'
                            }
                        })
                    });
                    console.log('✅ Pending daily reward created');
                } catch(err) {
                    console.error('❌ Failed to create pending reward:', err);
                }
            } else {
                console.log('ℹ️ Pending daily reward already exists, skipping');
            }
            
            localStorage.removeItem('miningEndTime_' + currentUser.email);
            
            // Clear referrals cache - mining status changed!
            cachedReferralsData = null;
            cachedReferralsTimestamp = 0;
            localStorage.removeItem('referralsCache_' + currentUser.email);
            localStorage.removeItem('referralsCacheTime_' + currentUser.email);
            console.log('🔄 Referrals cache cleared - mining completed');
            
            // Clear session ad boost now that mining ended
            try {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const userEmail = localStorage.getItem('currentUser');
                if (users[userEmail]) {
                    users[userEmail].adBoostAmount = 0;
                    localStorage.setItem('users', JSON.stringify(users));
                    currentUser = users[userEmail];
                }
            } catch(e) {}

            // Reload user data to get updated balance from backend
            await initApp();
            
            // Reset flag
            isCompletingMining = false;
            
            // Render to update UI (timer stopped)
            render();
            
            console.log('✅ Mining session completed - rewards will be available on next app open');
        }
        
        async function claimDailyReward() {
            // Prevent double-claiming
            if (isClaimingDaily) return;
            if (!dailyRewardAvailable) return;

            // Set lock
            isClaimingDaily = true;
            
            // ⚡ OPTIMISTIC UI - Update immediately (0ms)
            const rewardAmount = 5;
            const oldBalance = d.balance;
            d.balance += rewardAmount;
            dailyRewardAvailable = false;
            
            // Update UI instantly
            render();
            
            // Show success message immediately
            showToast('✓ Claimed +5 Coins daily reward!');

            // ⚡ PARALLEL backend calls (all at once!)
            (async () => {
                try {
                    // 🔥 ALL REQUESTS IN PARALLEL - NO WAITING!
                    const claimResponse = await fetch(API_ENDPOINTS.claimDailyReward, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({
                            userId: currentUser.userId
                        })
                    });

                    const data = await claimResponse.json().catch(() => ({}));

                    if (claimResponse.ok && data.reward) {
                        // Use backend's exact balance (no flash!)
                        d.balance = data.newBalance || d.balance;
                        currentUser.balance = d.balance;
                        
                        // Backend automatically claims pending reward ✅
                        
                        save();
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        // Wait for backend to update pending rewards
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        // Reload app to refresh pending rewards and hide button
                        await initApp();
                        render();
                    } else {
                        // Rollback on error
                        d.balance = oldBalance;
                        dailyRewardAvailable = true;
                        render();
                        
                        const errMsg = (data && data.error) ? data.error : 'Failed to claim daily reward';
                        showToast('❌ ' + errMsg, true);
                    }
                } catch (err) {
                    console.error('Daily reward failed:', err);
                    // Rollback on error
                    d.balance = oldBalance;
                    dailyRewardAvailable = true;
                    render();
                    showToast('❌ Failed to claim daily reward', true);
                } finally {
                    isClaimingDaily = false;
                }
            })();
        }

        function claimBonus() {
            if (d.streak >= 7) {
                const bonus = d.streak * 10;
                d.balance += bonus;
                save();
                showSuccess('🔥 ' + d.streak + ' day streak bonus: +' + bonus + ' Pi!');
                render();
            }
        }
        
        function toggleBalance() {
            balanceVisible = !balanceVisible;
            localStorage.setItem('balanceVisible_' + currentUser.email, balanceVisible);
            
            // ⚡ INSTANT UPDATE - Update balance text
            const balanceElement = document.querySelector('.balance-value');
            if (balanceElement) {
                balanceElement.textContent = balanceVisible 
                    ? d.balance.toFixed(2) 
                    : '••••••'; // Always 6 dots (matches toFixed(2) length better)
            }
            
            // Update eye icon - CORRECT CLASS NAME
            const eyeBtn = document.querySelector('.balance-toggle');
            if (eyeBtn) {
                eyeBtn.innerHTML = balanceVisible 
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
            }
        }
        
        async function watchAdBoost() {
            // Prevent double-clicking
            if (isWatchingAd) return;
            
            const sessionId = localStorage.getItem('currentSessionId_' + currentUser.email);
            
            if (!sessionId) {
                showToast('❌ No active session! Please start mining first.', true);
                return;
            }
            
            // Set watching flag
            isWatchingAd = true;
            adRewardEarned = false;
            
            const adStartTime = Date.now();
            // Save start time for duration calculation
            localStorage.setItem('adStartTime_' + currentUser.email, adStartTime.toString());
            
            // Show loading message
            showToast('📺 Loading ad...', false, 3000);
            
            try {
                // CHECK 1: Android Native AdMob (Priority)
                if (typeof Android !== 'undefined' && Android.showAd) {
                    console.log('✅ Android native AdMob detected');
                    
                    // Check if ad is ready
                    if (typeof Android.isAdReady === 'function' && Android.isAdReady()) {
                        console.log('📺 Showing Android native ad...');
                        Android.showAd();
                        // Android will call window.onAdRewardEarned when done
                    } else {
                        console.warn('⚠️ Android ad not ready yet');
                        showToast('❌ Ad couldn’t load. Please Disable VPN/ad blocker or try again in 5 seconds.', true);
                        isWatchingAd = false;
                    }
                    return;
                }
                
                // CHECK 2: Web AdSense (Fallback for web version)
                if (typeof adsbygoogle !== 'undefined' && window.adsbygoogle) {
                    console.log('⚠️ Web AdSense detected (not recommended for production)');
                    showToast('❌ Please use the mobile app for ads.', true);
                    isWatchingAd = false;
                    return;
                }
                
                // CHECK 3: No ad system available
                console.error('❌ No ad system available');
                showToast('❌ Ad service not available. Please update the app.', true);
                isWatchingAd = false;
                
            } catch (error) {
                console.error('❌ Ad load error:', error);
                showToast('❌ Ad couldn’t load. VPN or ad blocker must be disabled..', true);
                isWatchingAd = false;
            }
        }
        
        // Android callback: Called when user earns reward
        window.onAdRewardEarned = async function(rewardData) {
            console.log('✅ onAdRewardEarned called:', rewardData);
            
            if (rewardData && rewardData.success) {
                adRewardEarned = true; // Mark reward as earned
                
                const sessionId = localStorage.getItem('currentSessionId_' + currentUser.email);
                if (!sessionId) {
                    console.error('❌ No session found');
                    isWatchingAd = false;
                    return;
                }
                
                const adStartTime = parseInt(localStorage.getItem('adStartTime_' + currentUser.email) || '0');
                const watchDuration = Date.now() - adStartTime;
                
                console.log('⏱️ Watch duration:', watchDuration, 'ms');
                
                // Apply reward
                await applyAdReward(sessionId, watchDuration, 'admob');
            } else {
                showToast('❌ Failed to earn reward', true);
                isWatchingAd = false;
            }
        };
        
        // Android callback: Called when ad is not ready
        window.onAdNotReady = function() {
            console.warn('⚠️ onAdNotReady called');
            showToast('❌ Ad couldn’t load. Please Disable VPN/ad blocker or try again in 5 seconds.', true);
            isWatchingAd = false;
        };
        
        // Android callback: Called when ad load fails
        window.onAdLoadFailed = function(error) {
            console.error('❌ onAdLoadFailed:', error);
            showToast('❌ Ad couldn’t load. VPN or ad blocker must be disabled..', true);
            isWatchingAd = false;
        };
        
        // Android callback: Called when ad show fails
        window.onAdShowFailed = function(error) {
            console.error('❌ onAdShowFailed:', error);
            showToast('❌ Failed to show ad. Try again later.', true);
            isWatchingAd = false;
        };
        
        // Android callback: Called when ad is dismissed (user closes before completion)
        window.onAdDismissed = function(data) {
            console.log('🔴 onAdDismissed called:', data);
            
            if (!adRewardEarned) {
                showToast('❌ Ad not watched completely', true);
            }
            
            isWatchingAd = false;
        };
        
        // Helper function to close ad container (kept for compatibility)
        function closeAdContainer() {
            const container = document.getElementById('rewarded-ad-container');
            if (container) container.remove();
            
            if (!adRewardEarned) {
                showToast('❌ Watch the full ad to earn reward', true);
                isWatchingAd = false;
            }
        }
        
        // Test mode function
        
        // Apply ad reward function
        async function applyAdReward(sessionId, watchDuration, adProvider) {
            // Reset watching flag immediately
            isWatchingAd = false;
            
            const btn = document.getElementById('watchAdButton');
            if (btn) btn.setAttribute('data-locked', 'true');
            
            // Start cooldown
            const cooldownEnd = Date.now() + 15000;
            localStorage.setItem('adCooldown_' + currentUser.email, cooldownEnd.toString());
            
            // Button countdown
            const updateButton = () => {
                const btn = document.getElementById('watchAdButton');
                if (!btn || btn.getAttribute('data-locked') !== 'true') return;
                
                const now = Date.now();
                const remaining = Math.max(0, Math.ceil((cooldownEnd - now) / 1000));
                
                if (remaining > 0) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                    btn.style.background = 'rgba(0, 255, 255, 0.1)';
                    btn.style.border = '1px solid rgba(0, 255, 255, 0.3)';
                    btn.style.color = 'rgba(255, 255, 255, 0.4)';
                    btn.textContent = `⏳ Cooldown ${remaining}s`;
                }
            };
            
            updateButton();
            const countdownInterval = setInterval(updateButton, 1000);
            
            // Send to backend
            try {
                const response = await fetch(API_ENDPOINTS.applyAdBoost, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ 
                        sessionId: sessionId,
                        watchDuration: watchDuration,
                        adProvider: adProvider
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`✅ +${data.thisReward.toFixed(2)}/h boost earned!`, false, 3000);
                    console.log('✅ Ad boost applied successfully');
                    
                    // Refresh data
                    await initApp();
                } else {
                    showToast(`❌ ${data.error || 'Failed to apply boost'}`, true);
                }
            } catch (error) {
                console.error('❌ Backend error:', error);
                showToast('❌ Failed to apply boost', true);
            }
            
            // Unlock button after 45s
            setTimeout(() => {
                clearInterval(countdownInterval);
                const btn = document.getElementById('watchAdButton');
                if (btn) btn.setAttribute('data-locked', 'false');
                updateWatchAdButton();
            }, 15000);
        }

        async function checkMining() {
            const end = localStorage.getItem('miningEndTime_' + currentUser.email);
            if (end) {
                const now = Date.now();
                const endTime = parseInt(end);
                if (now < endTime) {
                    d.mining = true;
                    d.timeLeft = Math.floor((endTime - now) / 1000);
                } else {
                    // Mining completed - reload data to get daily reward
                    await completeMineOnStartup();
                }
            }
        }
        
        // Special version for startup (doesn't call completeMine twice)
        async function completeMineOnStartup() {
            console.log('⛏️ Mining completed on startup - reloading data...');
            
            d.mining = false;
            d.timeLeft = 0;
            
            // ✅ Pending daily reward oluştur (yoksa)
            const sessionId = localStorage.getItem('currentSessionId_' + currentUser.email);
            
            // Kontrol: Zaten pending daily reward var mı?
            const hasPendingDaily = pendingRewardsData.some(r => r.rewardType === 'daily' && !r.claimed);
            
            if (!hasPendingDaily) {
                try {
                    await fetch(API_ENDPOINTS.addPendingReward, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({
                            userId: currentUser.userId,
                            rewardType: 'daily',
                            amount: 5,
                            metadata: {
                                source: 'session_completion_startup',
                                sessionId: sessionId || 'unknown'
                            }
                        })
                    });
                    console.log('✅ Pending daily reward created on startup');
                } catch(err) {
                    console.error('❌ Failed to create pending reward on startup:', err);
                }
            } else {
                console.log('ℹ️ Pending daily reward already exists, skipping');
            }
            
            localStorage.removeItem('miningEndTime_' + currentUser.email);
            
            // Clear referrals cache
            cachedReferralsData = null;
            cachedReferralsTimestamp = 0;
            localStorage.removeItem('referralsCache_' + currentUser.email);
            localStorage.removeItem('referralsCacheTime_' + currentUser.email);
            
            // Clear ad boost
            try {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const userEmail = localStorage.getItem('currentUser');
                if (users[userEmail]) {
                    users[userEmail].adBoostAmount = 0;
                    localStorage.setItem('users', JSON.stringify(users));
                    currentUser = users[userEmail];
                }
            } catch(e) {}

            // Reload user data (this will fetch daily reward if available)
            await initApp();
            
            // ✅ Daily reward'ı aktif et
            dailyRewardAvailable = true;
            
            // ✅ Level kontrolü yap (miningDays arttı, level up olmuş olabilir)
            await checkLevelUp();
            
            render();
            
            console.log('✅ Daily reward activated on startup');
        }

        let timerStarted = false;
        
        // ⚡ OPTIMIZED: Partial timer update - no full render
        function updateTimerOnly() {
            const timerText = document.getElementById('timerTimeText');
            const progressCircle = document.getElementById('timerProgressCircle');
            
            if (timerText) {
                timerText.textContent = fmt(d.timeLeft);
            }
            
            if (progressCircle) {
                const offset = 440 - ((60 - d.timeLeft) / 60) * 440;
                progressCircle.setAttribute('stroke-dashoffset', offset);
            }
        }
        
        function startTimer() {
            if (timerStarted) return; // Prevent multiple timers
            timerStarted = true;
            
            setInterval(function() {
                if (d.mining && d.timeLeft > 0) {
                    d.timeLeft--;
                    if (d.timeLeft <= 0) {
                        completeMine();
                    } else {
                        // ⚡ OPTIMIZED: Only update timer elements, not full render
                        updateTimerOnly();
                    }
                }
                
                // Update Watch Ad button every second to check if ad is ready
                updateWatchAdButton();
                
                // Update active referrals count every 10 seconds
                if (Date.now() % 10000 < 1000) {
                    d.activeRefs = calculateActiveRefs();
                }
            }, 1000);
        }
        
        function createParticles() {
            // Disabled for performance
        }
        
        function toggleMenu() {
            const sidebar = document.getElementById('menuSidebar');
            const overlay = document.getElementById('menuOverlay');
            const isOpening = !sidebar.classList.contains('open');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            
            // Prevent background scrolling when menu is open
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
                
                // Apply notification styling to menu items when menu opens
                setTimeout(() => {
                    const announcementsMenuItem = document.getElementById('announcementsMenuItem');
                    const airdropMenuItem = document.getElementById('airdropMenuItem');
                    
                    if (announcementsMenuItem && hasNewAnnouncementsGlobal) {
                        announcementsMenuItem.style.border = '2px solid #10b981';
                        announcementsMenuItem.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)';
                        announcementsMenuItem.style.background = 'rgba(16, 185, 129, 0.2)';
                    }
                    
                    if (airdropMenuItem && hasAirdropsGlobal) {
                        airdropMenuItem.style.border = '2px solid #10b981';
                        airdropMenuItem.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)';
                        airdropMenuItem.style.background = 'rgba(16, 185, 129, 0.2)';
                    }
                }, 100); // Small delay to ensure menu items are in DOM
                
                // Clear hamburger highlight when menu opens
                const menuButton = document.getElementById('menuButton');
                if (menuButton) {
                    menuButton.style.border = '';
                    menuButton.style.boxShadow = '';
                }
                
                // Push state for back button handling
                try {
                    history.pushState({ menu: 'open' }, '', '#menu');
                } catch(e) {
                    // History API not available
                }
            } else {
                document.body.style.overflow = 'auto';
                
                // Remove hash when closing
                try {
                    if (window.location.hash === '#menu') {
                        history.replaceState(null, '', window.location.pathname);
                    }
                } catch(e) {
                    // History API not available
                }
            }
        }
        
        function showProfile() {
            toggleMenu();
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileHandle').textContent = '@' + currentUser.username;
            
            // Personal information
            document.getElementById('inputFullName').value = d.fullName || '';
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('inputBirthDate').value = d.birthDate || '';
            document.getElementById('inputCountry').value = d.country || '';
            
            // Reset edit mode
            document.getElementById('inputFullName').disabled = true;
            document.getElementById('inputBirthDate').disabled = true;
            document.getElementById('inputCountry').disabled = true;
            document.getElementById('saveInfoBtn').style.display = 'none';
            document.getElementById('editInfoBtn').style.display = 'block';
            
            document.getElementById('profileModal').classList.add('show');
        }
        
        function toggleEditInfo() {
            const inputs = [
                document.getElementById('inputFullName'),
                document.getElementById('inputBirthDate'),
                document.getElementById('inputCountry')
            ];
            
            const isDisabled = inputs[0].disabled;
            
            inputs.forEach(input => input.disabled = !isDisabled);
            
            // Hide error when entering edit mode
            if (isDisabled) {
                document.getElementById('birthDateError').style.display = 'none';
            }
            
            document.getElementById('saveInfoBtn').style.display = isDisabled ? 'block' : 'none';
            document.getElementById('editInfoBtn').style.display = isDisabled ? 'none' : 'block';
        }
        
        function savePersonalInfo() {
            d.fullName = document.getElementById('inputFullName').value;
            d.birthDate = document.getElementById('inputBirthDate').value;
            d.country = document.getElementById('inputCountry').value;
            
            // Validate birth date DD/MM/YYYY
            if (d.birthDate) {
                var parts = d.birthDate.split('/');
                if (parts.length !== 3) {
                    document.getElementById('birthDateError').innerHTML = '⚠️ Please use DD/MM/YYYY format';
                    document.getElementById('birthDateError').style.display = 'block';
                    return;
                }
                var year = parseInt(parts[2]);
                if (year < 1923 || year > 2007) {
                    document.getElementById('birthDateError').innerHTML = '⚠️ Birth year must be between 1923 and 2007';
                    document.getElementById('birthDateError').style.display = 'block';
                    return;
                }
            }
            
            // Hide error if validation passed
            document.getElementById('birthDateError').style.display = 'none';
            
            save();
            
            // Also save to users object
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[currentUser.email]) {
                users[currentUser.email].fullName = d.fullName;
                users[currentUser.email].birthDate = d.birthDate;
                users[currentUser.email].country = d.country;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Disable inputs and hide save button
            document.getElementById('inputFullName').disabled = true;
            document.getElementById('inputBirthDate').disabled = true;
            document.getElementById('inputCountry').disabled = true;
            document.getElementById('saveInfoBtn').style.display = 'none';
            document.getElementById('editInfoBtn').style.display = 'block';
            
            showToast('✓ Personal information saved successfully!');
            renderProfile();
        }
        
        function closeProfile() {
            document.getElementById('profileModal').classList.remove('show');
        }
        
        function uploadAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        // Resize image to 500x500
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 500;
                        canvas.height = 500;
                        
                        // Calculate crop dimensions to make it square
                        const size = Math.min(img.width, img.height);
                        const x = (img.width - size) / 2;
                        const y = (img.height - size) / 2;
                        
                        ctx.drawImage(img, x, y, size, size, 0, 0, 500, 500);
                        
                        // Smart compression - try different quality levels
                        let quality = 0.8;
                        let resizedImage = canvas.toDataURL('image/jpeg', quality);
                        let attempts = 0;
                        const maxAttempts = 5;
                        const targetSize = 204800; // 200KB in bytes
                        
                        // Keep reducing quality until under 200KB or max attempts reached
                        while (resizedImage.length * 0.75 > targetSize && attempts < maxAttempts) {
                            quality -= 0.2;
                            if (quality < 0.1) quality = 0.1;
                            resizedImage = canvas.toDataURL('image/jpeg', quality);
                            attempts++;
                        }
                        
                        // Check final size
                        const finalSize = resizedImage.length * 0.75; // Approximate bytes
                        if (finalSize > targetSize) {
                            showToast('⚠️ Image too large', true);
                            return;
                        }
                        
                        // Save to data
                        d.avatarImage = resizedImage;
                        save();
                        
                        // Update display
                        showProfile();
                        showSuccess('✓ Profile photo updated!');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        
        let profileOpenedFrom = 'modal'; // Track where profile was opened from
        
        const countries = [
            { name: 'Afghanistan', flag: '🇦🇫' },
            { name: 'Albania', flag: '🇦🇱' },
            { name: 'Algeria', flag: '🇩🇿' },
            { name: 'Argentina', flag: '🇦🇷' },
            { name: 'Australia', flag: '🇦🇺' },
            { name: 'Austria', flag: '🇦🇹' },
            { name: 'Azerbaijan', flag: '🇦🇿' },
            { name: 'Bangladesh', flag: '🇧🇩' },
            { name: 'Belgium', flag: '🇧🇪' },
            { name: 'Brazil', flag: '🇧🇷' },
            { name: 'Bulgaria', flag: '🇧🇬' },
            { name: 'Canada', flag: '🇨🇦' },
            { name: 'Chile', flag: '🇨🇱' },
            { name: 'China', flag: '🇨🇳' },
            { name: 'Colombia', flag: '🇨🇴' },
            { name: 'Croatia', flag: '🇭🇷' },
            { name: 'Czech Republic', flag: '🇨🇿' },
            { name: 'Denmark', flag: '🇩🇰' },
            { name: 'Egypt', flag: '🇪🇬' },
            { name: 'Finland', flag: '🇫🇮' },
            { name: 'France', flag: '🇫🇷' },
            { name: 'Germany', flag: '🇩🇪' },
            { name: 'Greece', flag: '🇬🇷' },
            { name: 'Hungary', flag: '🇭🇺' },
            { name: 'Iceland', flag: '🇮🇸' },
            { name: 'India', flag: '🇮🇳' },
            { name: 'Indonesia', flag: '🇮🇩' },
            { name: 'Iran', flag: '🇮🇷' },
            { name: 'Iraq', flag: '🇮🇶' },
            { name: 'Ireland', flag: '🇮🇪' },
            { name: 'Israel', flag: '🇮🇱' },
            { name: 'Italy', flag: '🇮🇹' },
            { name: 'Japan', flag: '🇯🇵' },
            { name: 'Jordan', flag: '🇯🇴' },
            { name: 'Kazakhstan', flag: '🇰🇿' },
            { name: 'Kenya', flag: '🇰🇪' },
            { name: 'Kuwait', flag: '🇰🇼' },
            { name: 'Lebanon', flag: '🇱🇧' },
            { name: 'Libya', flag: '🇱🇾' },
            { name: 'Malaysia', flag: '🇲🇾' },
            { name: 'Mexico', flag: '🇲🇽' },
            { name: 'Morocco', flag: '🇲🇦' },
            { name: 'Netherlands', flag: '🇳🇱' },
            { name: 'New Zealand', flag: '🇳🇿' },
            { name: 'Nigeria', flag: '🇳🇬' },
            { name: 'Norway', flag: '🇳🇴' },
            { name: 'Pakistan', flag: '🇵🇰' },
            { name: 'Philippines', flag: '🇵🇭' },
            { name: 'Poland', flag: '🇵🇱' },
            { name: 'Portugal', flag: '🇵🇹' },
            { name: 'Qatar', flag: '🇶🇦' },
            { name: 'Romania', flag: '🇷🇴' },
            { name: 'Russia', flag: '🇷🇺' },
            { name: 'Saudi Arabia', flag: '🇸🇦' },
            { name: 'Serbia', flag: '🇷🇸' },
            { name: 'Singapore', flag: '🇸🇬' },
            { name: 'South Africa', flag: '🇿🇦' },
            { name: 'South Korea', flag: '🇰🇷' },
            { name: 'Spain', flag: '🇪🇸' },
            { name: 'Sweden', flag: '🇸🇪' },
            { name: 'Switzerland', flag: '🇨🇭' },
            { name: 'Syria', flag: '🇸🇾' },
            { name: 'Taiwan', flag: '🇹🇼' },
            { name: 'Thailand', flag: '🇹🇭' },
            { name: 'Tunisia', flag: '🇹🇳' },
            { name: 'Turkey', flag: '🇹🇷' },
            { name: 'Ukraine', flag: '🇺🇦' },
            { name: 'United Arab Emirates', flag: '🇦🇪' },
            { name: 'United Kingdom', flag: '🇬🇧' },
            { name: 'United States', flag: '🇺🇸' },
            { name: 'Uzbekistan', flag: '🇺🇿' },
            { name: 'Venezuela', flag: '🇻🇪' },
            { name: 'Vietnam', flag: '🇻🇳' }
        ];
        
        function getCountryFlag(countryName) {
            const country = countries.find(c => c.name === countryName);
            return country ? country.flag : '🌍';
        }
        
        function showCountryDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (input.disabled) return;
            
            // Populate dropdown
            dropdown.innerHTML = countries.map(country => 
                `<div class="country-option" onclick="selectCountry('${country.name}', '${inputId}', '${dropdownId}')">${country.flag} ${country.name}</div>`
            ).join('');
            
            dropdown.classList.add('show');
        }
        
        function filterCountries(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const filter = input.value.toLowerCase();
            
            if (!filter) {
                showCountryDropdown(inputId, dropdownId);
                return;
            }
            
            const filtered = countries.filter(country => 
                country.name.toLowerCase().includes(filter)
            );
            
            if (filtered.length > 0) {
                dropdown.innerHTML = filtered.map(country => 
                    `<div class="country-option" onclick="selectCountry('${country.name}', '${inputId}', '${dropdownId}')">${country.flag} ${country.name}</div>`
                ).join('');
                dropdown.classList.add('show');
            } else {
                dropdown.classList.remove('show');
            }
        }
        
        function selectCountry(country, inputId, dropdownId) {
            const input = document.getElementById(inputId);
            input.value = country;
            input.dataset.validCountry = 'true';
            document.getElementById(dropdownId).classList.remove('show');
        }
        
        function validateCountryInput(inputId) {
            const input = document.getElementById(inputId);
            const inputValue = input.value.trim();
            
            // Check if the entered value is in the countries list
            const isValid = countries.some(country => 
                country.name.toLowerCase() === inputValue.toLowerCase()
            );
            
            if (!isValid && inputValue !== '') {
                input.value = '';
                input.dataset.validCountry = 'false';
                return false;
            }
            
            input.dataset.validCountry = isValid ? 'true' : 'false';
            return isValid;
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.country-dropdown')) {
                document.querySelectorAll('.country-dropdown-list').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });
        
        function showChangeEmail() {
            // Remember where we came from
            if (document.getElementById('fullPage').classList.contains('active')) {
                profileOpenedFrom = 'fullpage';
            } else {
                profileOpenedFrom = 'modal';
            }
            document.getElementById('changeEmailModal').classList.add('show');
            
            // Push state for back button
            try {
                history.pushState({ modal: 'changeEmail' }, '', '#change-email');
            } catch(e) {}
        }
        
        function closeChangeEmail() {
            document.getElementById('changeEmailModal').classList.remove('show');
            document.getElementById('newEmail').value = '';
            document.getElementById('emailPassword').value = '';
            
            // Return to where we came from
            if (profileOpenedFrom === 'fullpage') {
                openPage('profile');
            } else {
                document.getElementById('profileModal').classList.add('show');
            }
        }
        
        function changeEmail() {
            const newEmail = document.getElementById('newEmail').value;
            const password = document.getElementById('emailPassword').value;
            
            if (!newEmail || !password) {
                showToast('❌ Fill all fields', true);
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[currentUser.email].password !== password) {
                showToast('❌ Wrong password', true);
                return;
            }
            
            if (users[newEmail]) {
                showToast('❌ Email exists', true);
                return;
            }
            
            users[newEmail] = users[currentUser.email];
            users[newEmail].email = newEmail;
            delete users[currentUser.email];
            
            localStorage.setItem('users', JSON.stringify(users));
            currentUser.email = newEmail;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            closeChangeEmail();
            showToast('✓ Email changed successfully!');
        }
        
        function showChangePassword() {
            // Remember where we came from
            if (document.getElementById('fullPage').classList.contains('active')) {
                profileOpenedFrom = 'fullpage';
            } else {
                profileOpenedFrom = 'modal';
            }
            document.getElementById('changePasswordModal').classList.add('show');
            
            // Push state for back button
            try {
                history.pushState({ modal: 'changePassword' }, '', '#change-password');
            } catch(e) {}
        }
        
        function closeChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('show');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Return to where we came from
            if (profileOpenedFrom === 'fullpage') {
                openPage('profile');
            } else {
                document.getElementById('profileModal').classList.add('show');
            }
        }
        
        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            
            if (!currentPwd || !newPwd || !confirmPwd) {
                showToast('❌ Fill all fields', true);
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showToast('❌ Passwords don\'t match', true);
                return;
            }
            
            if (newPwd.length < 6) {
                showToast('❌ Password min 6 chars', true);
                return;
            }
            
            try {
                const response = await fetch(API_ENDPOINTS.updatePassword, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        newPassword: newPwd
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeChangePassword();
                    showToast('✓ Password changed!');
                } else {
                    showToast(`❌ ${data.error || 'Failed'}`, true);
                }
            } catch (error) {
                console.error('Change password error:', error);
                showToast('❌ Failed to change password', true);
            }
        }

        
        function shareProfile() {
            const shareText = `Arc Astra is a community-driven digital ecosystem where individual users can participate through mining. By joining the ecosystem with my referral code, you can earn 10 ARC ASTRA and start mining as part of this growing network.\n\nDetails: arcastranetwork.io\nMy Referral Code: ${currentUser.referralCode}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join Arc Astra',
                    text: shareText
                }).catch(() => {
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('✓ Profile info copied to clipboard!');
            }).catch(() => {
                showToast('✓ Share: ' + text);
            });
        }
        
        function copyProfileLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showToast('✓ Profile link copied!');
            });
        }
        
        function showDeleteAccount() {
            // Remember where we came from
            if (document.getElementById('fullPage').classList.contains('active')) {
                profileOpenedFrom = 'fullpage';
            } else {
                profileOpenedFrom = 'modal';
            }
            document.getElementById('deleteError').style.display = 'none';
            document.getElementById('deleteAccountModal').classList.add('show');
            
            // Push state for back button
            try {
                history.pushState({ modal: 'deleteAccount' }, '', '#delete-account');
            } catch(e) {}
        }
        
        function closeDeleteAccount() {
            document.getElementById('deleteAccountModal').classList.remove('show');
            document.getElementById('deletePassword').value = '';
            document.getElementById('deleteError').style.display = 'none';
            
            // Return to where we came from
            if (profileOpenedFrom === 'fullpage') {
                openPage('profile');
            } else {
                document.getElementById('profileModal').classList.add('show');
            }
        }
        
        function showDeleteError(message) {
            document.getElementById('deleteErrorText').textContent = message;
            document.getElementById('deleteError').style.display = 'block';
        }
        
        function confirmDeleteAccount() {
            const password = document.getElementById('deletePassword').value;
            
            if (!password) {
                showDeleteError('Please enter your password');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[currentUser.email].password !== password) {
                showDeleteError('Incorrect password');
                return;
            }
            
            // Password correct - delete account
            deleteAccount();
        }
        
        async function deleteAccount() {
            try {
                const response = await fetch(API_ENDPOINTS.deleteAccount, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        userId: currentUser.userId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Clear local data
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('currentSessionId_' + currentUser.email);
                    
                    // Close delete modal
                    document.getElementById('deleteAccountModal').classList.remove('show');
                    
                    // Show goodbye modal
                    document.getElementById('goodbyeModal').classList.add('show');
                } else {
                    showToast(`❌ ${data.error || 'Failed to delete account'}`, true);
                }
            } catch (error) {
                console.error('Delete account error:', error);
                showToast('❌ Failed to delete account', true);
            }
        }

        
        function viewRoadmap() {
            window.open('https://arcastranetwork.io/', '_blank');
        }
        
        function viewWhitepaper() {
            window.open('https://arcastranetwork.io/', '_blank');
        }
        
        function openPage(page) {
            // Push state FIRST for immediate back button response
            try {
                history.pushState({ page: page }, '', '#' + page);
            } catch(e) {
                // History API not available or restricted - use hash fallback
                window.location.hash = page;
            }
            
            toggleMenu();
            
            const fullPage = document.getElementById('fullPage');
            const pageTitle = document.getElementById('fullPageTitle');
            const pageContent = document.getElementById('fullPageContent');
            
            // Show page IMMEDIATELY
            fullPage.classList.add('active');
            fullPage.dataset.currentPage = page;
            
            switch(page) {
                case 'profile':
                    pageTitle.textContent = 'Profile';
                    pageContent.innerHTML = getProfilePageContent();
                    break;
                case 'upgrades':
                    pageTitle.textContent = 'Upgrades / Boosts';
                    pageContent.innerHTML = getUpgradesPageContent();
                    // Render buttons and start timer
                    setTimeout(() => {
                        renderSpeedBoostButton();
                        startBoostButtonUpdates();
                    }, 0);
                    break;
                case 'tasks':
                    pageTitle.textContent = 'Tasks';
                    pageContent.innerHTML = getTasksPageContent();
                    break;
                case 'announcements':
                    pageTitle.textContent = 'Announcements';
                    pageContent.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #00d4ff;">Loading...</div>';
                    getAnnouncementsPageContent().then(html => { pageContent.innerHTML = html; });
                    
                    // Save last viewed timestamp
                    localStorage.setItem('lastViewedAnnouncements_' + currentUser.userId, Date.now().toString());
                    
                    // Clear notification flag
                    localStorage.removeItem('hasNewAnnouncements_' + currentUser.userId);
                    
                    // Clear styles immediately
                    const announcementsMenuItem = document.getElementById('announcementsMenuItem');
                    if (announcementsMenuItem) {
                        announcementsMenuItem.style.border = '';
                        announcementsMenuItem.style.boxShadow = '';
                        announcementsMenuItem.style.background = '';
                    }
                    checkNotifications(); // Recheck to update hamburger
                    break;
                case 'airdrop':
                    pageTitle.textContent = 'Events';
                    pageContent.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #00d4ff;">Loading...</div>';
                    getAirdropPageContent().then(html => { pageContent.innerHTML = html; });
                    
                    // Clear notification flag
                    localStorage.removeItem('hasNewAirdrops_' + currentUser.userId);
                    
                    // Clear styles immediately
                    const airdropMenuItem = document.getElementById('airdropMenuItem');
                    if (airdropMenuItem) {
                        airdropMenuItem.style.border = '';
                        airdropMenuItem.style.boxShadow = '';
                        airdropMenuItem.style.background = '';
                    }
                    checkNotifications(); // Recheck to update hamburger
                    break;
                case 'leaderboard':
                    pageTitle.textContent = 'Leaderboard';
                    // Show loading skeleton immediately
                    pageContent.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 400px; padding: 20px;">
                            <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(0, 255, 255, 0.4); border-radius: 20px; padding: 40px 30px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2);">
                                <div style="width: 60px; height: 60px; border: 3px solid rgba(0, 255, 255, 0.3); border-top-color: #00ffff; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                                <h3 style="color: #00ffff; font-size: 18px; font-weight: 700; margin-bottom: 8px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Loading Leaderboard</h3>
                                <p style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin: 0;"></p>
                            </div>
                        </div>
                        <style>
                            @keyframes spin {
                                to { transform: rotate(360deg); }
                            }
                        
        .days-badge {
            min-width: 9ch;
            max-width: 9ch;
            text-align: center;
            white-space: nowrap;
            font-size: 10px;
            font-weight: 700;
            line-height: 1;
        }
        
/* === PRO LOADING SCREEN === */
#loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;

}

.loading-card {
    background: rgba(10,20,40,0.85);
    border-radius: 24px;
    padding: 40px 32px;
    border: 2px solid transparent;
    background:
      linear-gradient(rgba(10,20,40,0.85), rgba(10,20,40,0.85)) padding-box,
      linear-gradient(145deg, rgba(0,255,255,0.4), rgba(123,67,255,0.4)) border-box;
    box-shadow: 0 0 40px rgba(0,255,255,0.25);
    text-align: center;
}

.loading-spinner {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 4px solid rgba(0,255,255,0.15);
    border-top-color: #00ffff;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

.loading-text {
    color: #c4b5fd;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
}


/* === AUTH LOGO & SPLASH FIX (MOBILE SAFE) === */
.auth-logo {
  width: 140px;
  height: 140px;
  margin: 0 auto 24px auto;
  background-image: url('assets/auth-logo.webp');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.auth-splash {
  width: 100%;
  height: 220px;
  background-image: url('assets/splash-image.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 20px;
}


/* === BALANCE ICON FINAL FIX === */
.balance-icon {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  border: 0.3px solid #00d9ff;
  border-radius: 4px;
  padding: 2px;
  margin: 4px 0;
  display: inline-block;
}

</style>
        
                    `;
                    // Load content asynchronously
                    getLeaderboardPageContent().then(html => pageContent.innerHTML = html);
                    break;
                case 'referrals':
                    pageTitle.textContent = 'My Referrals';
                    // Show loading skeleton immediately
                    pageContent.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 400px; padding: 20px;">
                            <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(0, 255, 255, 0.4); border-radius: 20px; padding: 40px 30px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2);">
                                <div style="width: 60px; height: 60px; border: 3px solid rgba(0, 255, 255, 0.3); border-top-color: #00ffff; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                                <h3 style="color: #00ffff; font-size: 18px; font-weight: 700; margin-bottom: 8px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Loading Referrals</h3>
                                <p style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin: 0;"></p>
                            </div>
                        </div>
                        <style>
                            @keyframes spin {
                                to { transform: rotate(360deg); }
                            }
                        
        .days-badge {
            min-width: 9ch;
            max-width: 9ch;
            text-align: center;
            white-space: nowrap;
            font-size: 10px;
            font-weight: 700;
            line-height: 1;
        }
        
/* === PRO LOADING SCREEN === */
#loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}

.loading-card {
    background: rgba(10,20,40,0.85);
    border-radius: 24px;
    padding: 40px 32px;
    border: 2px solid transparent;
    background:
      linear-gradient(rgba(10,20,40,0.85), rgba(10,20,40,0.85)) padding-box,
      linear-gradient(145deg, rgba(0,255,255,0.4), rgba(123,67,255,0.4)) border-box;
    box-shadow: 0 0 40px rgba(0,255,255,0.25);
    text-align: center;
}

.loading-spinner {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 4px solid rgba(0,255,255,0.15);
    border-top-color: #00ffff;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

.loading-text {
    color: #c4b5fd;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
}


/* === AUTH LOGO & SPLASH FIX (MOBILE SAFE) === */
.auth-logo {
  width: 140px;
  height: 140px;
  margin: 0 auto 24px auto;
  background-image: url('assets/auth-logo.webp');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.auth-splash {
  width: 100%;
  height: 220px;
  background-image: url('assets/splash-image.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 20px;
}


/* === BALANCE ICON FINAL FIX === */
.balance-icon {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  border: 0.3px solid #00d9ff;
  border-radius: 4px;
  padding: 2px;
  margin: 4px 0;
  display: inline-block;
}

</style>
        
                    `;
                    // Load content asynchronously
                    getReferralsPageContent().then(html => pageContent.innerHTML = html);
                    break;
                case 'menu2':
                    pageTitle.textContent = 'Menü 2';
                    pageContent.innerHTML = '<div class="card"><h2 style="color: white; text-align: center;">Menü 2 İçeriği</h2><p style="color: #c4b5fd; text-align: center; margin-top: 10px;">Bu sayfa için içerik yakında eklenecek.</p></div>';
                    break;
                case 'menu3':
                    pageTitle.textContent = 'Menü 3';
                    pageContent.innerHTML = '<div class="card"><h2 style="color: white; text-align: center;">Menü 3 İçeriği</h2><p style="color: #c4b5fd; text-align: center; margin-top: 10px;">Bu sayfa için içerik yakında eklenecek.</p></div>';
                    break;
                case 'menu4':
                    pageTitle.textContent = 'Menü 4';
                    pageContent.innerHTML = '<div class="card"><h2 style="color: white; text-align: center;">Menü 4 İçeriği</h2><p style="color: #c4b5fd; text-align: center; margin-top: 10px;">Bu sayfa için içerik yakında eklenecek.</p></div>';
                    break;
                case 'settings':
                    pageTitle.textContent = 'Settings';
                    pageContent.innerHTML = getSettingsPageContent();
                    break;
                case 'menu5':
                    pageTitle.textContent = 'Menü 5';
                    pageContent.innerHTML = '<div class="card"><h2 style="color: white; text-align: center;">Menü 5 İçeriği</h2><p style="color: #c4b5fd; text-align: center; margin-top: 10px;">Bu sayfa için içerik yakında eklenecek.</p></div>';
                    break;
                case 'menu6':
                    pageTitle.textContent = 'Menü 6';
                    pageContent.innerHTML = '<div class="card"><h2 style="color: white; text-align: center;">Menü 6 İçeriği</h2><p style="color: #c4b5fd; text-align: center; margin-top: 10px;">Bu sayfa için içerik yakında eklenecek.</p></div>';
                    break;
            }
        }
        
        function closePage() {
            const fullPage = document.getElementById('fullPage');
            const sidebar = document.getElementById('menuSidebar');
            const menuOverlay = document.getElementById('menuOverlay');
            
            // Stop boost button updates
            stopBoostButtonUpdates();
            
            // Close full page
            fullPage.classList.remove('active');
            fullPage.dataset.currentPage = '';
            
            // Close menu if open
            if (sidebar) sidebar.classList.remove('open');
            if (menuOverlay) menuOverlay.classList.remove('show');
            document.body.style.overflow = 'auto';
            
            // Replace state to remove hash (with error handling)
            try {
                if (window.location.hash) {
                    history.replaceState({ page: 'main' }, '', window.location.pathname);
                }
            } catch(e) {
                // History API not available or restricted
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            // If already in DD/MM/YYYY format, return as is
            if (dateString.includes('/')) {
                return dateString;
            }
            // If in YYYY-MM-DD format (old data), convert to DD/MM/YYYY
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function getSettingsPageContent() {
            // Get current settings from localStorage
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
            const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
            const autoMiningEnabled = localStorage.getItem('autoMiningEnabled') === 'true';
            const language = localStorage.getItem('language') || 'en';
            const theme = localStorage.getItem('theme') || 'dark';
            
            return `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    
                    <!-- General Settings -->
                    <div>
                        <div style="font-size: 14px; color: #8b5cf6; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">General</div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: white; font-weight: 700; font-size: 15px; margin-bottom: 4px;">Language</div>
                                    <div style="color: #8b5cf6; font-size: 13px;">Application language</div>
                                </div>
                                <div style="background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; padding: 8px 12px; color: white; font-weight: 600;">
                                    English
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Notifications -->
                    <div>
                        <div style="font-size: 14px; color: #8b5cf6; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Notifications</div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: white; font-weight: 700; font-size: 15px; margin-bottom: 4px;">Push Notifications</div>
                                    <div style="color: #8b5cf6; font-size: 13px;">Get notified about important updates</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="notificationsToggle" ${notificationsEnabled ? 'checked' : ''} onchange="toggleNotifications(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- About -->
                    <div>
                        <div style="font-size: 14px; color: #8b5cf6; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">About</div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; text-align: center;">
                            <div style="color: white; font-weight: 800; font-size: 18px; margin-bottom: 8px;">Arc Astra</div>
                            <div style="color: #8b5cf6; font-size: 13px; margin-bottom: 4px;">Version 1.0.0</div>
                            <div style="color: #666; font-size: 12px;">© 2024 Arc Astra. All rights reserved.</div>
                        </div>
                    </div>
                    
                </div>
            `;
        }
        
        
        
        function toggleNotifications(enabled) {
            localStorage.setItem('notificationsEnabled', enabled);
            showToast(enabled ? '🔔 Notifications enabled' : '🔕 Notifications disabled');
        }
        
        async function getAnnouncementsPageContent() {
            try {
                // Get user's registration date
                const userCreatedAt = currentUser.createdAt;
                let userCreatedDate;
                
                if (userCreatedAt) {
                    // Handle Firestore Timestamp - convert to proper Firestore Timestamp for query
                    if (userCreatedAt._seconds) {
                        userCreatedDate = firebase.firestore.Timestamp.fromMillis(userCreatedAt._seconds * 1000);
                    } else if (typeof userCreatedAt === 'number') {
                        userCreatedDate = firebase.firestore.Timestamp.fromMillis(userCreatedAt);
                    } else if (userCreatedAt.toDate) {
                        userCreatedDate = userCreatedAt; // Already a Timestamp
                    } else {
                        userCreatedDate = firebase.firestore.Timestamp.fromDate(new Date(userCreatedAt));
                    }
                } else {
                    // If no createdAt, use current time
                    userCreatedDate = firebase.firestore.Timestamp.now();
                }
                
                // ⚡ ELIGIBILITY CHECK: Fetch announcements where user was registered BEFORE announcement
                const snapshot = await db.collection('announcements')
                    .where('createdAt', '>', userCreatedDate) // AFTER registration
                    .where('eligibleBefore', '>', userCreatedDate) // User registered BEFORE announcement
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    return `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 400px; padding: 20px;">
                            <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(100, 100, 100, 0.4); border-radius: 20px; padding: 40px 30px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                                <div style="background: rgba(100, 100, 100, 0.2); border: 2px solid rgba(100, 100, 100, 0.3); border-radius: 16px; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px;">📢</div>
                                <h2 style="color: rgba(255, 255, 255, 0.6); font-size: 22px; font-weight: 900; margin-bottom: 12px;">No Announcements</h2>
                                <p style="color: rgba(139, 92, 246, 0.7); font-size: 14px; line-height: 1.6;">Check back later for updates</p>
                            </div>
                        </div>
                    `;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 12px; padding: 16px;">';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const title = data.title || 'Announcement';
                    const message = data.message || '';
                    const date = data.date || '';
                    
                    html += `
                        <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">
                            <div style="color: #00ffff; font-size: 16px; font-weight: 800; margin-bottom: 10px;">${title}</div>
                            <div style="color: rgba(255, 255, 255, 0.85); font-size: 14px; line-height: 1.5; margin-bottom: 10px;">${message}</div>
                            <div style="color: rgba(139, 92, 246, 0.7); font-size: 11px; font-weight: 600;">${date}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            } catch (error) {
                console.error('Error loading announcements:', error);
                return `<div style="text-align: center; padding: 60px 20px; color: #ff6b6b;">Error loading announcements</div>`;
            }
        }





        
        function formatAnnouncementDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        async function getAirdropPageContent() {
            try {
                // Backend'den airdrops verisi gelecek (initApp'de zaten çekildi)
                // Eğer yoksa backend'e istek at
                let airdropsData = window.cachedAirdrops || null;
                let totalAmount = window.cachedTotalAirdropAmount || 0;
                
                if (!airdropsData) {
                    // Backend'den çek
                    const response = await fetch(API_ENDPOINTS.getAllUserData, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({ userId: currentUser.userId })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        airdropsData = data.airdrops || [];
                        totalAmount = data.totalAirdropAmount || 0;
                        
                        // Cache et
                        window.cachedAirdrops = airdropsData;
                        window.cachedTotalAirdropAmount = totalAmount;
                    } else {
                        airdropsData = [];
                        totalAmount = 0;
                    }
                }
                
                if (!airdropsData || airdropsData.length === 0) {
                    return `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 400px; padding: 20px;">
                            <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(100, 100, 100, 0.4); border-radius: 20px; padding: 40px 30px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                                <div style="background: rgba(100, 100, 100, 0.2); border: 2px solid rgba(100, 100, 100, 0.3); border-radius: 16px; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px;">💰</div>
                                <h2 style="color: rgba(255, 255, 255, 0.6); font-size: 22px; font-weight: 900; margin-bottom: 12px;">No Events</h2>
                                <p style="color: rgba(139, 92, 246, 0.7); font-size: 14px; line-height: 1.6;">Check back later for rewards</p>
                            </div>
                        </div>
                    `;
                }
                
                let html = `
                    <div style="padding: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3)); border: 2px solid #10b981; border-radius: 20px; padding: 24px; text-align: center; box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); margin-bottom: 20px;">
                            <svg width="64" height="64" viewBox="0 0 64 64" style="margin: 0 auto 12px; filter: drop-shadow(0 4px 12px rgba(16, 185, 129, 0.4));">
                                <rect x="8" y="24" width="48" height="32" rx="4" fill="#10b981" opacity="0.3"/>
                                <rect x="8" y="24" width="48" height="32" rx="4" fill="none" stroke="#10b981" stroke-width="2"/>
                                <path d="M8 32 L56 32" stroke="#10b981" stroke-width="2"/>
                                <rect x="28" y="24" width="8" height="32" fill="#10b981" opacity="0.5"/>
                                <path d="M32 8 Q20 8 20 16 Q20 24 32 24 Q44 24 44 16 Q44 8 32 8" fill="#059669"/>
                                <ellipse cx="32" cy="16" rx="6" ry="4" fill="#10b981"/>
                                <circle cx="20" cy="40" r="2" fill="#10b981"/>
                                <circle cx="44" cy="40" r="2" fill="#10b981"/>
                                <circle cx="20" cy="48" r="2" fill="#10b981"/>
                                <circle cx="44" cy="48" r="2" fill="#10b981"/>
                            </svg>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Airdrop</div>
                            <div style="color: white; font-size: 36px; font-weight: 900; margin-bottom: 16px;">${totalAmount.toFixed(2)} <span style="font-size: 18px; opacity: 0.8;">ARCASTRA</span></div>
                            <button onclick="claimAllAirdrops()" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 12px; padding: 14px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); text-transform: uppercase; letter-spacing: 0.5px;">
                                🎉 Claim All
                            </button>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                `;
                
                airdropsData.forEach(airdrop => {
                    const date = airdrop.createdAt ? new Date(airdrop.createdAt.toDate ? airdrop.createdAt.toDate() : airdrop.createdAt._seconds * 1000).toLocaleDateString() : 'Recent';
                    const typeLabel = airdrop.type === 'global' ? '🌍 Global' : '🎁 Personal';
                    const message = airdrop.message || 'Airdrop Reward';
                    
                    html += `
                        <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 14px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #10b981; font-size: 14px; font-weight: 700;">${typeLabel} ${message}</div>
                                <div style="color: rgba(139, 92, 246, 0.7); font-size: 11px; margin-top: 2px;">${date}</div>
                            </div>
                            <div style="color: #10b981; font-size: 18px; font-weight: 800;">+${airdrop.amount.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                return html;
            } catch (error) {
                console.error('Error loading airdrops:', error);
                return `<div style="text-align: center; padding: 60px 20px; color: #ff6b6b;">Error loading airdrops</div>`;
            }
        }


        
        function claimAirdrop(index) {
            // Prevent double-claiming
            if (isClaimingAirdrop) return;
            
            const userEmail = localStorage.getItem('currentUser');
            let users = JSON.parse(localStorage.getItem('users')) || {};
            
            if (!users[userEmail] || !users[userEmail].pendingAirdrops || !users[userEmail].pendingAirdrops[index]) {
                showToast('❌ Airdrop not found', true);
                return;
            }
            
            // Set lock
            isClaimingAirdrop = true;
            
            try {
                const airdrop = users[userEmail].pendingAirdrops[index];
                
                // Add to balance
                users[userEmail].balance = (users[userEmail].balance || 0) + airdrop.amount;
                
                // Ensure user's rate doesn't exceed 5.0 (safety check)
                const activeRefs = calculateActiveRefs();
                const currentTotalRate = (users[userEmail].rate || 0.25) + (activeRefs * 0.05);
                if (currentTotalRate > 5.0) {
                    users[userEmail].rate = Math.max(0.25, 5.0 - (activeRefs * 0.05));
                }
                
                // Remove from pending airdrops
                users[userEmail].pendingAirdrops.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('users', JSON.stringify(users));
                
                // Update current user
                currentUser = users[userEmail];
                
                // Update hasPendingAirdrops
                hasPendingAirdrops = (currentUser.pendingAirdrops && currentUser.pendingAirdrops.length > 0) || false;
                
                // Show success message
                showToast(`✓ Claimed ${airdrop.amount} Coins!`);
                
                // Refresh page content
                openPage('airdrop');
                
                // Update main screen to refresh green indicators
                render();
            } finally {
                // Release lock after delay
                setTimeout(() => {
                    isClaimingAirdrop = false;
                }, 1000);
            }
        }
        
        // Cache for leaderboard - only fetch once per app session
        let cachedLeaderboardData = null;
        
        // Format balance with K/M abbreviation
        function formatBalance(balance) {
            if (balance >= 1000000) {
                return (balance / 1000000).toFixed(2) + 'M';
            } else if (balance >= 1000) {
                return (balance / 1000).toFixed(2) + 'K';
            } else {
                return balance.toFixed(2);
            }
        }
        
        async function getLeaderboardPageContent() {
            let leaderboardData = [];
            
            try {
                // Try localStorage cache first (24 hour validity)
                const cachedData = localStorage.getItem('leaderboard_cache');
                const cacheTime = localStorage.getItem('leaderboard_cache_time');
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime)) < twentyFourHours) {
                    console.log('✅ Using localStorage cached leaderboard');
                    leaderboardData = JSON.parse(cachedData);
                } else {
                    console.log('🔄 Fetching leaderboard from backend...');
                    
                    // Fetch from backend
                    const response = await fetch(API_ENDPOINTS.getLeaderboard, {
                        headers: getApiHeaders()
                    });
                    const data = await response.json();
                    
                    if (response.ok && data.leaderboard) {
                        leaderboardData = data.leaderboard;
                        
                        // Cache to localStorage
                        localStorage.setItem('leaderboard_cache', JSON.stringify(leaderboardData));
                        localStorage.setItem('leaderboard_cache_time', Date.now().toString());
                        console.log('✅ Leaderboard cached:', leaderboardData.length, 'users');
                    }
                }
            } catch (err) {
                console.error('Failed to fetch leaderboard:', err);
            }
            
            // Find current user's rank from their user document (not from leaderboard list)
            const currentEmail = currentUser ? currentUser.email : '';
            console.log('🔍 Finding user rank:', currentEmail);
            console.log('📊 Leaderboard data:', leaderboardData.length, 'users');
            
            // Get rank from user document (set by scheduled function)
            const currentUserRank = currentUser?.leaderboardRank || 0;
            let currentUserData = leaderboardData.find(u => u.email === currentEmail);
            
            console.log('📍 User rank:', currentUserRank, '| Found in top 100:', !!currentUserData);
            
            // If user not in top 100, use currentUser data
            if (!currentUserData && currentUser) {
                console.log('ℹ️ User not in top 100, using currentUser data with rank:', currentUserRank);
                currentUserData = {
                    email: currentUser.email,
                    username: currentUser.username,
                    level: currentUser.level || 1,
                    miningDays: currentUser.miningDays || 0,
                    country: currentUser.country || 'Turkey',
                    rank: currentUserRank
                };
            }
            
            if (leaderboardData.length === 0) {
                return `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 400px; padding: 20px;">
                        <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(100, 100, 100, 0.4); border-radius: 20px; padding: 40px 30px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                            <div style="background: rgba(100, 100, 100, 0.2); border: 2px solid rgba(100, 100, 100, 0.3); border-radius: 16px; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px;">
                                🏆
                            </div>
                            <h2 style="color: rgba(255, 255, 255, 0.6); font-size: 22px; font-weight: 900; margin-bottom: 12px;">
                                No Rankings Yet
                            </h2>
                            <p style="color: rgba(139, 92, 246, 0.7); font-size: 14px; line-height: 1.6;">
                                Start Session to appear on the leaderboard!
                            </p>
                        </div>
                    </div>
                `;
            }
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="color: white; font-size: 18px; font-weight: 800;">Leaderboard</div>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 6px; padding: 4px 8px;">
                        <div style="color: rgba(255, 255, 255, 0.5); font-size: 9px; font-weight: 600; text-align: center;">Updates daily at 00:00 UTC</div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
            `;
            
            // Current user card at the top (always show)
            if (currentUserData) {
                // Calculate progress based on 365 days
                const userProgressPercent = Math.min((currentUserData.miningDays / 365) * 100, 100);
                
                html += `
                    <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 10px; padding: 10px; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <div style="color: #fbbf24; width: 30px; text-align: center; font-weight: 800; font-size: 14px;">
                                    #${currentUserRank > 0 ? currentUserRank : '—'}
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #fbbf24; font-weight: 700; font-size: 14px;">${getCountryFlag(currentUserData.country || 'Turkey')} You</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="display: flex; flex-direction: column; gap: 3px;">
                                    <!-- Balance Bar -->
                                    <div class="level-progress-bar" style="width: 70px; height: 16px; background: rgba(10, 20, 40, 0.85); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid rgba(251, 191, 36, 0.3);">
                                        <div class="level-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8px; font-weight: 700; color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);">
                                            ${formatBalance(currentUser?.balance || 0)}
                                        </div>
                                    </div>
                                    <!-- Days Bar -->
                                    <div class="level-progress-bar" style="width: 70px; height: 16px; background: rgba(10, 20, 40, 0.85); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid rgba(16, 185, 129, 0.3);">
                                        <div class="level-progress-fill" style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: ${userProgressPercent}%;"></div>
                                        <div class="level-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8px; font-weight: 700; color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);">
                                            ${currentUserData.miningDays}/365 Days
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #00ffff; font-weight: 800; font-size: 14px;">Lv ${currentUserData.level}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ⚡ OPTIMIZATION: Use array instead of string concatenation
            const userRows = [];
            
            // Top 100 list
            leaderboardData.forEach((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.email === currentEmail;
                const isMedal = rank <= 3;
                
                let medalSVG = '';
                
                if (rank === 1) {
                    // Gold Medal - 3D with shine and shadows
                    medalSVG = `<svg width="32" height="32" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                        <!-- Ribbon -->
                        <path d="M35 5 L40 35 L50 30 L60 35 L65 5 L60 8 L50 3 L40 8 Z" fill="url(#ribbon1)" stroke="#8B0000" stroke-width="0.5"/>
                        
                        <!-- Shadow under medal -->
                        <ellipse cx="50" cy="115" rx="25" ry="4" fill="#000" opacity="0.3"/>
                        
                        <!-- Outer ring - dark edge -->
                        <circle cx="50" cy="70" r="32" fill="url(#goldDark)"/>
                        
                        <!-- Main medal body -->
                        <circle cx="50" cy="70" r="28" fill="url(#goldMedal)" stroke="#B8860B" stroke-width="1.5"/>
                        
                        <!-- Inner decorative ring -->
                        <circle cx="50" cy="70" r="24" fill="none" stroke="url(#goldRing)" stroke-width="2"/>
                        
                        <!-- Center circle -->
                        <circle cx="50" cy="70" r="18" fill="url(#goldCenter)"/>
                        
                        <!-- Number 1 -->
                        <text x="50" y="80" font-family="Arial Black" font-size="24" font-weight="bold" fill="url(#goldText)" text-anchor="middle" stroke="#8B6914" stroke-width="0.5">1</text>
                        
                        <!-- Shine effect top left -->
                        <path d="M30 52 Q35 50 40 52 Q35 54 30 52" fill="#FFF" opacity="0.6"/>
                        <circle cx="32" cy="54" r="3" fill="#FFF" opacity="0.5"/>
                        
                        <!-- Bottom shadow inside -->
                        <path d="M50 88 Q35 85 30 78" fill="#000" opacity="0.2"/>
                        
                        <!-- Star decorations -->
                        <path d="M50 52 L51 55 L54 55 L52 57 L53 60 L50 58 L47 60 L48 57 L46 55 L49 55 Z" fill="#FFF" opacity="0.4"/>
                        
                        <defs>
                            <linearGradient id="ribbon1" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#DC143C"/>
                                <stop offset="100%" stop-color="#8B0000"/>
                            </linearGradient>
                            <radialGradient id="goldDark">
                                <stop offset="70%" stop-color="#DAA520"/>
                                <stop offset="100%" stop-color="#8B6914"/>
                            </radialGradient>
                            <radialGradient id="goldMedal">
                                <stop offset="0%" stop-color="#FFF8DC"/>
                                <stop offset="30%" stop-color="#FFD700"/>
                                <stop offset="70%" stop-color="#FFA500"/>
                                <stop offset="100%" stop-color="#DAA520"/>
                            </radialGradient>
                            <linearGradient id="goldRing" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#FFF8DC"/>
                                <stop offset="50%" stop-color="#DAA520"/>
                                <stop offset="100%" stop-color="#FFF8DC"/>
                            </linearGradient>
                            <radialGradient id="goldCenter">
                                <stop offset="0%" stop-color="#FFFACD"/>
                                <stop offset="100%" stop-color="#DAA520"/>
                            </radialGradient>
                            <linearGradient id="goldText" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#FFF"/>
                                <stop offset="100%" stop-color="#DAA520"/>
                            </linearGradient>
                        </defs>
                    </svg>`;
                } else if (rank === 2) {
                    // Silver Medal - 3D with metallic shine
                    medalSVG = `<svg width="32" height="32" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                        <path d="M35 5 L40 35 L50 30 L60 35 L65 5 L60 8 L50 3 L40 8 Z" fill="url(#ribbon2)" stroke="#00008B" stroke-width="0.5"/>
                        <ellipse cx="50" cy="115" rx="25" ry="4" fill="#000" opacity="0.3"/>
                        <circle cx="50" cy="70" r="32" fill="url(#silverDark)"/>
                        <circle cx="50" cy="70" r="28" fill="url(#silverMedal)" stroke="#A8A8A8" stroke-width="1.5"/>
                        <circle cx="50" cy="70" r="24" fill="none" stroke="url(#silverRing)" stroke-width="2"/>
                        <circle cx="50" cy="70" r="18" fill="url(#silverCenter)"/>
                        <text x="50" y="80" font-family="Arial Black" font-size="24" font-weight="bold" fill="url(#silverText)" text-anchor="middle" stroke="#696969" stroke-width="0.5">2</text>
                        <path d="M30 52 Q35 50 40 52 Q35 54 30 52" fill="#FFF" opacity="0.8"/>
                        <circle cx="32" cy="54" r="3" fill="#FFF" opacity="0.7"/>
                        <path d="M50 88 Q35 85 30 78" fill="#000" opacity="0.2"/>
                        <path d="M50 52 L51 55 L54 55 L52 57 L53 60 L50 58 L47 60 L48 57 L46 55 L49 55 Z" fill="#FFF" opacity="0.6"/>
                        
                        <defs>
                            <linearGradient id="ribbon2" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#4169E1"/>
                                <stop offset="100%" stop-color="#00008B"/>
                            </linearGradient>
                            <radialGradient id="silverDark">
                                <stop offset="70%" stop-color="#C0C0C0"/>
                                <stop offset="100%" stop-color="#696969"/>
                            </radialGradient>
                            <radialGradient id="silverMedal">
                                <stop offset="0%" stop-color="#FFFFFF"/>
                                <stop offset="30%" stop-color="#E8E8E8"/>
                                <stop offset="70%" stop-color="#C0C0C0"/>
                                <stop offset="100%" stop-color="#A8A8A8"/>
                            </radialGradient>
                            <linearGradient id="silverRing" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#FFF"/>
                                <stop offset="50%" stop-color="#A8A8A8"/>
                                <stop offset="100%" stop-color="#FFF"/>
                            </linearGradient>
                            <radialGradient id="silverCenter">
                                <stop offset="0%" stop-color="#F5F5F5"/>
                                <stop offset="100%" stop-color="#C0C0C0"/>
                            </radialGradient>
                            <linearGradient id="silverText" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#FFF"/>
                                <stop offset="100%" stop-color="#A8A8A8"/>
                            </linearGradient>
                        </defs>
                    </svg>`;
                } else if (rank === 3) {
                    // Bronze Medal - 3D with warm tones
                    medalSVG = `<svg width="32" height="32" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                        <path d="M35 5 L40 35 L50 30 L60 35 L65 5 L60 8 L50 3 L40 8 Z" fill="url(#ribbon3)" stroke="#006400" stroke-width="0.5"/>
                        <ellipse cx="50" cy="115" rx="25" ry="4" fill="#000" opacity="0.3"/>
                        <circle cx="50" cy="70" r="32" fill="url(#bronzeDark)"/>
                        <circle cx="50" cy="70" r="28" fill="url(#bronzeMedal)" stroke="#8B4513" stroke-width="1.5"/>
                        <circle cx="50" cy="70" r="24" fill="none" stroke="url(#bronzeRing)" stroke-width="2"/>
                        <circle cx="50" cy="70" r="18" fill="url(#bronzeCenter)"/>
                        <text x="50" y="80" font-family="Arial Black" font-size="24" font-weight="bold" fill="url(#bronzeText)" text-anchor="middle" stroke="#654321" stroke-width="0.5">3</text>
                        <path d="M30 52 Q35 50 40 52 Q35 54 30 52" fill="#FFE4B5" opacity="0.6"/>
                        <circle cx="32" cy="54" r="3" fill="#FFE4B5" opacity="0.5"/>
                        <path d="M50 88 Q35 85 30 78" fill="#000" opacity="0.2"/>
                        <path d="M50 52 L51 55 L54 55 L52 57 L53 60 L50 58 L47 60 L48 57 L46 55 L49 55 Z" fill="#FFE4B5" opacity="0.4"/>
                        
                        <defs>
                            <linearGradient id="ribbon3" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#32CD32"/>
                                <stop offset="100%" stop-color="#006400"/>
                            </linearGradient>
                            <radialGradient id="bronzeDark">
                                <stop offset="70%" stop-color="#B87333"/>
                                <stop offset="100%" stop-color="#654321"/>
                            </radialGradient>
                            <radialGradient id="bronzeMedal">
                                <stop offset="0%" stop-color="#FFE4C4"/>
                                <stop offset="30%" stop-color="#CD853F"/>
                                <stop offset="70%" stop-color="#B87333"/>
                                <stop offset="100%" stop-color="#8B4513"/>
                            </radialGradient>
                            <linearGradient id="bronzeRing" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#FFE4B5"/>
                                <stop offset="50%" stop-color="#8B4513"/>
                                <stop offset="100%" stop-color="#FFE4B5"/>
                            </linearGradient>
                            <radialGradient id="bronzeCenter">
                                <stop offset="0%" stop-color="#DEB887"/>
                                <stop offset="100%" stop-color="#B87333"/>
                            </radialGradient>
                            <linearGradient id="bronzeText" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#FFE4B5"/>
                                <stop offset="100%" stop-color="#8B4513"/>
                            </linearGradient>
                        </defs>
                    </svg>`;
                }
                
                // Calculate progress based on 365 days
                const progressPercent = Math.min((user.miningDays / 365) * 100, 100);
                
                userRows.push(`
                    <div style="background: ${isCurrentUser ? 'rgba(251, 191, 36, 0.1)' : 'rgba(0, 0, 0, 0.3)'}; border: 1px solid ${isCurrentUser ? '#fbbf24' : 'rgba(0, 255, 255, 0.2)'}; border-radius: 10px; padding: 10px; ${isCurrentUser ? '' : ''}">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                ${isMedal ? 
                                    `<div style="display: flex; align-items: center; gap: 1px;">
                                        <div style="width: 32px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${medalSVG}</div>
                                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; font-weight: 800; min-width: 26px;">#${rank}</div>
                                    </div>` :
                                    `<div style="color: rgba(255, 255, 255, 0.5); font-weight: 800; font-size: 14px; min-width: 26px; margin-left: 33px;">#${rank}</div>`
                                }
                                <div style="flex: 1; min-width: 0;">
                                    <div style="color: ${isCurrentUser ? '#fbbf24' : (rank <= 3 ? '#00ffff' : 'white')}; font-weight: 700; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${user.country ? getCountryFlag(user.country) : '🌍'} ${user.username}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="display: flex; flex-direction: column; gap: 3px;">
                                    <!-- Balance Bar -->
                                    <div class="level-progress-bar" style="width: 70px; height: 16px; background: rgba(10, 20, 40, 0.85); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid rgba(0, 255, 255, 0.3);">
                                        <div class="level-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8px; font-weight: 700; color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);">
                                            ${formatBalance(user.balance || 0)}
                                        </div>
                                    </div>
                                    <!-- Days Bar -->
                                    <div class="level-progress-bar" style="width: 70px; height: 16px; background: rgba(10, 20, 40, 0.85); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid rgba(16, 185, 129, 0.3);">
                                        <div class="level-progress-fill" style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: ${progressPercent}%;"></div>
                                        <div class="level-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8px; font-weight: 700; color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);">
                                            ${user.miningDays}/365 Days
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #00ffff; font-weight: 800; font-size: 14px;">Lv ${user.level}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
            
            // ⚡ Join first 50 rows immediately (fast initial render)
            const INITIAL_RENDER = 50;
            const firstBatch = userRows.slice(0, INITIAL_RENDER).join('');
            html += firstBatch;
            
            html += '</div></div>'; // Close items container and main container
            
            // ⚡ Load remaining rows after page shows (progressive render)
            if (userRows.length > INITIAL_RENDER) {
                setTimeout(() => {
                    const pageContent = document.getElementById('fullPageContent');
                    if (!pageContent) return;
                    
                    const remainingBatch = userRows.slice(INITIAL_RENDER).join('');
                    const closingDivs = '</div></div>';
                    const currentHTML = pageContent.innerHTML;
                    const insertPosition = currentHTML.lastIndexOf(closingDivs);
                    
                    if (insertPosition !== -1) {
                        const newHTML = currentHTML.slice(0, insertPosition) + remainingBatch + currentHTML.slice(insertPosition);
                        pageContent.innerHTML = newHTML;
                        console.log('✅ Loaded remaining', userRows.length - INITIAL_RENDER, 'users in background');
                    }
                }, 100);
            }
            
            return html;
        }
        
        // Cache for referrals - 1 hour validity with localStorage persistence
        let cachedReferralsData = null;
        let cachedReferralsTimestamp = 0;
        
        // Load cache from localStorage
        try {
            const savedCache = localStorage.getItem('referralsCache_' + (currentUser?.email || ''));
            const savedTimestamp = parseInt(localStorage.getItem('referralsCacheTime_' + (currentUser?.email || '')) || '0');
            if (savedCache && savedTimestamp) {
                cachedReferralsData = JSON.parse(savedCache);
                cachedReferralsTimestamp = savedTimestamp;
            }
        } catch (e) {}
        
        async function getReferralsPageContent() {
            // Get current user from backend
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const currentEmail = localStorage.getItem('currentUser');
            
            // Get referrals from backend OR cache
            const now = Date.now();
            let activeRefs = [];
            let inactiveRefs = [];
            let hasMore = false;
            let totalRefs = 0;
            
            // Check if cache is valid (less than 1 hour old)
            const cacheAge = now - cachedReferralsTimestamp;
            const oneHour = 60 * 60 * 1000; // 1 hour in milliseconds
            const isCacheValid = cachedReferralsData && cacheAge < oneHour;
            
            try {
                // Use cache if available and valid
                if (isCacheValid) {
                    activeRefs = cachedReferralsData.activeRefs;
                    inactiveRefs = cachedReferralsData.inactiveRefs;
                    hasMore = cachedReferralsData.hasMore || false;
                    totalRefs = cachedReferralsData.total || 0;
                } else {
                    // Get first 10 referrals
                    const refResponse = await fetch(API_ENDPOINTS.getReferrals + '?userId=' + currentUser.userId + '&offset=0', {
                        headers: getApiHeaders()
                    });
                    const refData = await refResponse.json();
                    
                    if (refResponse.ok && refData.referrals) {
                        const allReferrals = refData.referrals;
                        hasMore = refData.hasMore || false;
                        totalRefs = refData.total || 0;
                        
                        // Backend now provides isActive field for each referral
                        activeRefs = allReferrals.filter(r => r.isActive === true);
                        inactiveRefs = allReferrals.filter(r => r.isActive === false);
                        
                        // Cache the results in memory and localStorage
                        cachedReferralsData = { activeRefs, inactiveRefs, hasMore, total: totalRefs };
                        cachedReferralsTimestamp = now;
                        
                        localStorage.setItem('referralsCache_' + currentEmail, JSON.stringify(cachedReferralsData));
                        localStorage.setItem('referralsCacheTime_' + currentEmail, now.toString());
                    }
                }
            } catch (err) {
                console.error('Failed to fetch referrals:', err);
            }
            
            // Check notification cooldown (5 minutes)
            const lastNotifTime = parseInt(localStorage.getItem('lastReferralNotif_' + currentEmail) || '0');
            const canSendNotif = (now - lastNotifTime) > (5 * 60 * 1000);
            
            return `
                <!-- Referral Code Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="color: #8b5cf6; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Your Referral Code</div>
                        <div class="ref-compact">
                            <div class="ref-code-text">${currentUser.username}</div>
                            <button class="copy-btn" onclick="copyReferralCode()">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button id="activeTab" onclick="switchReferralTab('active')" style="flex: 1; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 8px; padding: 10px; color: #10b981; font-size: 13px; font-weight: 700; cursor: pointer;">
                        🟢 Active (${activeRefs.length})
                    </button>
                    <button id="inactiveTab" onclick="switchReferralTab('inactive')" style="flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px; color: rgba(255, 255, 255, 0.5); font-size: 13px; font-weight: 700; cursor: pointer;">
                        ⚪ Inactive (${inactiveRefs.length})
                    </button>
                </div>
                
                <!-- Active List -->
                <div id="activeList" style="display: flex; flex-direction: column; gap: 10px;">
                    ${activeRefs.length > 0 ? activeRefs.map(ref => `
                        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 14px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: white; font-size: 15px; font-weight: 700; margin-bottom: 4px;">${ref.username}</div>
                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">Level ${ref.level}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; color: #10b981; font-size: 12px; font-weight: 700;">
                                    <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>
                                    Active
                                </div>
                            </div>
                        </div>
                    `).join('') : '<div style="text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.4); font-size: 14px;">No active referrals yet</div>'}
                    
                    ${hasMore ? `
                        <button id="loadMoreBtn" onclick="loadMoreReferrals()" style="
                            width: 100%;
                            background: rgba(0, 0, 0, 0.3);
                            border: 1px solid rgba(16, 185, 129, 0.3);
                            border-radius: 12px;
                            padding: 16px;
                            color: rgba(255, 255, 255, 0.8);
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            margin-top: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.borderColor='rgba(16, 185, 129, 0.5)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            Show ${totalRefs - 10} more
                        </button>
                    ` : ''}
                </div>
                
                <!-- Inactive List -->
                <div id="inactiveList" style="display: none; flex-direction: column; gap: 10px;">
                    ${inactiveRefs.length > 0 ? `
                        ${inactiveRefs.map(ref => `
                            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 14px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: white; font-size: 15px; font-weight: 700; margin-bottom: 4px;">${ref.username}</div>
                                        <div style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">Level ${ref.level}</div>
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.3); font-size: 12px; font-weight: 600;">
                                        💤 Idle
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        
                        ${hasMore ? `
                            <button id="loadMoreBtnInactive" onclick="loadMoreReferrals()" style="
                                width: 100%;
                                background: rgba(0, 0, 0, 0.3);
                                border: 1px solid rgba(139, 92, 246, 0.3);
                                border-radius: 12px;
                                padding: 16px;
                                color: rgba(255, 255, 255, 0.8);
                                font-size: 13px;
                                font-weight: 600;
                                cursor: pointer;
                                margin-top: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'; this.style.borderColor='rgba(139, 92, 246, 0.5)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(139, 92, 246, 0.3)'">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                Show ${totalRefs - 10} more
                            </button>
                        ` : ''}
                        
                        <!-- Notify Button -->
                        <button onclick="sendReferralNotification()" ${!canSendNotif ? 'disabled' : ''} style="background: ${canSendNotif ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'rgba(0, 0, 0, 0.3)'}; border: none; border-radius: 12px; padding: 14px; color: white; font-size: 14px; font-weight: 700; cursor: ${canSendNotif ? 'pointer' : 'not-allowed'}; margin-top: 10px; opacity: ${canSendNotif ? '1' : '0.5'};">
                            ${canSendNotif ? '📢 Notify Inactive Friends' : '⏳ Wait 5 minutes'}
                        </button>
                    ` : '<div style="text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.4); font-size: 14px;">All your referrals are active! 🎉</div>'}
                </div>
            `;
        }
        
        function switchReferralTab(tab) {
            const activeTab = document.getElementById('activeTab');
            const inactiveTab = document.getElementById('inactiveTab');
            const activeList = document.getElementById('activeList');
            const inactiveList = document.getElementById('inactiveList');
            
            if (tab === 'active') {
                activeTab.style.background = 'rgba(16, 185, 129, 0.2)';
                activeTab.style.borderColor = 'rgba(16, 185, 129, 0.4)';
                activeTab.style.color = '#10b981';
                inactiveTab.style.background = 'rgba(0, 0, 0, 0.3)';
                inactiveTab.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                inactiveTab.style.color = 'rgba(255, 255, 255, 0.5)';
                activeList.style.display = 'flex';
                inactiveList.style.display = 'none';
            } else {
                inactiveTab.style.background = 'rgba(139, 92, 246, 0.2)';
                inactiveTab.style.borderColor = 'rgba(139, 92, 246, 0.4)';
                inactiveTab.style.color = '#8b5cf6';
                activeTab.style.background = 'rgba(0, 0, 0, 0.3)';
                activeTab.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                activeTab.style.color = 'rgba(255, 255, 255, 0.5)';
                inactiveList.style.display = 'flex';
                activeList.style.display = 'none';
            }
        }
        
        async function loadMoreReferrals() {
            const btn = document.getElementById('loadMoreBtn');
            const btnInactive = document.getElementById('loadMoreBtnInactive');
            
            if (btn) btn.disabled = true;
            if (btnInactive) btnInactive.disabled = true;
            
            showToast('🔄 Loading more referrals...', false, 999999);
            
            try {
                // Load remaining referrals (offset = 10)
                const refResponse = await fetch(API_ENDPOINTS.getReferrals + '?userId=' + currentUser.userId + '&offset=10', {
                    headers: getApiHeaders()
                });
                const refData = await refResponse.json();
                
                if (refResponse.ok && refData.referrals) {
                    const newReferrals = refData.referrals;
                    const newActive = newReferrals.filter(r => r.isActive === true);
                    const newInactive = newReferrals.filter(r => r.isActive === false);
                    
                    // Update cache
                    if (cachedReferralsData) {
                        cachedReferralsData.activeRefs.push(...newActive);
                        cachedReferralsData.inactiveRefs.push(...newInactive);
                        cachedReferralsData.hasMore = false; // All loaded now
                        
                        const currentEmail = localStorage.getItem('currentUser');
                        localStorage.setItem('referralsCache_' + currentEmail, JSON.stringify(cachedReferralsData));
                    }
                    
                    // Reload page to show all referrals
                    showToast('✓ Loaded all referrals!');
                    setTimeout(() => {
                        openPage('referrals');
                    }, 1000);
                } else {
                    showToast('❌ Failed to load more', true);
                }
            } catch (err) {
                console.error('Load more error:', err);
                showToast('❌ Failed to load more', true);
            } finally {
                if (btn) btn.disabled = false;
                if (btnInactive) btnInactive.disabled = false;
            }
        }
        
        function sendReferralNotification() {
            const currentEmail = localStorage.getItem('currentUser');
            const now = Date.now();
            
            // Set cooldown
            localStorage.setItem('lastReferralNotif_' + currentEmail, now.toString());
            
            showToast('✓ Notification sent to inactive friends!');
            
            // Reload page to update button state
            openPage('referrals');
        }
        
        function openReferralsDirectly() {
            // Set flag to ignore next popstate
            ignoreNextPopstate = true;
            
            // Manually close menu without history manipulation
            const sidebar = document.getElementById('menuSidebar');
            const overlay = document.getElementById('menuOverlay');
            if (sidebar && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
            
            const fullPage = document.getElementById('fullPage');
            const pageTitle = document.getElementById('fullPageTitle');
            const pageContent = document.getElementById('fullPageContent');
            
            // Show page with loading
            fullPage.classList.add('active');
            fullPage.dataset.currentPage = 'referrals';
            
            pageTitle.textContent = 'My Referrals';
            
            // Show loading skeleton immediately
            pageContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 400px; padding: 20px;">
                    <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(0, 255, 255, 0.4); border-radius: 20px; padding: 40px 30px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2);">
                        <div style="width: 60px; height: 60px; border: 3px solid rgba(0, 255, 255, 0.3); border-top-color: #00ffff; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                        <h3 style="color: #00ffff; font-size: 18px; font-weight: 700; margin-bottom: 8px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Loading Referrals</h3>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                
/* === AUTH LOGO & SPLASH FIX (MOBILE SAFE) === */
.auth-logo {
  width: 140px;
  height: 140px;
  margin: 0 auto 24px auto;
  background-image: url('assets/auth-logo.webp');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.auth-splash {
  width: 100%;
  height: 220px;
  background-image: url('assets/splash-image.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 20px;
}


/* === BALANCE ICON FINAL FIX === */
.balance-icon {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  border: 0.3px solid #00d9ff;
  border-radius: 4px;
  padding: 2px;
  margin: 4px 0;
  display: inline-block;
}

</style>
            `;
            
            // Load content asynchronously
            getReferralsPageContent().then(html => pageContent.innerHTML = html);
            
            // Reset flag after a moment
            setTimeout(() => { ignoreNextPopstate = false; }, 200);
        }
        
        function openReferralsPage() {
            // AGGRESSIVE state management for instant back button
            try {
                // Push TWO states for immediate response
                history.pushState({ page: 'main' }, '', '');
                history.pushState({ page: 'referrals' }, '', '#referrals');
            } catch(e) {}
            
            // Now open the page normally
            openPage('referrals');
        }
        
        async function claimReferralEarnings() {
            // Prevent double-claiming
            if (isClaimingReferral) return;
            
            if (!currentUser.pendingReferralEarnings || currentUser.pendingReferralEarnings === 0) {
                showToast('❌ No earnings to claim', true);
                return;
            }
            
            // Set lock
            isClaimingReferral = true;
            
            // Store old values for rollback
            const oldBalance = d.balance;
            const oldPendingEarnings = d.pendingReferralEarnings;
            const earningsAmount = currentUser.pendingReferralEarnings;
            
            // ⚡ OPTIMISTIC UI - Update immediately (0ms)
            d.balance += earningsAmount;
            d.pendingReferralEarnings = 0;
            currentUser.pendingReferralEarnings = 0;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // CRITICAL: Mark claim time in localStorage to prevent re-showing
            localStorage.setItem('lastReferralClaimTime_' + currentUser.userId, Date.now().toString());
            
            save();
            
            // Update UI instantly
            render();
            showToast(`✓ Claimed ${earningsAmount} Coins from referrals!`);
            
            // ⚡ PARALLEL backend calls (all at once!)
            (async () => {
                try {
                    // 🔥 SINGLE REQUEST - Backend handles pending rewards!
                    const claimResponse = await fetch(API_ENDPOINTS.claimReferralEarnings, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({
                            userId: currentUser.userId
                        })
                    });
                    
                    const data = await claimResponse.json();
                    
                    if (data.earnings) {
                        // Use backend's exact balance (no flash!)
                        d.balance = data.newBalance || d.balance;
                        currentUser.balance = d.balance;
                        
                        // Backend automatically claims all pending referral rewards ✅
                        // Don't call initApp() - it might reload old data before DELETE propagates
                        // Optimistic update already handled above
                        
                        save();
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        render();
                        
                        console.log('✅ Referral earnings claimed successfully');
                    } else {
                        // Rollback on error
                        d.balance = oldBalance;
                        d.pendingReferralEarnings = oldPendingEarnings;
                        currentUser.pendingReferralEarnings = oldPendingEarnings;
                        render();
                        showToast('❌ Failed to claim referral earnings', true);
                    }
                } catch (err) {
                    console.error('Referral claim failed:', err);
                    // Rollback on error
                    d.balance = oldBalance;
                    d.pendingReferralEarnings = oldPendingEarnings;
                    currentUser.pendingReferralEarnings = oldPendingEarnings;
                    render();
                    showToast('❌ Failed to claim referral earnings', true);
                } finally {
                    setTimeout(() => {
                        isClaimingReferral = false;
                    }, 1000);
                }
            })();
        }
        
        function getProfilePageContent() {
            return `
                <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 15px; margin-bottom: 25px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 900; color: white;">${currentUser.username}</div>
                    <div style="font-size: 13px; color: #8b5cf6; margin-top: 4px;">@${currentUser.username}</div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-size: 14px; color: #8b5cf6; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Personal Information</div>
                        <button id="editInfoBtnPage" onclick="toggleEditInfoPage()" style="background: rgba(0, 255, 255, 0.2); border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; padding: 6px 12px; color: #00ffff; font-size: 12px; font-weight: 700; cursor: pointer;">
                            ✏️ Edit
                        </button>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Full Name</div>
                        <input type="text" id="inputFullNamePage" class="form-input" placeholder="Enter your full name" value="${d.fullName || ''}" style="margin: 0;" disabled>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Email Address</div>
                        <input type="email" id="inputEmailPage" class="form-input" placeholder="Enter your email" value="${currentUser.email}" style="margin: 0;" disabled>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Birth Date</div>
                        <input type="text" id="inputBirthDatePage" class="form-input" placeholder="DD/MM/YYYY" value="${d.birthDate || ''}" style="margin: 0;" maxlength="10" disabled oninput="formatBirthDateInput(this)">
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 12px; padding: 14px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px;">Country</div>
                        <div class="country-dropdown">
                            <input type="text" id="inputCountryPage" class="form-input" placeholder="Select or type your country" value="${d.country || ''}" style="margin: 0;" disabled autocomplete="off" onfocus="showCountryDropdown('inputCountryPage', 'countryDropdownPage')" oninput="filterCountries('inputCountryPage', 'countryDropdownPage')" onblur="setTimeout(() => validateCountryInput('inputCountryPage'), 200)">
                            <div id="countryDropdownPage" class="country-dropdown-list"></div>
                        </div>
                    </div>
                    <button id="saveInfoBtnPage" class="profile-action-btn" onclick="savePersonalInfoPage()" style="background: linear-gradient(135deg, #00ffff, #0096ff); color: #000; font-weight: 900; display: none;">
                        ✓ Save Information
                    </button>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 14px; color: #8b5cf6; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Account Settings</div>
                    <button class="profile-action-btn" onclick="showChangePassword()">🔒 Change Password</button>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 14px; color: #8b5cf6; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Share</div>
                    <button class="profile-action-btn" onclick="shareProfile()">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Share
                    </button>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <button class="profile-action-btn profile-delete-btn" onclick="showDeleteAccount()">🗑️ Delete Account</button>
                </div>
            `;
        }
        
        
        function getTasksPageContent() {
            // Get completed tasks from currentUser (backend)
            const completedTasks = currentUser.completedTasks || [];
            const completedTasksObj = {};
            completedTasks.forEach(taskId => {
                completedTasksObj[taskId] = true;
            });
            
            const clickedTasks = JSON.parse(localStorage.getItem('clickedTasks_' + currentUser.email) || '{}');
            
            const tasks = [
                { 
                    id: 'instagram', 
                    name: 'Instagram', 
                    url: 'https://instagram.com/arcastranetwork',
                    svg: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E1306C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>'
                },
                { 
                    id: 'twitter', 
                    name: 'X (Twitter)', 
                    url: 'https://x.com/arcastranetwork',
                    svg: '<svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>'
                },
                { 
                    id: 'facebook', 
                    name: 'Facebook', 
                    url: 'https://facebook.com/arcastranetwork',
                    svg: '<svg width="18" height="18" viewBox="0 0 24 24" fill="#1877F2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>'
                },
                { 
                    id: 'youtube', 
                    name: 'YouTube', 
                    url: 'https://youtube.com/@arcastranetwork',
                    svg: '<svg width="18" height="18" viewBox="0 0 24 24" fill="#FF0000"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>'
                },
                { 
                    id: 'telegram', 
                    name: 'Telegram', 
                    url: 'https://t.me/arcastranetwork',
                    svg: '<svg width="18" height="18" viewBox="0 0 24 24" fill="#0088cc"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>'
                }
            ];
            
            return `
                <div style="padding: 20px 0;">
                    <!-- Header Info -->
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15)); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 24px; text-align: center;">
                        <h3 style="color: #fff; font-size: 18px; font-weight: 800; margin-bottom: 8px;">🎯 Complete Tasks</h3>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin: 0; line-height: 1.5;">
                            Complete tasks to gain +5 progress!
                        </p>
                    </div>
                    
                    <!-- Tasks List -->
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        ${tasks.map(task => {
                            const isCompleted = completedTasksObj[task.id];
                            const isClicked = clickedTasks[task.id];
                            const showClaim = isClicked && !isCompleted;
                            
                            return `
                                <div style="
                                    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)); 
                                    border: 2px solid ${isCompleted ? 'rgba(0, 255, 0, 0.3)' : 'rgba(0, 255, 255, 0.3)'}; 
                                    border-radius: 16px; 
                                    padding: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    opacity: ${isCompleted ? '0.7' : '1'};
                                ">
                                    <!-- Left: Icon + Info -->
                                    <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                        <!-- Social Icon (Ana sayfadaki gibi) -->
                                        <a href="#" onclick="return false;" style="
                                            display: flex; 
                                            align-items: center; 
                                            justify-content: center; 
                                            width: 48px; 
                                            height: 48px; 
                                            background: rgba(0, 0, 0, 0.4); 
                                            border: 1px solid rgba(0, 255, 255, 0.2); 
                                            border-radius: 12px; 
                                            text-decoration: none;
                                            pointer-events: none;
                                        ">
                                            ${task.svg}
                                        </a>
                                        <div>
                                            <div style="color: #fff; font-size: 16px; font-weight: 700; margin-bottom: 4px;">${task.name}</div>
                                            <div style="color: ${isCompleted ? '#00ff00' : '#00ffff'}; font-size: 13px; font-weight: 600;">
                                                ${isCompleted ? '✅ Completed +5' : 'Follow us • Progress +5'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right: Button -->
                                    <div id="taskButton_${task.id}">
                                        ${isCompleted ? `
                                            <button disabled style="
                                                padding: 12px 24px;
                                                background: rgba(0, 255, 0, 0.2);
                                                border: 1px solid rgba(0, 255, 0, 0.3);
                                                border-radius: 12px;
                                                color: rgba(255, 255, 255, 0.6);
                                                font-size: 14px;
                                                font-weight: 700;
                                                cursor: not-allowed;
                                                white-space: nowrap;
                                            ">Claimed</button>
                                        ` : showClaim ? `
                                            <button onclick="claimTask('${task.id}')" style="
                                                padding: 12px 24px;
                                                background: linear-gradient(135deg, #00ff00, #00cc00);
                                                border: none;
                                                border-radius: 12px;
                                                color: #000;
                                                font-size: 14px;
                                                font-weight: 700;
                                                cursor: pointer;
                                                white-space: nowrap;
                                                box-shadow: 0 4px 20px rgba(0, 255, 0, 0.4);
                                            ">Claim</button>
                                        ` : `
                                            <button onclick="openTask('${task.id}', '${task.url}')" style="
                                                padding: 12px 24px;
                                                background: linear-gradient(135deg, #00ffff, #0088cc);
                                                border: none;
                                                border-radius: 12px;
                                                color: #000;
                                                font-size: 14px;
                                                font-weight: 700;
                                                cursor: pointer;
                                                white-space: nowrap;
                                                box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
                                            ">Follow</button>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        
        let isProcessingTask = false;
        
        function openTask(taskId, url) {
            // Prevent double clicks
            if (isProcessingTask) return;
            isProcessingTask = true;
            
            // Disable button immediately
            const buttonContainer = document.getElementById('taskButton_' + taskId);
            if (buttonContainer) {
                buttonContainer.innerHTML = `
                    <button disabled style="
                        padding: 12px 24px;
                        background: rgba(100, 100, 100, 0.3);
                        border: 1px solid rgba(150, 150, 150, 0.3);
                        border-radius: 12px;
                        color: rgba(255, 255, 255, 0.4);
                        font-size: 14px;
                        font-weight: 700;
                        cursor: not-allowed;
                        white-space: nowrap;
                    ">Opening...</button>
                `;
            }
            
            // Mark as clicked
            const clickedTasks = JSON.parse(localStorage.getItem('clickedTasks_' + currentUser.email) || '{}');
            clickedTasks[taskId] = Date.now();
            localStorage.setItem('clickedTasks_' + currentUser.email, JSON.stringify(clickedTasks));
            
            // Open link externally
            openExternalLink(url);
            
            // Wait 3 seconds then show claim button
            setTimeout(() => {
                const buttonContainer = document.getElementById('taskButton_' + taskId);
                if (buttonContainer) {
                    buttonContainer.innerHTML = `
                        <button onclick="claimTask('${taskId}')" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #00ff00, #00cc00);
                            border: none;
                            border-radius: 12px;
                            color: #000;
                            font-size: 14px;
                            font-weight: 700;
                            cursor: pointer;
                            white-space: nowrap;
                            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.4);
                        ">Claim</button>
                    `;
                }
                isProcessingTask = false;
            }, 3000);
        }
        
        async function claimTask(taskId) {
            // Prevent double clicks
            if (isProcessingTask) return;
            isProcessingTask = true;
            
            const buttonContainer = document.getElementById('taskButton_' + taskId);
            const reward = 5;
            
            // Update UI immediately (optimistic update)
            if (buttonContainer) {
                buttonContainer.innerHTML = `
                    <button disabled style="
                        padding: 12px 24px;
                        background: rgba(0, 255, 0, 0.2);
                        border: 1px solid rgba(0, 255, 0, 0.3);
                        border-radius: 12px;
                        color: rgba(255, 255, 255, 0.6);
                        font-size: 14px;
                        font-weight: 700;
                        cursor: not-allowed;
                        white-space: nowrap;
                    ">Completed</button>
                `;
            }
            
            // Update local state immediately
            if (!currentUser.completedTasks) {
                currentUser.completedTasks = [];
            }
            currentUser.completedTasks.push(taskId);
            currentUser.balance += reward;
            d.balance = currentUser.balance;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            showToast('✅ Task completed! +5 ARCASTRA', false);
            render();
            
            // Send to backend in background (don't await)
            fetch(API_ENDPOINTS.addPendingReward, {
                method: 'POST',
                headers: getApiHeaders(),
                body: JSON.stringify({
                    userId: currentUser.userId,
                    rewardType: 'task',
                    amount: reward,
                    metadata: { taskId: taskId }
                })
            }).catch(error => {
                console.error('Failed to sync task to backend:', error);
            });
            
            isProcessingTask = false;
        }
        
        function getUpgradesPageContent() {
            const isPermanentPurchased = currentUser.permanentBoostPurchased || false;
            
            return `
                <div style="padding: 20px 0;">
                    <!-- Header Info -->
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15)); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 24px; text-align: center;">
                        <h3 style="color: #fff; font-size: 18px; font-weight: 800; margin-bottom: 8px;">🚀 Boost Your Progress</h3>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin: 0; line-height: 1.5;">
                            Temporarily enhance your in-app progress speed for 24 hours
                        </p>
                    </div>
                    
                    <!-- Booster Card -->
                    <div style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 20px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2); position: relative; overflow: hidden;">
                        
                        <!-- Decorative glow -->
                        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%); pointer-events: none;"></div>
                        
                        <!-- Content -->
                        <div style="position: relative; z-index: 1;">
                            <!-- Rocket SVG -->
                            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                <svg width="120" height="120" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Flame (static) -->
                                    <g>
                                        <ellipse cx="100" cy="170" rx="15" ry="25" fill="url(#flameGradient)" opacity="0.9"/>
                                        <ellipse cx="85" cy="175" rx="8" ry="15" fill="url(#flameGradient2)" opacity="0.8"/>
                                        <ellipse cx="115" cy="175" rx="8" ry="15" fill="url(#flameGradient2)" opacity="0.8"/>
                                    </g>
                                    
                                    <!-- Rocket Body -->
                                    <path d="M 85 150 Q 85 100 100 40 Q 115 100 115 150 Z" fill="url(#rocketBody)" stroke="#00ffff" stroke-width="2"/>
                                    
                                    <!-- Rocket Nose -->
                                    <path d="M 100 20 L 85 50 Q 100 40 115 50 Z" fill="url(#rocketNose)" stroke="#00ffff" stroke-width="2"/>
                                    
                                    <!-- Window -->
                                    <circle cx="100" cy="80" r="15" fill="url(#window)" stroke="#00d4ff" stroke-width="2"/>
                                    <circle cx="100" cy="80" r="10" fill="rgba(0, 200, 255, 0.3)"/>
                                    
                                    <!-- Fins -->
                                    <path d="M 85 130 L 65 155 L 85 150 Z" fill="url(#fin)" stroke="#00ffff" stroke-width="2"/>
                                    <path d="M 115 130 L 135 155 L 115 150 Z" fill="url(#fin)" stroke="#00ffff" stroke-width="2"/>
                                    
                                    <!-- Details -->
                                    <rect x="88" y="100" width="24" height="3" rx="1.5" fill="#00ffff" opacity="0.6"/>
                                    <rect x="88" y="110" width="24" height="3" rx="1.5" fill="#00ffff" opacity="0.6"/>
                                    <rect x="88" y="120" width="24" height="3" rx="1.5" fill="#00ffff" opacity="0.6"/>
                                    
                                    <!-- Gradients -->
                                    <defs>
                                        <linearGradient id="rocketBody" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#00d4ff;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#0088cc;stop-opacity:1" />
                                        </linearGradient>
                                        <linearGradient id="rocketNose" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#00ffff;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                                        </linearGradient>
                                        <radialGradient id="window">
                                            <stop offset="0%" style="stop-color:#00ffff;stop-opacity:0.8" />
                                            <stop offset="100%" style="stop-color:#0066cc;stop-opacity:1" />
                                        </radialGradient>
                                        <linearGradient id="fin" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#0088cc;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                                        </linearGradient>
                                        <linearGradient id="flameGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#ff6b00;stop-opacity:1" />
                                            <stop offset="50%" style="stop-color:#ff3300;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#ffaa00;stop-opacity:0.7" />
                                        </linearGradient>
                                        <linearGradient id="flameGradient2" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#ffaa00;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#ff3300;stop-opacity:0.5" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                            </div>
                            
                            <!-- Booster Info -->
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h2 style="color: #fff; font-size: 24px; font-weight: 900; margin-bottom: 8px;">Speed Boost +5.00</h2>
                                <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin: 0;">
                                    Provides a 24-hour in-app speed enhancement
                                </p>
                            </div>
                            
                            <!-- Features -->
                            <div style="background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <span style="color: #00ffff; font-size: 20px;">✓</span>
                                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 14px;">24-hour temporary speed enhancement</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <span style="color: #00ffff; font-size: 20px;">✓</span>
                                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 14px;">Works in addition to your current progress speed</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="color: #00ffff; font-size: 20px;">✓</span>
                                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 14px;">Limited-time price offer!</span>
                                </div>
                            </div>
                            
                            <!-- Price & Button -->
                            <div style="text-align: center;">
                                <div style="color: #8b5cf6; font-size: 16px; font-weight: 600; margin-bottom: 12px;">
                                    Price: <span style="color: #00ffff; font-size: 20px; font-weight: 900;">$0.49</span>
                                </div>
                                <div id="speedBoostButtonContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        let isPurchasingSpeedBoost = false;
        let speedBoostCooldownEnd = 0;
        let boostButtonInterval = null;
        
        // Render Speed Boost button with cooldown
        function renderSpeedBoostButton() {
            const container = document.getElementById('speedBoostButtonContainer');
            if (!container) return;
            
            const now = Date.now();
            const cooldownRemaining = Math.max(0, Math.ceil((speedBoostCooldownEnd - now) / 1000));
            const isOnCooldown = cooldownRemaining > 0;
            const isDisabled = isOnCooldown || isPurchasingSpeedBoost;
            
            container.innerHTML = `
                <button 
                    onclick="${isDisabled ? '' : 'purchaseBooster()'}" 
                    style="
                        width: 100%; 
                        background: ${isOnCooldown ? 'rgba(0, 255, 255, 0.1)' : 'linear-gradient(135deg, #00ffff, #0088cc)'}; 
                        border: ${isOnCooldown ? '1px solid rgba(0, 255, 255, 0.3)' : 'none'}; 
                        border-radius: 12px; 
                        padding: 16px; 
                        color: ${isOnCooldown ? 'rgba(255, 255, 255, 0.6)' : '#000'}; 
                        font-size: 18px; 
                        font-weight: 900; 
                        cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; 
                        box-shadow: 0 4px 20px rgba(0, 255, 255, ${isOnCooldown ? '0.1' : '0.4'}); 
                        transition: all 0.3s;
                        opacity: ${isOnCooldown ? '0.6' : '1'};
                    "
                    ${isDisabled ? 'disabled' : ''}
                >
                    ${isOnCooldown ? `⏳ Wait ${cooldownRemaining}s` : '🚀 ACTIVATE BOOST'}
                </button>
            `;
        }
        
        // Render Permanent Boost button with cooldown
        
        // Start button update interval
        function startBoostButtonUpdates() {
            if (boostButtonInterval) clearInterval(boostButtonInterval);
            boostButtonInterval = setInterval(() => {
                renderSpeedBoostButton();
            }, 1000);
        }
        
        // Stop button updates
        function stopBoostButtonUpdates() {
            if (boostButtonInterval) {
                clearInterval(boostButtonInterval);
                boostButtonInterval = null;
            }
        }
        
        async function purchaseBooster() {
            // Check cooldown
            const now = Date.now();
            if (now < speedBoostCooldownEnd) {
                return; // Button already shows countdown
            }
            
            // Prevent multiple clicks
            if (isPurchasingSpeedBoost) {
                return;
            }
            
            // Check if mining is active
            const sessionId = localStorage.getItem('currentSessionId_' + currentUser.email);
            if (!sessionId) {
                showToast('❌ Please start mining first!', true);
                return;
            }
            
            isPurchasingSpeedBoost = true;
            
            try {
                showToast('🔄 Please wait Initiating purchase...', false, 999999);
                
                // Google Play In-App Purchase integration
                let purchaseToken = null;
                
                // Check if running in Android WebView with billing support
                if (typeof Android !== 'undefined' && Android.purchaseProduct) {
                    try {
                        // Call Android native method to initiate purchase
                        const purchaseResult = await new Promise((resolve, reject) => {
                            // Set timeout for purchase
                            const timeout = setTimeout(() => {
                                reject(new Error('Purchase timeout'));
                            }, 60000); // 60 second timeout
                            
                            // Store callback globally
                            window.onPurchaseComplete = (result) => {
                                clearTimeout(timeout);
                                if (result.success) {
                                    resolve(result);
                                } else {
                                    reject(new Error(result.error || 'Purchase failed'));
                                }
                            };
                            
                            // Initiate purchase
                            Android.purchaseProduct('speed_boost_24h');
                        });
                        
                        purchaseToken = purchaseResult.token;
                        console.log('✅ Purchase token received:', purchaseToken);
                        
                    } catch (purchaseError) {
                        console.error('Purchase initiation failed:', purchaseError);
                        showToast('❌ ' + (purchaseError.message || 'Purchase cancelled'), true);
                        isPurchasingSpeedBoost = false;
                        renderSpeedBoostButton();
                        return;
                    }
                } else {
                    // Fallback for web testing (development only)
                    console.warn('⚠️ Android billing not available, using test token');
                    purchaseToken = 'test_speed_boost_' + Date.now() + '_' + Math.random().toString(36).substring(7);
                }
                
                showToast('🔄 Please Wait Verifying purchase...', false, 999999);
                
                const response = await fetch(API_ENDPOINTS.purchaseSpeedBoost, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        purchaseToken: purchaseToken
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`🚀 Speed Boost activated! Total: +${data.totalBoostAmount.toFixed(2)} (${data.boostCount}x purchases)`, false);
                    
                    // Set 10 second cooldown
                    speedBoostCooldownEnd = Date.now() + 10000;
                    renderSpeedBoostButton();
                    
                    // Refresh data to show new rate
                    await initApp();
                } else {
                    showToast(`❌ ${data.error || 'Purchase failed'}`, true);
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showToast('❌ Purchase failed. Please try again.', true);
            } finally {
                isPurchasingSpeedBoost = false;
                renderSpeedBoostButton();
            }
        }
        
        function toggleEditInfoPage() {
            const inputs = [
                document.getElementById('inputFullNamePage'),
                document.getElementById('inputEmailPage'),
                document.getElementById('inputBirthDatePage'),
                document.getElementById('inputCountryPage')
            ];
            
            const isDisabled = inputs[0].disabled;
            
            inputs.forEach(input => {
                if (input) input.disabled = !isDisabled;
            });
            
            document.getElementById('saveInfoBtnPage').style.display = isDisabled ? 'block' : 'none';
            document.getElementById('editInfoBtnPage').style.display = isDisabled ? 'none' : 'block';
        }
        
        async function savePersonalInfoPage() {
            const newEmail = document.getElementById('inputEmailPage').value.trim().toLowerCase();
            const fullName = document.getElementById('inputFullNamePage').value.trim();
            const birthDate = document.getElementById('inputBirthDatePage').value.trim();
            const country = document.getElementById('inputCountryPage').value.trim();
            
            // Validate full name
            const fullNameRegex = /^[a-zA-Z\s]+$/;
            if (!fullNameRegex.test(fullName)) {
                showToast('❌ Full Name: Only English letters allowed');
                return;
            }
            if (fullName.length < 3) {
                showToast('❌ Full Name must be at least 3 characters');
                return;
            }
            
            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showToast('❌ Invalid email');
                return;
            }
            
            // Validate birth date
            if (birthDate) {
                const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                const match = birthDate.match(dateRegex);
                if (!match) {
                    showToast('❌ Format: DD/MM/YYYY');
                    return;
                }
                const day = parseInt(match[1]);
                const month = parseInt(match[2]);
                const year = parseInt(match[3]);
                if (year < 1923 || year > 2007 || month < 1 || month > 12 || day < 1 || day > 31) {
                    showToast('❌ Invalid date');
                    return;
                }
            }
            
            try {
                // Update profile
                const profileRes = await fetch(API_ENDPOINTS.updateProfile, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({userId: currentUser.userId, fullName, birthDate, country})
                });
                
                if (!profileRes.ok) {
                    const data = await profileRes.json();
                    showToast(`❌ ${data.error || 'Failed'}`);
                    return;
                }
                
                // Update email if changed
                if (newEmail !== currentUser.email) {
                    const emailRes = await fetch(API_ENDPOINTS.updateEmail, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({userId: currentUser.userId, newEmail})
                    });
                    
                    if (!emailRes.ok) {
                        const data = await emailRes.json();
                        showToast(`❌ ${data.error || 'Email update failed'}`);
                        return;
                    }
                    currentUser.email = newEmail;
                }
                
                currentUser.fullName = fullName;
                currentUser.birthDate = birthDate;
                currentUser.country = country;
                
                showToast('✓ Profile updated');
                document.getElementById('inputFullNamePage').disabled = true;
                document.getElementById('inputEmailPage').disabled = true;
                document.getElementById('inputBirthDatePage').disabled = true;
                document.getElementById('inputCountryPage').disabled = true;
                document.getElementById('saveInfoBtnPage').style.display = 'none';
                document.getElementById('editInfoBtnPage').style.display = 'block';
                
                await initApp();
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('❌ Failed to update');
            }
        }

        
        function changeAvatarInPage(color) {
            d.avatarColor = color;
            save();
            openPage('profile');
        }
        
        createParticles();
        
        // Splash screen - checkAuth çağır, splash initApp bitene kadar kalacak
        window.addEventListener('load', function() {
            checkAuth();
        });
        
        // Exit handling - double back press
        let lastBackPress = 0;
        const backPressInterval = 2000; // 2 seconds
        let ignoreNextPopstate = false; // Flag to ignore popstate
        
        // Handle back button (with error handling for restricted environments)
        try {
            window.addEventListener('popstate', function(event) {
                // Check ignore flag
                if (ignoreNextPopstate) {
                    ignoreNextPopstate = false;
                    return;
                }
                
                const fullPage = document.getElementById('fullPage');
                const sidebar = document.getElementById('menuSidebar');
                
                // Check if any profile modal is open
                const changeEmailModal = document.getElementById('changeEmailModal');
                const changePasswordModal = document.getElementById('changePasswordModal');
                const deleteAccountModal = document.getElementById('deleteAccountModal');
                
                if (changeEmailModal && changeEmailModal.classList.contains('show')) {
                    closeChangeEmail();
                    history.pushState({ page: 'main' }, '', '');
                    return;
                }
                
                if (changePasswordModal && changePasswordModal.classList.contains('show')) {
                    closeChangePassword();
                    history.pushState({ page: 'main' }, '', '');
                    return;
                }
                
                if (deleteAccountModal && deleteAccountModal.classList.contains('show')) {
                    closeDeleteAccount();
                    history.pushState({ page: 'main' }, '', '');
                    return;
                }
                
                // Check if full page is open - close it and go to main (CHECK THIS FIRST!)
                if (fullPage && fullPage.classList.contains('active')) {
                    closePage();
                    
                    // ✅ CRITICAL: Ensure main page is visible
                    const mainContainer = document.querySelector('.container');
                    if (mainContainer) {
                        mainContainer.style.display = 'block';
                    }
                    
                    // ✅ DOUBLE PUSH: Prevent app exit
                    history.pushState({ page: 'main' }, '', '');
                    history.pushState({ page: 'main' }, '', '');
                    return;
                }
                
                // Check if menu is open - close it and go to main
                if (sidebar && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    document.getElementById('menuOverlay').classList.remove('show');
                    document.body.style.overflow = 'auto';
                    history.pushState({ page: 'main' }, '', '');
                    return; // IMPORTANT: return here!
                }
                
                // On main page - handle exit (only if nothing else is open)
                const currentTime = Date.now();
                
                if (currentTime - lastBackPress < backPressInterval) {
                    // Second press within interval - allow exit
                    // Browser will handle the exit
                    return;
                } else {
                    // First press - set timestamp (no toast)
                    lastBackPress = currentTime;
                    
                    // Push a new state so back button can be pressed again
                    history.pushState({ page: 'main' }, '', '');
                }
            });
            
            // Set initial state
            history.replaceState({ page: 'main' }, '', window.location.pathname);
        } catch(e) {
            // History API not available or restricted - use alternative
            // Listen for hashchange as fallback
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash;
                const sidebar = document.getElementById('menuSidebar');
                
                if (!hash || hash === '') {
                    // Close menu if open
                    if (sidebar && sidebar.classList.contains('open')) {
                        sidebar.classList.remove('open');
                        document.getElementById('menuOverlay').classList.remove('show');
                        document.body.style.overflow = 'auto';
                    }
                    
                    // Close page if open
                    const fullPage = document.getElementById('fullPage');
                    if (fullPage && fullPage.classList.contains('active')) {
                        closePage();
                    }
                }
            });
        }
		/* ==================================================
   PERMA VISUAL LOCK + HARD FUNCTION LOCK (LAST 30s)
   - No flicker
   - Survives re-render
   - Unlocks on new mining session
   ================================================== */
(function () {
  try {
    const LOCK_BEFORE_MS = 30 * 1000;

    function userEmail() {
      return localStorage.getItem("currentUser") || "";
    }

    function miningEndTime() {
      const email = userEmail();
      if (!email) return 0;
      return Number(localStorage.getItem("miningEndTime_" + email)) || 0;
    }

    function lockKey() {
      const email = userEmail();
      const end = miningEndTime();
      return email && end ? `adUiLocked_${email}_${end}` : "";
    }

    function shouldLockNow() {
      const end = miningEndTime();
      if (!end) return false;
      return (end - Date.now()) <= LOCK_BEFORE_MS;
    }

    function isLockedForThisMining() {
      const k = lockKey();
      if (!k) return false;
      return localStorage.getItem(k) === "1";
    }

    function setLockedForThisMining() {
      const k = lockKey();
      if (!k) return;
      localStorage.setItem(k, "1");
    }

    // Reklam butonunu bul (senin UI'da "📺 Watch Ad +0.25 MR" var)
    function findAdButton() {
      // Eğer ID/class biliyorsan buraya eklemen en iyi seçenek:
      return (
        document.querySelector("#watchAdBtn") ||
        document.querySelector(".btn-bonus") ||
        [...document.querySelectorAll("button")].find(b =>
          (b.textContent || "").toLowerCase().includes("watch ad")
          || (b.textContent || "").includes("📺 Watch Ad")
        )
      );
    }

    // Görsel kilit: render ne yaparsa yapsın tekrar uygula
    function applyVisualLock(btn) {
      if (!btn) return;

      // Orijinal yazıyı bir kere sakla (unlock için)
      if (!btn.dataset.origText) btn.dataset.origText = btn.textContent;

      btn.disabled = true;
      btn.style.pointerEvents = "none";
      btn.style.opacity = "0.45";
      btn.style.filter = "grayscale(1)";
      btn.textContent = "⛔ DISABLED (last 30s)";
      btn.dataset.adLocked = "1";
    }

    function removeVisualLock(btn) {
      if (!btn) return;

      if (btn.dataset.adLocked === "1") {
        btn.disabled = false;
        btn.style.pointerEvents = "auto";
        btn.style.opacity = "1";
        btn.style.filter = "";
        if (btn.dataset.origText) btn.textContent = btn.dataset.origText;
        delete btn.dataset.adLocked;
      }
    }

    // Çekirdek kilit: tıklansa bile çalışmasın
    function hookAdFunction() {
      if (typeof window.watchAdBoost === "function" && !window.watchAdBoost.__HARD_LOCKED) {
        const original = window.watchAdBoost;
        window.watchAdBoost = function () {
          // Kilit aktifse asla çalıştırma
          if (isLockedForThisMining() || shouldLockNow()) return;
          return original.apply(this, arguments);
        };
        window.watchAdBoost.__HARD_LOCKED = true;
      }
    }

    // Render sonrası tekrar basılınca bile butonu kilitle
    function enforce() {
      const end = miningEndTime();
      if (!end) return;

      // Son 30 saniyeye girildiyse bir kez kilidi yak
      if (shouldLockNow()) setLockedForThisMining();

      const btn = findAdButton();
      if (!btn) return;

      if (isLockedForThisMining()) applyVisualLock(btn);
      else removeVisualLock(btn);
    }

    // DOM değişince (render) tekrar uygula
    const obs = new MutationObserver(() => {
      hookAdFunction();
      enforce();
    });

    obs.observe(document.documentElement, { childList: true, subtree: true });

    // İlk çalıştırma
    hookAdFunction();
    enforce();
    
    // Sadece son 1 dakikada 500ms interval aç (performans için)
    let lockInterval = null;
    setInterval(() => {
      const end = miningEndTime();
      if (!end) return;
      
      const timeLeft = end - Date.now();
      const oneMinute = 60 * 1000;
      
      // Son 1 dakikaya girildiğinde
      if (timeLeft > 0 && timeLeft <= oneMinute && !lockInterval) {
        console.log('🔒 Ad lock active - last minute protection');
        lockInterval = setInterval(() => {
          hookAdFunction();
          enforce();
        }, 1000);
      }
      
      // Mining bittiyse interval'ı temizle
      if (timeLeft <= 0 && lockInterval) {
        clearInterval(lockInterval);
        lockInterval = null;
        console.log('🔓 Ad lock released');
      }
    }, 5000); // Her 5 saniyede kontrol yeterli

  } catch (e) {
    console.warn("Perma ad lock failed", e);
  }
})();


        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.add('show');
        }
        
        function closeForgotPassword() {
    clearForgotError();
            document.getElementById('forgotPasswordModal').classList.remove('show');
            document.getElementById('forgotEmail').value = '';
        }
        
        
function showForgotStatus(msg, type){
  const b = document.getElementById('forgotError');
  if(!b) return;
  b.innerText = msg;
  b.style.display = 'block';
  if(type === 'success') b.className = 'success-msg';
  else if(type === 'info') b.className = 'info-msg';
  else b.className = 'error-msg';
}
function showForgotError(msg){ showForgotStatus(msg, 'error'); }
function showForgotInfo(msg){ showForgotStatus(msg, 'info'); }
function showForgotSuccess(msg){ showForgotStatus(msg, 'success'); }
function clearForgotError(){
  const b = document.getElementById('forgotError');
  if(!b) return;
  b.innerText = '';
  b.style.display = 'none';
  b.className = 'error-msg';
}

async function sendPasswordReset() {
            const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            
            if (!email) {
                showForgotError('Please enter your email');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showForgotError('Invalid email format');
                return;
            }
            
            try {
                showForgotInfo("Waiting for server response..");

                const response = await fetch(API_ENDPOINTS.sendPasswordReset, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                // DEBUG: Log backend response
                console.log('🔍 Password reset response:', {
                    status: response.status,
                    ok: response.ok,
                    data: data
                });
                
                if (response.ok) {
                    showForgotSuccess(data.message || "Reset link sent. Check your email.");
                    // Keep success message visible briefly, then proceed
                    setTimeout(() => {
                        closeForgotPassword();
                        window.__resetEmail = email;
                        const box = document.getElementById('resetWithCodeBox');
                        if (box) box.style.display = 'flex';
                    }, 1000);
                } else {
                    console.error('❌ Password reset failed:', data);
                    showForgotError(data.error || 'Email not found');
                }
            } catch (error) {
                console.error('❌ Password reset error:', error);
                showForgotError('Failed to send reset link');
            }
        }

        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/><line x1="4" y1="4" x2="20" y2="20"/></svg>';
            } else {
                input.type = 'password';
                button.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
            }
        }
    </script>

<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h2 style="color: white; font-size: 22px; font-weight: 900; margin-bottom: 20px; text-align: center;">Reset Password</h2>
        <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px; text-align: center;">Enter your email address and we'll send you a password reset link.</p>
        <div class="form-group">
            <div id="forgotError" class="error-msg" style="display:none;"></div>
        <input type="email" class="form-input" id="forgotEmail" placeholder="Enter your email" style="margin-bottom: 20px;">
        </div>
        <button class="btn btn-primary" onclick="sendPasswordReset()" style="width: 100%; margin-bottom: 12px;">Send Reset Link</button>
        <button class="btn" onclick="closeForgotPassword()" style="width: 100%; background: rgba(100, 100, 100, 0.2); border: 1px solid rgba(150, 150, 150, 0.3);">Cancel</button>
    </div>
</div>

<!-- Offline Page -->
<div id="offlinePage" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0a1428 0%, #1a2a4a 100%); z-index: 99999; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
    <div style="text-align: center;">
        <!-- Logo -->
        <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #00ffff, #0ea5e9); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(0, 255, 255, 0.3);">
            <span style="font-size: 60px; font-weight: 900; color: #0a1428;">A</span>
        </div>
        
        <!-- Title -->
        <h1 style="color: white; font-size: 28px; font-weight: 900; margin-bottom: 12px;">No Internet Connection</h1>
        
        <!-- Message -->
        <p style="color: rgba(255, 255, 255, 0.7); font-size: 16px; margin-bottom: 30px; line-height: 1.6;">Please check your internet connection<br>and try again</p>
        
        <!-- Retry Button -->
        <button onclick="location.reload()" style="background: linear-gradient(135deg, #00ffff, #0ea5e9); color: #0a1428; border: none; padding: 14px 40px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 16px rgba(0, 255, 255, 0.3); transition: all 0.3s;">
            Retry Connection
        </button>
        
        <!-- Icon -->
        <div style="margin-top: 40px; opacity: 0.3;">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
        </div>
    </div>
</div>

<script>
// Show offline page when no connection
function checkConnection() {
    if (!navigator.onLine) {
        document.getElementById('offlinePage').style.display = 'flex';
    } else {
        document.getElementById('offlinePage').style.display = 'none';
    }
}

// ONLY check on actual connection changes (not on page load)
window.addEventListener('online', checkConnection);
window.addEventListener('offline', checkConnection);
</script>


<script>
async function __doConfirmReset(){

  if(!window.__resetEmail){
    if (typeof showToast === 'function') showToast('❌ Reset email missing', true);
    else alert('Reset email missing');
    return;
  }

  const email = (window.__resetEmail || (document.getElementById('forgotEmail')||{}).value || "").trim().toLowerCase();
  const code = (document.getElementById('resetCode')||{}).value?.trim();
  const newPassword = (document.getElementById('resetNewPassword')||{}).value || "";

  
  if(!code || !newPassword){
    if (typeof showToast === 'function') showToast('❌ Fill all fields', true);
    else alert('Fill all fields');
    return;
  }


  try{
    const res = await fetch(API_ENDPOINTS.resetPasswordWithCode, {
      method: 'POST',
      headers: getApiHeaders(),
      body: JSON.stringify({ email: window.__resetEmail, code, newPassword })
    });
    let data = {};
    try { data = await res.json(); } catch(_) {}

    if(res.ok){
      if (typeof showToast === 'function') showToast('✓ Password reset successful');
      else alert('Password reset successful');
      const box = document.getElementById('resetWithCodeBox');
      if (box) box.style.display = 'none';
      const c = document.getElementById('resetCode'); if (c) c.value = '';
      const p = document.getElementById('resetNewPassword'); if (p) p.value = '';
    } else {
      const msg = (data && data.error) ? data.error : 'Reset failed';
      if (typeof showToast === 'function') showToast('❌ ' + msg, true);
      else alert(msg);
    }
  } catch(e){
    if (typeof showToast === 'function') showToast('❌ Reset failed', true);
    else alert('Reset failed');
  }
}
window.__doConfirmReset = __doConfirmReset;
</script>


<!--  (LOGIN ONLY) -->
<div id="loadingScreen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0a1428 0%, #1a2a4a 100%);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 99999;
    gap: 20px;
">
    <div style="
        width: 60px;
        height: 60px;
        border: 4px solid rgba(0, 255, 255, 0.2);
        border-top-color: #00ffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    "></div>
    <div style="
        color: #00ffff;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
    ">Loading…</div>
</div>





<script>
(function () {
  const srcWrap = document.getElementById('fixedBalanceIcon');
  if (!srcWrap) return;

  const icon = srcWrap.firstElementChild;
  if (!icon) return;

  const inject = () => {
    if (slot && !slot.querySelector('.balance-icon')) {
      slot.appendChild(icon.cloneNode(true));
    }
  };

  inject();

  const observer = new MutationObserver(() => inject());
  observer.observe(document.getElementById('app'), {
    childList: true,
    subtree: true
  });
})();
</script>


<script>
/* === SAFE LEADERBOARD PRELOAD (NO UI BLOCK, NO ERROR) === */
(function () {
  try {
    if (window.__leaderboardPreloaded) return;
    window.__leaderboardPreloaded = true;

    window.addEventListener('load', function () {
      setTimeout(function () {
        try {
          if (typeof getLeaderboardPageContent === 'function') {
            // silent preload to fill cache
            getLeaderboardPageContent();
          }
        } catch (e) {
          console.log('Leaderboard preload skipped');
        }
      }, 1000);
    });
  } catch (e) {}
})();
</script>

</body>
</html>


<!-- ================= STYLED RESET PASSWORD MODAL (FINAL) ================= -->
<style>
  #resetWithCodeBox{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(5,10,25,.75);
    backdrop-filter: blur(6px);
    z-index:2147483647;
    align-items:center;
    justify-content:center;
  }
  .reset-card{
    width:92%;
    max-width:420px;
    background:linear-gradient(180deg,#0e1630,#0a1024);
    border:1px solid rgba(0,212,255,.25);
    border-radius:18px;
    padding:26px 24px 28px;
    box-shadow:0 20px 60px rgba(0,0,0,.6);
    color:#e5f6ff;
    font-family:inherit;
  }
  .reset-card h3{
    margin:0 0 6px;
    font-size:22px;
    text-align:center;
    letter-spacing:.3px;
  }
  .reset-card p{
    margin:0 0 18px;
    text-align:center;
    font-size:13px;
    color:#9fdcff;
  }
  .reset-field{
    width:100%;
    background:#0b1228;
    border:1px solid rgba(0,212,255,.25);
    border-radius:12px;
    padding:14px 14px;
    margin-bottom:14px;
    color:#eaffff;
    outline:none;
  }
  .reset-field:focus{
    border-color:#00d4ff;
    box-shadow:0 0 0 2px rgba(0,212,255,.2);
  }
  .reset-btn{
    width:100%;
    padding:14px;
    border:none;
    border-radius:14px;
    background:linear-gradient(90deg,#00d4ff,#4f9cff);
    color:#001018;
    font-weight:700;
    letter-spacing:.4px;
    cursor:pointer;
    transition:transform .08s ease, box-shadow .08s ease, opacity .08s ease;
  }
  .reset-btn:hover{
    transform:translateY(-1px);
    box-shadow:0 8px 22px rgba(0,212,255,.35);
  }
  .reset-close{
    position:absolute;
    top:16px;
    right:18px;
    font-size:20px;
    color:#7ddfff;
    cursor:pointer;
  }

  .reset-status{
    margin-top:12px;
    padding:10px 12px;
    border-radius:12px;
    font-size:13px;
    font-weight:700;
    line-height:1.35;
    text-align:center;
    border:1px solid rgba(0,255,255,0.25);
    background:rgba(0,0,0,0.35);
    color:#e5f6ff;
  }
  .reset-status.waiting{
    border-color: rgba(56,189,248,0.45);
    background: rgba(14,165,233,0.12);
    color:#bae6fd;
  }
  .reset-status.ok{
    border-color: rgba(34,197,94,0.55);
    background: rgba(34,197,94,0.12);
    color:#bbf7d0;
  }
  .reset-status.err{
    border-color: rgba(239,68,68,0.55);
    background: rgba(239,68,68,0.12);
    color:#fecaca;
  }

        .days-badge {
            min-width: 9ch;
            max-width: 9ch;
            text-align: center;
            white-space: nowrap;
            font-size: 10px;
            font-weight: 700;
            line-height: 1;
        }
        
/* === PRO LOADING SCREEN === */
#loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}

.loading-card {
    background: rgba(10,20,40,0.85);
    border-radius: 24px;
    padding: 40px 32px;
    border: 2px solid transparent;
    background:
      linear-gradient(rgba(10,20,40,0.85), rgba(10,20,40,0.85)) padding-box,
      linear-gradient(145deg, rgba(0,255,255,0.4), rgba(123,67,255,0.4)) border-box;
    box-shadow: 0 0 40px rgba(0,255,255,0.25);
    text-align: center;
}

.loading-spinner {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 4px solid rgba(0,255,255,0.15);
    border-top-color: #00ffff;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

.loading-text {
    color: #c4b5fd;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
}


/* === AUTH LOGO & SPLASH FIX (MOBILE SAFE) === */
.auth-logo {
  width: 140px;
  height: 140px;
  margin: 0 auto 24px auto;
  background-image: url('assets/auth-logo.webp');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.auth-splash {
  width: 100%;
  height: 220px;
  background-image: url('assets/splash-image.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 20px;
}


/* === BALANCE ICON FINAL FIX === */
.balance-icon {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  border: 0.3px solid #00d9ff;
  border-radius: 4px;
  padding: 2px;
  margin: 4px 0;
  display: inline-block;
}

</style>
        

<div id="resetWithCodeBox">
  <div class="reset-card">
    <div class="reset-close" onclick="document.getElementById('resetWithCodeBox').style.display='none'">✕</div>
    <h3>Reset Password</h3>
    <p>Enter the 6-digit code sent to your email</p>
      <div id="resetStatusMsg" class="reset-status" style="display:none;"></div>
    <form id="resetForm">
      <input id="resetCode" class="reset-field" placeholder="6-digit code" inputmode="numeric" autocomplete="one-time-code" />
      <input id="resetNewPassword" class="reset-field" type="password" placeholder="New password" />
      <button class="reset-btn" id="confirmResetBtn" type="button"  onclick="window.handleResetWithCode && window.handleResetWithCode()">Confirm Reset</button>
    </form>
  </div>
</div>

<script>
(function(){
  // Keep reset email even if the "Forgot password" modal gets closed/cleared
  window.__resetEmail = window.__resetEmail || "";

  const orig = window.sendPasswordReset;
  if (typeof orig === 'function') {
    
// resetWithCodeBox auto-open disabled


  async function handleResetWithCode(){

const email = (window.__resetEmail || (document.getElementById('forgotEmail')||{}).value || "").trim().toLowerCase();
const code  = (document.getElementById('resetCode')||{}).value?.trim();
const newPassword = (document.getElementById('resetNewPassword')||{}).value || "";

const box = document.getElementById('resetWithCodeBox');
const statusEl = document.getElementById('resetStatusMsg');

const setStatus = (msg, kind) => {
  if (!statusEl) return;
  statusEl.style.display = 'block';
  statusEl.className = 'reset-status' + (kind ? (' ' + kind) : '');
  statusEl.textContent = msg;
};

const clearStatus = () => {
  if (!statusEl) return;
  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'reset-status';
};

if (!email || !code || !newPassword) {
  setStatus('❌ Fill all fields', 'err');
  return;
}

const btn = document.getElementById('confirmResetBtn');
const origText = btn ? btn.textContent : '';
if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }

// Immediately show waiting message INSIDE modal (backend-independent)
setStatus('⏳ Waiting for server response..', 'waiting');

let closeTimer = null;
const closeModalAfter = (ms) => {
  if (closeTimer) clearTimeout(closeTimer);
  closeTimer = setTimeout(() => {
    if (box) box.style.display = 'none';
    clearStatus();
    // Reset button state even if modal closes
    if (btn) { btn.disabled = false; btn.textContent = origText || 'Confirm Reset'; }
  }, ms);
};

try {
  const res = await fetch(API_ENDPOINTS.resetPasswordWithCode, {
    method: 'POST',
    headers: getApiHeaders(),
    body: JSON.stringify({ email: window.__resetEmail, code, newPassword })
  });

  let data = {};
  try { data = await res.json(); } catch(_) {}

  if (res.ok) {
    setStatus('✓ Password reset successful', 'ok');

    // Clear fields on success
    const c = document.getElementById('resetCode');
    const p = document.getElementById('resetNewPassword');
    if (c) c.value = '';
    if (p) p.value = '';

    // Show message for 1 second, then close modal
    closeModalAfter(1000);
  } else {
    const msg = (data && (data.error || data.message)) ? (data.error || data.message) : 'Invalid code';
    setStatus(`❌ ${msg}`, 'err');

    // Show message for 1 second, then close modal
    closeModalAfter(1000);
  }
} catch (err) {
  setStatus('❌ Reset failed', 'err');
  closeModalAfter(1000);
} finally {
  // If close timer is set, button will be restored when modal closes.
  if (!closeTimer) {
    if (btn) { btn.disabled = false; btn.textContent = origText || 'Confirm Reset'; }
  }
}
}

  // Expose for reliable button handling
  window.handleResetWithCode = handleResetWithCode;
  // Robust delegated handler (prevents 'button does nothing' if binding missed)
  function delegatedResetHandler(e){
    const t = e && e.target;
    if (t && t.id === 'confirmResetBtn') {
      e.preventDefault();
      e.stopPropagation();
      if (typeof window.handleResetWithCode === 'function') window.handleResetWithCode();
    }
  }
  if (!document.documentElement.dataset.delegatedResetHandler) {
    document.documentElement.dataset.delegatedResetHandler = '1';
    document.addEventListener('click', delegatedResetHandler, true);
    document.addEventListener('touchstart', delegatedResetHandler, true);
  }



  
  function bindResetHandlers(){
    const btn = document.getElementById('confirmResetBtn');
    if (btn && !btn.dataset.bound) {
      btn.dataset.bound = '1';

      const fire = (e) => {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        handleResetWithCode();
      };

      btn.addEventListener('click', fire, { passive: false });
      btn.addEventListener('touchstart', fire, { passive: false });
    }

    const form = document.getElementById('resetForm');
    if (form && !form.dataset.bound) {
      form.dataset.bound = '1';
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        handleResetWithCode();
      }, { passive: false });
    }
  }

  document.addEventListener('DOMContentLoaded', bindResetHandlers);
  bindResetHandlers();
  }
})();

        


        
        function showLoading(message) {
            const existing = document.getElementById('loadingOverlay');
            if (existing) existing.remove();
            
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 99999;';
            overlay.innerHTML = '<div style="background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; text-align: center;"><div style="font-size: 40px; margin-bottom: 15px;">⏳</div><div style="color: white; font-size: 18px; font-weight: 700;">' + message + '</div></div>';
            document.body.appendChild(overlay);
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        async function claimAllAirdrops() {
            // ⚡ DOUBLE-CLICK PROTECTION - Return silently if already claiming
            if (isClaimingAirdrop) {
                return;
            }
            
            // Lock immediately to prevent double-clicks
            isClaimingAirdrop = true;
            
            const userId = currentUser.userId;
            
            // ⚡ STEP 1: Get airdrop amount from DOM BEFORE backend call
            const totalAmountElement = document.querySelector('div[style*="font-size: 36px"]');
            let estimatedAmount = 0;
            if (totalAmountElement) {
                const amountText = totalAmountElement.textContent.trim().split(' ')[0];
                estimatedAmount = parseFloat(amountText) || 0;
            }
            
            // If no amount found, check backend first
            if (estimatedAmount === 0) {
                showToast('No airdrops to claim', true);
                isClaimingAirdrop = false;
                return;
            }
            
            // ⚡ STEP 2: OPTIMISTIC UI - Update immediately (0ms delay!)
            const oldBalance = currentUser.balance;
            currentUser.balance += estimatedAmount;
            d.balance = currentUser.balance;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // ⚡ STEP 3: Hide claim button INSTANTLY from DOM
            const claimButton = document.querySelector('button[onclick="claimAllAirdrops()"]');
            if (claimButton) {
                const container = claimButton.closest('div[style*="background: linear-gradient"]');
                if (container) {
                    container.style.transition = 'opacity 0.2s ease';
                    container.style.opacity = '0';
                    setTimeout(() => {
                        container.style.display = 'none';
                    }, 200);
                }
            }
            
            // ⚡ STEP 4: Update balance display instantly
            render();
            
            // ⚡ STEP 5: Show success message immediately
            showToast('✓ Claimed ' + estimatedAmount.toFixed(2) + ' ARCASTRA!');
            
            // ⚡ STEP 6: Backend call in background (async, non-blocking)
            (async () => {
                try {
                    const response = await fetch(API_ENDPOINTS.claimAirdrops, {
                        method: 'POST',
                        headers: getApiHeaders(),
                        body: JSON.stringify({ userId: userId })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Backend confirmed - use exact amount from backend
                        if (data.totalClaimed !== estimatedAmount) {
                            // Adjust if there was a discrepancy
                            const difference = data.totalClaimed - estimatedAmount;
                            currentUser.balance += difference;
                            d.balance = currentUser.balance;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            render();
                            console.log('✅ Adjusted balance by', difference);
                        }
                        
                        console.log('✅ Backend confirmed claim:', data.totalClaimed);
                        
                        // Clear airdrops cache
                        window.cachedAirdrops = [];
                        window.cachedTotalAirdropAmount = 0;
                        
                        // Update menu notification (remove green border)
                        await checkNotifications();
                        
                        // Reload page to show "No Airdrops" message
                        const pageContent = document.getElementById('fullPageContent');
                        if (pageContent) {
                            const html = await getAirdropPageContent();
                            pageContent.innerHTML = html;
                        }
                    } else {
                        // Backend failed - rollback
                        console.error('❌ Backend claim failed:', data);
                        currentUser.balance = oldBalance;
                        d.balance = oldBalance;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        render();
                        
                        // Show the button again
                        if (claimButton) {
                            const container = claimButton.closest('div[style*="background: linear-gradient"]');
                            if (container) {
                                container.style.display = 'block';
                                container.style.opacity = '1';
                            }
                        }
                        
                        showToast('❌ Failed to claim airdrops. Please try again.', true);
                    }
                    
                } catch (error) {
                    // Network error - rollback
                    console.error('❌ Network error:', error);
                    currentUser.balance = oldBalance;
                    d.balance = oldBalance;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    render();
                    
                    // Show the button again
                    if (claimButton) {
                        const container = claimButton.closest('div[style*="background: linear-gradient"]');
                        if (container) {
                            container.style.display = 'block';
                            container.style.opacity = '1';
                        }
                    }
                    
                    showToast('❌ Network error. Please try again.', true);
                } finally {
                    isClaimingAirdrop = false;
                }
            })();
        }

</script>
